/\def\pmt#1{\hbox{\tt[#1]}}


\chapter[al]{Alignment of Roman Pots}

MOTIVATION: An accurate alignment is of major importance for the TOTEM experiment in order to deliver precise measurements. Among the subdetectors of TOTEM, the alignment of the RPs presents the biggest challenge since they are movable. The importance of alignment is most pronounced at the $\be^* = 1535\un{m}$ optics, where the beam divergence (the dominant smearing effect) is rather low and hence the impact of any misalignment has a large relevance. To give a feeling, a $100\un{\mu m}$ displacement of a vertical RP would lead to angular shift of about $0.4\un{\mu rad}$ (based on an effective length $L_y\approx 270\un{m}$, typical for this optics). This is to be compared to the spread of the beam divergence $0.3\un{\mu rad}$.

\TODO{experience from other experiments}

WHAT WE ALIGN, WRT WHAT:
What is important is the relative position between RP sensors (the other parts do not matter much) and the beam. Hence there are two players in the game -- RP positions and beam positions.

Coordinate system such that the beam is at x=y=0

\section[al proc]{Alignment procedure}
The procedure has two steps. First, move the pots to the desired position as precisely as possible. Then take data, analyze them and find what error has been done in the first step.

The first step relies mainly on two types devices -- RP motor control and Beam Position Monitors (BPMs). Both are calibrated to determine position of outer edge of the window or the beam with respect to the ideal beam-pipe center.

For the second step, a number of methods is available. Undoubtedly, one of the most powerful ones is the track-based alignment. It uses the tracks passing through the overlap between vertical and horizontal RPs and is, hence, capable of determining the relative position between the pots. Its strength is underlined by the fact that it is based on a single assumption: tracks are straight lines. To determine the position of the beam, other methods must be used. One may profit from know symmetries of certain physics processes. Here, the analysis becomes delicate because in the observables the properties of the processes are mixed with the properties of the optics. This gives a certain superiority to elastic scattering. This process is often easy to separate and hence can provide a clean sample, as the first argument. As the second one, it comprises two protons exactly in the opposite direction and can thus be used for the alignment of the opposite arms of the experiment. Yet another advantage the protons have, by definition, zero momentum-loss and therefore, the dependence on the optics is largely reduced.

Reference to \Sc{al exp misal}.
As it follows from \Sc{rp measurement}, only the rotation around $z$ axis is relevant.

\section[al exp misal]{Expected misalignments}

Let's first asses what may go wrong and what are the corresponding misalignment estimates.

\noindent\em{Internal misalignments} arise from finite precision of fixing the detectors within a package. The precision is estimated to be
\eqref{20\un{\mu m}\ .}{internal misalignment shift}
This also gives estimate about the rotation
\eqref{\De\rh \approx {2\cdot 20\un{\mu m}\over 4\un{cm}} = 1\un{mrad}\ .}{internal misalignment rotation}

\noindent\em{Errors in RP positions}
\> z shifts
\> errors in RP motor control $~20\un{\mu m}$
\> RP frame deformation ???

\noindent\em{Errors in optical functions} are also sort of misalignments -- global alignment

\htab{expected misalignments}{Expected misalignments orders. \TODO{}}{\bln
	& \hbox{within RP package} & \hbox{Roman Pot} \cr\bln
\hbox{transverse shift} \un{\mu m}& & \cr\ln
\hbox{shift in }z & & \cr\ln
\hbox{rotation around }z & & \cr\bln
}

\section[al collim]{Collimation alignment}

PUT THIS TO INTRODUCTION? In principle both \abb{BPM}s and \abb{RP} motor controls should have been calibrated such that they give the position of beam/RP edge with respect to the beam-pipe center. However, a cross-check is always good. Moreover, this exercise was needed for the alignment against the system of the LHC collimators.

In the beginning, the collimators scrape the beam such that its edge is sharp and its size and center is well defined. Then a RP is approached to the beam, until it touches the sharp edge. In this moment, particles from the beam edge are scattered off the RP edge and they give raise to peaks in the BLMs downstream (see \Fg{al collim ex} bottom). In this moment, the RP edge is at the same beam-sigma-distance as the collimators.

With the vertical RPs we can make use of the fact that we have two jaws and determine the beam-sigma (in millimeters) and the beam-center. Suppose that we have touched the beam with the top RP. In that moment, the RP became the primary collimator and scraped the beam a bit. Due to the multi-turn effect, the beam was scraped symmetrically about the vertical center of the beam. Then, one can approach the bottom pot, again until a BLM peak appears. Then, both RPs are at the same distance from the vertical beam-center and the distance corresponds to one beam-sigma (up to the step-size, indeed). These steps can be repeated in order to improve the precision of the beam-center determination. An example of this procedure can be found in \Fg{al collim ex}.

\fig{fig/pdf/al_collim_ex.pdf}{al collim ex}{An example of collimation alignment data from 29 November 2009 (56-220-near unit). The top and bottom pot movements (upper plot) induced the BLM signals (bottom plot). The time is in minutes from the start of the test.}

The precision is obviously given by the step size. Mostly because of the limited time resolution one cannot determine when during the movement the beam was touched. One should, thus, aim at as little steps as possible. On the other hand, the smaller step, the less scraping and the lower peak in the BLM signal. If the step is too small, the induced beam loss can not be distinguished from the noise. We observed a step of $50\un{\mu m}$ to be on the practical limit.

So far, the collimation alignment has been repeated three times: 29 November 2009, 25 June 2010 (both at $450\un{GeV}$) and 21 September 2010 at $3.5\un{TeV}$. The results suggest an unfortunate conclusion -- both RP LVDTs and BPMs seemed wrongly calibrated. For an immediate indication, let's look back to \Fg{al collim ex}. Assuming the beam was touched in the middle of the movement, one obtains the beam center at $(313\pm 63)\un{\mu m}$ according to the LVDTs. However, the corresponding BPM claimed the beam to be at $(-550\pm50)\un{\mu m}$. The discrepancy is evident, what is not clear is, however, which device to blame.

Very soon it became clear that the BPMs very not reliable at that time. A quite typical BPM curves are plotted in \Fg{al collim bpm problem}, note the huge drifts. It was confirmed by BPM experts that these devices suffered from temperature and intensity effects. These made the use of BPMs uninteresting for alignment purposes.

\fig{fig/pdf/al_collim_bpm_problem.pdf}{al collim bpm problem}{The readings from sector 56 BPMs from 25 June 2010. Very pronounced drifts are evident.}

Another valuable hint was provided later by the track-based alignment method (\Sc{al tb}). The results contained large per-RP shifts (i.e. all sensors from a pot indicated the same shift), moreover almost run-independent. This suggested that the LVDT scales did not have a common origin, in other words, every LVDT reading should be corrected by an offset. 

These offsets can be determined with the collimation alignment -- the principle is shown in \Fg{al collim}. The beam size at the collimator location ($n\si_0$) is known and can be propagated to the RP location, thus $n\si$ is known too. $t$ and $b$ are the top and bottom LVDT readings. The offsets then follow:
\eqref{o_t = n\si - t,\qquad o_b = -n\si - b\ .}{LVDT offsets}
Note that the offsets are determined with respect to the beam center (not the beam-pipe center), which is, in fact, exactly what we need. The measurements were performed on 21 Sep, the results were published in \bref{al collim} (Tb.~1). The calculated offsets can be found in \Tb{al lvdt off}. The error is dominated by the touching-point determination. Taking a half of the step size yields an error of $\approx 100\un{\mu m}$.

\fig{fig/pdf/al_collim.pdf}{al collim}{How to determine LVDT offsets with collimation alignment. The beam is drawn in blue, its envelope with solid and its center with dash-dotted line. The origins of the LVDT scales are marked with red dots.}

\htab{al lvdt off}{The LVDT offsets (values in $\un{mm}$). Positive/negative value means shift up/down (like in \Fg{al collim}).}{\bln
\hbox{unit} & o_t & o_b \cr\bln
\hbox{45-220-near} & +0.515 & +0.135\cr\ln
\hbox{45-220-far} & +0.389 & +0.111\cr\bln
\hbox{56-220-near} & -1.254 & -0.286\cr\ln
\hbox{56-220-far} & +0.262 & -0.162\cr\bln
}

In this way, we've determined the vertical positions of the thin windows (the RP parts that face the beam, see \Sc{rp system}). The package with silicon sensors is inserted into the RP with a limited precision, which has even deteriorated by \TODO{the short-circuit incident}. Regarding the thin-window-to-sensor-edge distance, this may bring another $100\un{\mu m}$ of uncertainty. Thus, altogether, the vertical position of the sensors in the vertical pots is determined with a precision of $\approx 150\un{\mu m}$.

\section[al tb]{Track--based alignment}

\TODO{few notes about the implementation in OfflineSW}

In \Sc{rp measurement}, the relation between a proton kinematics and RP detector measurement has been derived -- see \Eq{xlyl i approximated}. In principle, all geometry parameters (the situation is depicted in \Fg{detector geometry}) may be subjects to misalignments. Using primes (no primes) for misaligned (ideal) quantities, this might be described as
\eqref{\eqnarray{
z' &=& z + \De z\cr
\vec c' &=& \vec c + \De\vec c\cr
}}{misalignment definition}
(The z component of the $\vec c$ vector will be denoted simply as $z$ from now on, while $\vec c$ will refer to the two-component vector $(c_x, c_y)^\T$). The $\rh_z$ already refers to misalignment. In this regard, we will change the notation
\eqref{\rh_z \rightarrow \De\rh}{misalignment definition 2}
(the $z$ subscript will be dropped as it is the only rotation in our picture from now on).

With the new notation, one can write
\eqref{
\vec d^\T \pmatrix{1 & \De\rh\cr -\De\rh & 1} =
\vec d + \De\rh \underbrace{\pmatrix{-d_y\cr d_x}}_{\vec d_\perp}\ .
}{d perp definition}

\fig{fig/pdf/detector_geometry.pdf}{detector geometry}{The detector geometry. A sample hit is drawn as the blue dot, the corresponding measurement is visualized as the thick solid blue line.}

To summarize, the measurement of the $n$-th event in the $i$-th detector is
\eqref{
m_i^n = (\vec d_i + \De\rh_i\,\vec d_{\perp i})^\T \left[\vec a^n (z_i + \De z_i) + \vec b^n - (\vec c_i + \De\vec c_i)\right] + \De m_i^n\ ,
}{m i measurement}
where the last term includes the errors introduced by various approximations and by neglecting the ``rounding'' step. It will be treated as an error in what follows. One can rearrange the terms in the last equation
\eqref{\eqnarray{
\mu_i^n \equiv m_i^n - \vec d^\T \vec c = & &\cr
& +\vec d_i^\T (\vec a^n z_i + \vec b^n)&\qquad 10^{-2}\un{m}\cr
& -\vec d_i^\T \De\vec c_i&\qquad 10^{-5}\un{m}\cr
& +\vec d_i^\T \vec a^n \De z_i&\qquad 10^{-??}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i) &\qquad 10^{-5}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n \De z_i - \De\vec c_i) &\qquad 10^{-8}\un{m} \cr
}}{effective measurement}
The order estimates on the \rhs{} follow from \Tb{expected misalignments} and \Eq{z i order estimates}. It is clear that the last term can be neglected with respect to the others and hence we will do so. It is very advantageous since this is the only term non-linear in misalignments. 

The first term on the \rhs{} of \Eq{effective measurement} accounts for the measurement of a track by a perfectly aligned detector, the other terms then constitute alignment corrections. Since these corrections are linear in misalignments, one can write
\eqref{\mu_i^n =
\underbrace{\vec d_i^\T (\vec a^n z_i + \vec b^n)}_{\hbox{track}}
+
\underbrace{\sum_j \ga_{j, i}^n \ch_{j, i}}_{\hbox{alignment corrections}}
\ ,}{effective measurement 2}
introducing symbol $\ch_{j, i}$ for any misalignment. The mapping between the index $j$ and misalignment type can be found in \Tb{alignment quantities}. It will become useful to define shift in read-out direction as
\eqref{\De s_i \equiv \vec d_i \cdot \De c_i\ .}{al shr def}

\htab{alignment quantities}{Alignment quantities and their coefficients.}{\bln
j & \hbox{quantity} & \ch_{j, i}					& \ga_{j, i}^n\cr\bln
1 & \hbox{shift in read-out direction} & \De s_i 	& -1\cr\ln
2 & \hbox{shift in }z & \De z_i						& \vec d_i^\T \vec a^n  \cr\ln
3 & \hbox{rotation around}z & \De\rh_i				& \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i)\cr\bln
}

\Eq{effective measurement 2} can be written for all events in a compact form using matrix formalism. Let's put all measurements to a vector
\eqref{\vec M = (\mu^1_1 \ldots, \mu^2_1, \ldots)^\T\ .}{vector M}
The vector of parameters $\vec P$ has two parts, first the track parameters for all events, second the alignment parameters for all detectors
\eqref{\vec P = (a_x^1, a_y^1, b_x^1, b_y^1, a_x^2, \ldots || \ch_{1, 1}\ldots \ch_{1, D}, \ch_{2, 1}\dots \ch_{2, D}, \ldots)^\T}{vector P}
Then, \Eq{effective measurement 2} reads
\eqref{\vec M = \mat A \vec P\ ,}{effective measurement all}
where
\eqref{\mat A = \pmatrix{
\al^1 & 		&		&\vrule	&\Ga_1^1	&\cdots	&\Ga_G^1	\cr
	& \al^2	&		&\vrule	&\vdots		&		&\vdots		\cr
	&		& \ddots&\vrule	&\Ga_1^N	&\cdots	&\Ga_G^N	\cr
}}{mat A}
and
\eqref{\mat \al^n = \pmatrix{
\vdots & \vdots & \vdots & \vdots \cr
d_{ix} z_i & d_{iy} z_i & d_{ix} & d_{iy} \cr
\vdots & \vdots & \vdots & \vdots \cr
}, \quad \hbox{for all detectors involved in }n\hbox{-th event}}{mat alpha}
and
\eqref{\Ga_i^n = {\rm diag}\,\left(\ga_{i, 1}^n, \ldots, \ga_{i, D}^n \right)\ .}{mat Gamma}
\TODO{Gamma is of dimension Dn x D !!!}

\TODO{$N$ events, $D$ detectors, $D_n$ detectors active in $n$-th event, $G$ misalignment classes, $\vec\mu^n = (\mu^n_1, \ldots, \mu_{D_n}^n)^\T$}

\eqref{\vec\mu^n =
\underbrace{\mat\al^n \vec\ta}_{\hbox{track}}
+
\underbrace{\sum_j \mat\Ga_j^n \vec \ch_j}_{\hbox{misalignments}}
\ ,}{todo1}

\eqref{\vec P = (\vec\ta^1, \vec\ta^2, \ldots || \vec\ch_1, \vec\ch_2, \ldots)^\T}{todo2}



\subsection[al sim fit]{Simultaneous fit of track and alignment parameters}

This idea was first implemented in Millepede (see \bref{millepede}). Here we use different notation as this work as been done independently.

Now we would like to estimate parameters $\vec P$ based on the measurements $\vec M$. For that, we will use the Least Squares method (see e.g. Sec.~6.6 in \bref{barlow}), which gives the following prescription:
\eqref{\hat\vec P = (\mat A^\T \mat V^{-1} \mat A)^{-1} \mat A^\T \mat V^{-1}\,\vec M\.}{P estimate exact}
(The hat in $\hat\vec P$ is to emphasize it is an estimate.) The $\mat V$ matrix, is the correlation matrix for the measurements $\vec M$.

The $\mat\Ga$ matrices (contained in $\mat A$ matrix) include track parameters which are unknown at the fit time. Instead, one can use track parameter estimates obtained via the model where all misalignments are neglected. This is basically using $\mat \al^n$ as fit matrix for data $\vec \mu^n$. Let's denote gamma and A matrices obtained in this way as $\tilde\mat\Ga$ and $\tilde\mat A$:
\eqref{\vec\ta \rightarrow \hat\vec\ta: \quad \mat\Ga \rightarrow \tilde\mat\Ga, \mat A \rightarrow \tilde\mat A}{tau linearization}
 One can then use
\eqref{\hat\vec P = (\tilde\mat A^\T \mat V^{-1} \tilde\mat A)^{-1} \tilde\mat A^\T \mat V^{-1}\,\vec M\ .}{P estimate}

The \rhs expression will be evaluated now bit by bit, keeping in mind one is mainly interested in the $\ch$ parameters (i.e. the bottom part of $\hat\vec P$ vector).
\eqref{\mat A^\T \mat V^{-1}\mat A = \pmatrix{
{\mat\al^1}^\T \mat V^{1^{-1}}\mat\al^1	&		&						&\vrule	&{\mat\al^1}^\T \mat V^{1^{-1}} \mat\Ga_1^1	&\cdots	&{\mat\al^1}^\T \mat V^{1^{-1}} \mat\Ga_G^1	\cr
					&\ddots	&						&\vrule	&\vdots					&		&\vdots					\cr
					&		&{\mat\al^N}^\T \mat V^{N^{-1}}\mat\al^N		&\vrule	&{\mat\al^N}^\T \mat V^{N^{-1}}\mat\Ga_1^N	&\cdots	&{\mat\al^N}^\T \mat V^{N^{-1}} \mat\Ga_G^N	\cr
\noalign{\hrule}
{\mat\Ga_1^1}^\T \mat V^{1^{-1}} \mat\al	&\cdots	&{\mat\Ga_1^N}^\T \mat V^{1^{-1}} \mat\al	&\vrule	&\sum_n {\Ga_1^n}^\T \mat V^{1^{-1}} \Ga_1^n	&\cdots	&\sum_n {\Ga_1^n}^\T \mat V^{1^{-1}} \Ga_G^n	\cr
\vdots				&		&\vdots					&\vrule	&\vdots					&		&\vdots					\cr
{\mat\Ga_G^1}^\T \mat V^{N^{-1}}\mat\al	&\cdots	&{\mat\Ga_G^N}^\T \mat V^{N^{-1}} \mat\al	&\vrule	&\sum_n {\Ga_G^n}^\T \mat V^{N^{-1}} \Ga_1^n	&\cdots	&\sum_n {\Ga_G^n}^\T \mat V^{N^{-1}}\Ga_G^n	\cr
}\ .}{mat ATA}
This matrix can be inverted (\TODO{provided ...}) with the use of the following identity for block matrices (taken from \bref{wikipedia} keyword \em{matrix inverse}): 
\eqref{\pmatrix{
\mat A	&\strut\vrule	&\mat B	\cr
\noalign{\hrule}
\mat C	&\strut\vrule	&\mat D\cr
}^{-1} = \pmatrix{
\ldots							&\strut\vrule	&\ldots\cr
\noalign{\hrule}
-\mat S^{-1}\mat C\mat A^{-1}	&\strut\vrule	& \mat S^{-1}\cr
},\qquad \mat S = \mat D - \mat C\mat A^{-1}\mat B\ .}{BlockInverse}
(The upper row was skipped as it will not be needed to estimate $\ch$ parameters.) After some algebra manipulations, matrix $\mat S$ can be written
\eqref{\tilde\mat S = \pmatrix{
\sum_n {\tilde\mat\Ga}_1^{n^\T} \mat\si^n {\tilde\mat\Ga}_1^n	&\cdots	&\sum_n {\tilde\mat\Ga}_1^{n^\T} \mat\si^n {\tilde\mat\Ga}_G^n	\cr
\vdots								&		&\vdots									\cr
\sum_n {\tilde\mat\Ga}_G^{n^\T} \mat\si^n {\tilde\mat\Ga}_1^n	&\cdots	&\sum_n {\tilde\mat\Ga}_G^{n^\T} \mat\si^n {\tilde\mat\Ga}_G^n	\cr
}\ ,}{mat S}
where we used
\eqref{\mat\si^n = \mat V^{n^{-1}} - \mat V^{n^{-1}} \mat\al^n({\mat\al^n}^\T \mat V^{n^{-1}} \mat\al^n)^{-1} \mat {\mat\al^n}^\T V^{n^{-1}}\ .}{sigma n}

The second bit needed for \Eq{P estimate} is
\eqref{\mat A^\T \mat V^{-1}\,\vec M = \pmatrix{
{\mat\al^1}^\T \mat V^{1^{-1}} \,\vec \mu^1\cr
\vdots\cr
{\mat\al^n}^\T \mat V^{N^{-1}} \,\vec \mu^N\strut\cr
\ln
\sum_n\mat{\Ga_1^n}^\T \mat V^{n^{-1}} \, \vec \mu^n\vrule width0pt height15pt\cr
\vdots\cr
\sum_n\mat{\Ga_G^n}^\T \mat V^{n^{-1}} \, \vec \mu^n\cr
}\ .}{vec ATm}
Finally, the $\ch$ parameters (the bottom part of $\hat\vec P$ vector) can be determined from
\eqref{\hat\vec\ch = \mat S^{-1}\,\pmatrix{
\sum_n {\mat\Ga_1^n}^\T\mat\,\mat\si^n\,\vec \mu^n\cr
\vdots\cr
\sum_n {\mat\Ga_G^n}^\T\mat\,\mat\si^n\,\vec \mu^n\cr
}\ .}{chi estimate}

In fact, the elements of $\mat\si^n\,\vec \mu^n$ vector are residuals for the $n$-track divided by the corresponding measurement uncertainty. We will call this ratio \em{normalized} residuals and denote $\vec r^n$. The full residuals will be denoted by $\vec R^n$:

\eqref{\mat\si^n\,\vec \mu^n \equiv \vec r^n = \mat V^{n^{-1}} \vec R^n\ .}{vec R}

It is worth mentioning some properties of the $\mat\si^n$ matrix. It is symmetric
\eqref{\mat\si^{n^\T} = \mat\si^n\ ,}{sigma n symmetric}
it is idempotent
\eqref{\mat\si^n \mat\si^n = \mat\si^n}{sigma n idempotent}
and it is singular
\eqref{\mat\si^{n^\T} \mat\al^n = 0\ .}{sigma n singular}

Since $\mat\si^n$ is singular (and so $\mat S$ might be \TODO{...}), one had better write
\eqref{\tilde \mat S\, \hat\vec\ch = \tilde \vec T, \qquad 
\tilde\vec T = \pmatrix{
\sum_n {\tilde\mat\Ga}_1^{n^\T} \,\vec r^n\cr
\vdots\cr
\sum_n {\tilde\mat\Ga}_G^{n^\T} \,\vec r^n\cr
}\ .}{fit equation}

\TODO{Overview of the approximations:
\> linearization of rotation matrix (and cosine correction)
\> linearization of gamma coefficients (external fitter)
}


\subsection[al fit eq]{Justification of the alignment equation}

As we will show in the following, the $\mat S$ matrix is singular and therefore the identity \Eq{BlockInverse} cannot be used. Thus, it is important to justify the validity of the final result \Eq{fit equation}. By plugging \Eq{vec R,todo1} to the definition of $\tilde\vec T$ in \Eq{fit equation} one obtains
\eqref{\tilde\vec T =
\pmatrix{
\vdots \cr
\sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \vec\mu^n\cr
\vdots \cr
}
=
\pmatrix{
\ddots & & \udots \cr
 & \sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \mat\Ga_i^n\cr
\udots & & \ddots \cr
}
\pmatrix{\vdots \cr {\vec\ch_{\rm a}}_i \cr \vdots}
=
\bar\mat S \vec\ch_{\rm a}
}{exact fit equation}
(the a subscript in $\vec\ch_{\rm a}$ is to emphasize the we mean the actual misalignments). This is close to \Eq{fit equation}, but not completely equivalent. The difference is that $\tilde\mat S$ contains both $\mat\Ga$ matrices with tildes. This difference represents the error we make by the linearization step \Eq{tau linearization}. Since the expected misalignments are small, the difference between $\mat\Ga$ and $\tilde\mat\Ga$ are small too and it is reasonable to expect that the solution of \Eq{fit equation} would be close to the actual misalignments $\vec\ch_a$. The error can be reduced by taking several iterations \TODO{...}. Note that this problem is not present if only shifts in the read-out direction are considered. The corresponding $\mat\Ga$ matrices are independent of track parameters and therefore there is no difference between tilded and non-tilded versions.

\subsection[al sing modes]{Singular and weak modes}

It is clear that not all $\ch$ parameters can be determined by the track-based alignment. It is a consequence of the fact that measurements enter the fit equation \Eq{fit equation} in the form of residuals. That means that misalignment modes that can be compensated by track-parameters variation, cannot be revealed. These misalignment modes manifest themselves as eigenvectors of the $\mat S$ matrix with zero eigenvalue. This makes $\mat S$ singular and the naive, matrix-inversion solution \Eq{chi estimate} is not possible. For this reason we will refer to such misalignment modes as \em{singular modes}.

\TODO{Define weak mode.}

\TODO{This is for the exact fit equation, for the real one, the singular modes are "almost" singular modes.}

Let's prove the statements above. Imagine that one could change misalignments $\vec\ch_j$ and track parameters $\vec\ta^n$ such that all measurments $\vec\mu^n$ in all events $n$ would remain unchanged. That is
\eqref{\vec\ch_j \rightarrow \vec\ch_j',\quad \vec\ta^n \rightarrow {\vec\ta'}^n(\vec\ta^n, \vec\ch_j, \vec\ch_j') : \quad \vec\mu^n \rightarrow {\vec\mu'}^n = \vec\mu^n\ .}{track-parameter compensation}
From \Eq{todo1} it follows
\eqref{\sum_j \mat\Ga_j^n (\vec\ch_j' - \vec\ch_j) = \mat \al^n (\vec\ta^n - {\vec\ta'}^n) }{aux1}
and thus
\eqref{
\mat S \pmatrix{\vdots\cr \vec\ch_i' - \vec\ch_i\cr\vdots} = 
\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \sum_j \Ga_j^n (\vec\ch_j' - \vec\ch_j) \cr\vdots} =
\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \mat \al^n (\vec\ta^n - {\vec\ta'}^n) \cr\vdots} = 0\ ,
}{equivalence singular mode track parameter variation}
which is a direct consequence of $\mat\si^n \al^n = 0$.

Now, let's explore what are the singular modes that we have to face. This will done it two steps -- first for an arbitrary detector geometry and second for the actual case of TOTEM Roman Pots, where only two read-out directions are used.

\TODO{there can be at most 4 singular modes per misalignment class. Prove it!}

\ssubsection[al sing modes gen]{Singular modes for any geometry}

In this section we will discuss what the singular modes are when no assumptions about the geometry are made. That will be performed for all misalignment classes as listed in \Tb{alignment quantities}.

\em{Shifts in readout direction}. Let's try to find a variation of track parameters $\vec a^n$ and $\vec b^n$ that would compensate shifts $\De\vec c_i$. That is
\eqref{\vec d_i \cdot (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n - \vec c_i)\ .}{cnst shr 1}
If this is fulfilled, such $\De\vec c_i$ configurations will be singular modes, for all values of ${\vec a'}^n$ and ${\vec b'}^n$ vectors. Explicitly:
\eqref{- \De s_i \equiv -\vec d_i \cdot \De\vec c_i = \vec d_i \cdot \left[ ({\vec a'}^n - \vec a^n) z_i + ({\vec b'}^n - \vec b^n) \right]\ .}{cnst shr 2}
Since the ${\vec a'}^n$ and ${\vec b'}^n$ vectors are two-dimensional, there four singular modes:
\eqref{\De s_i \propto z_i\cos\rh_i,\quad \De s_i \propto z_i\sin\rh_i,\quad \De s_i \propto \cos\rh_i,\quad \De s_i \propto \sin\rh_i\ .}{cnst shr 3}
\TODO{Like columns of complete $\mat\al$ matrix. 2 shifts and 2 shearings.}


\em{Shifts in $z$}. 
\eqref{\vec d_i \cdot \left[ \vec a^n (z_i + \De z_i) + \vec b^n \right] = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n)\ .}{cnst shz 1}
\eqref{\vec d_i \cdot \vec a^n \De z_i = \vec d_i \cdot (\De\vec a^n z_i + \De\vec b^n)\ .}{cnst shz 2}
This shall hold for every $\vec d_i$ and therefore one obtains
\eqref{\vec a^n \De z_i = \De\vec a^n z_i + \De\vec b^n\ .}{cnst shz 3}
Moreover, this must be obeyed for every value of $\vec a^n$, which is only possible if both $\De\vec a^n$ and $\De\vec b^n$ are proportional to $\vec a^n$. That means
\eqref{\De z_i = \al z_i + \be\ ,}{cnst shz 4}
where $\al$ and $\be$ are the proportionality constants. Thus there are two sinuglar modes (magnification and shift):
\eqref{\De z_i \propto z_i, \quad \De z_i \propto 1\ .}{cnst shz 5}

\em{Rotations around $z$}. We will use symbol $\mat R(\rh)$ for a rotation matrix around $z$ axis by angle $\rh$:
\eqref{\mat R(\rh) = \pmatrix{
\cos\rh & -\sin\rh \cr
\sin\rh & \cos\rh \cr
}\ .}{rotation matrix}
Again, let's search for track-parameter variations that could compensate a rotation. This time, we will include also transverse (read-out) misalignments as it will turn out that they are linked.
\eqref{[\mat R(\De\rh_i) \vec d_i]^\T (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i)\ .}{cnst rotz 1}
Since this must be fulfilled for all $\vec d_i$, one can write
\eqref{\mat R(\De\rh_i)^\T (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = {\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i\ .}{cnst rotz 2}
Comparing $n$-dependent quantities, one finds
\eqref{\mat R(\De\rh_i)^\T \vec a^n z_i = {\vec a'}^n}{cnst rotz 3}
(and similarly for $\vec b^n$). This can be guaranteed only provided $\De\rh_i$ is $i$-independent, that is constant. Then it is easy to find that
\eqref{\De\vec c'_i = \mat R(\De\rh) \De\vec c_i + [\mat R(\De\rh) - 1] \vec c_i\ .}{cnst rotz 4}
The second term reflects the fact that the singular mode is a uniform rotation around the $z$ axis, while alignment rotations (described by angles $\De\rh_i$) are performed around detector axes. These axes are parallel, but displaced by vectors $\vec c_i$.

Considering the misalignment expectations (see \Tb{expected misalignments}), it is reasonable to replace the rotation matrix by the first Taylor terms and also neglect terms containing the product of $\De\rh$ and $\De\vec c_i$. These simplifications yield
\eqref{\De\vec c'_i = \De\vec c_i + \De\rh \pmatrix{
- {c_y}_i\cr
{c_x}_i\cr
} + \O{\De\rh^2, \De\rh \De\vec c_i}}{cnst rotz 5}
or in terms of read-out shift $s_i$
\eqref{\De s'_i = \De s_i - \De\rho\, \de s_i + \O{\De\rh^2, \De\rh \De\vec c_i}, \qquad \de s_i = \vec d_{\perp i}\cdot\vec c_i\ .}{cnst rotz 6}
To summarize, we have just derived that transition from overall rotation $\De\rh$ and shifts $\De s_i$ to zero rotation and shifts $\De s_i'$ generates a singular mode. This is the only singular mode for rotations, but it also involves shifts. It can be schematically written as
\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} \propto \pmatrix{
1\cr
- \de s_i
}\ .}{cnst rotz 7}


\ssubsection[al sing modes groups]{Singular modes for few read-out directions}

In the previous section, we have used the fact that certain equalities shall hold for all read-out directions $\vec d_i$. However, the TOTEM detectors are designed such that the read-out directions are all parallel to either $U$ or $V$ axes (\TODO{make sure these are defined}). In this section we will show that such a geometry may increase the number of singular modes. We will consider a more general case, where the detectors split into groups according to their read-out direction:
\eqref{\vec \d_i \in \lbrace \pm\vec\de_1, \pm\vec\de_2, \ldots \rbrace \ ,\qquad |\vec\de_i \cdot \vec\de_j| \neq 1\hbox{ for } i \neq j\ .}{read-out groups}

For \em{shifts in read-out direction} the assumption of all direction has not been used and thus the result \Eq{cnst shr 3} remains valid also for these geometries.

For \em{shifts in $z$} one gets a copy of \Eq{cnst shz 2} for every group $g$:
\eqref{\vec\de_g \cdot \vec a^n \De z_i = \vec\de_g \cdot (\De\vec a^n z_i + \De\vec b^n)\ ,}{cnst shz g1}
valid, indeed, for detectors $i$ from the group $g$. (note the $\pm$ signs cancel). Since this shall hold for all $\vec a^n$, the ratio $\vec\de_g\cdot\De\vec a^n / \vec\de_g\cdot\vec a^n$ must be $n$-independent. That means constant, at least per group. Formally written (and similarly for the $\De\vec b^n$ term):
\eqref{
{\vec\de_g\cdot\De\vec a^n \over \vec\de_g\cdot\vec a^n} = \al_g,\qquad
{\vec\de_g\cdot\De\vec b^n \over \vec\de_g\cdot\vec a^n} = \be_g
\ .}{cnst shz g2}
For \em{one group}, there is infinite number of $\De\vec a^n$ vectors fulfilling this condition for a fixed value of $\al_1$. For \em{two groups}, there is a unique solution for given values $\al_1$ and $\al_2$. This means that singular modes are independent for each group, they are of form
\eqref{\De z_i = \al_g z_i + \be_g,\qquad \hbox{for groups }g \in \lbrace 1, 2\rbrace\ .}{cnst shz g3}
This means that the number of singular modes is doubled compared to \Eq{cnst shz 5}.

For \em{three and more groups}, the $\vec a^n$ vector is defined by two (let's say first and second) $\al$ values. Let's check what are the conditions for the other $\al$ values so as all requirements \Eq{cnst shz g2} are satisfied. Since $\vec\de_g$ vectors are two dimensional, one can put
\eqref{\vec\de_g = \et_{g1}\vec\de_1 + \et_{g2}\vec\de_2\ .}{cnst shz g4}
(For $g>2$ both $|\et| < 1$). Inserting that to \Eq{cnst shz g2} yields
\eqref{\al_g = {
\et_{g1} \vec\de_1\cdot\De\vec a^n \al_1 + \et_{g2} \vec\de_2\cdot\De\vec a^n \al_2
\over
\et_{g1} \vec\de_g\cdot\vec a^n + \et_{g2} \vec\de_g\cdot\vec a^n
}\ .}{cnst shz g5}
If $\al_1 \neq \al_2$, then $\al_g$ would become $n$-dependent, which is not possible. Therefore, there is no solution for this case. If $\al_1 = \al_2$, then all $\al_g$ are equal. This is exactly the solution \Eq{cnst shz 5} derived in the preceding section.

\em{Rotations around $z$}. Here, one can proceed in a similar way as for shift in z. One gets an analogy of \Eq{cnst rotz 3} for every group
\eqref{\de_g \cdot \mat R(\de\rh_i)^\T \vec a^n = \de_g \cdot {\vec a'}^n\ ,}{cnst rotz g1}
 which limits the dependence of $\De\rh$ only to group: $\De\rh_i \rightarrow \De\rh_g$. For \em{one} group there exist infinitely many solutions, for \em{two groups} there is exactly one. The solution has the form of \Eq{cnst rotz 7}, but separately for each groups -- therefore there are two linearly-independent singular modes. Schematically written

\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} = \al_g \pmatrix{
1\cr
- \de s_i
},\qquad \hbox{for groups }g \in \lbrace 1, 2\rbrace\ .}{cnst rotz g2}


For \em{three and more groups}, the ${\vec a^n}'$ vector is fixed by two values of $\De\rh_g$ (again, take the first and second). Using the decomposition \Eq{cnst shz g4} one finds (in infinitesimal approximation)
\eqref{\De\rh_g = {
\et_{g1} \vec\de_1\cdot\De\vec a^n \De\rh_1 + \et_{g2} \vec\de_2\cdot\De\vec a^n \De\rh_2
\over
\et_{g1} \vec\de_g\cdot\vec a^n + \et_{g2} \vec\de_g\cdot\vec a^n
}\ .}{cnst rotz g5}
This is a similar result to \Eq{cnst shz g5} and thus the interpretation is similar too. There is no solution if $\De\rh_1 \neq \De\rh_2$ and if they are equal, then all $\De\rh_g$ are equal. This reveals the solution \Eq{cnst rotz 7} from the previous section.

The singular modes are summarized in \Tb{al sing mode overview}.

As it was already said, the \em{design} of the Roman Pot detectors is such that there would be only two read-out directions. However in \em{reality}, because of misalignment rotations, the number of read-out directions is as large as the number of detectors. But since the misalignments small only, one stays close to the 2-readout-direction case. This will manifest in a presence of several modes with low but non-zero eigenvalues. 

\TODO{A few comments about numerics here.} First of all, it is clear that the eigenvalues of $\mat S$ would scale with the number of events (if the track-distribution is constant). Then, it make sense to define
\eqref{\hbox{\em{normalized eigenvalues} as the eigenvalues of }\mat S/N_{\rm events}\ .}{S norm eig val}
These should be, in first approximation, independent of the number of events. Second, due to limited precision of calculations\footnote{Double precision and ROOT matrix libraries have been used.}, the singular modes will not have their eigenvalues strictly zero. Because of the computational error it is even possible that their eigenvalues would come out negative. That is why we will always use the absolute value of the normalized eigenvalues. Although the singular modes will have non-zero values, they would be much smaller than those for regular modes. In between, one can expect band with no eigenvalues. This band can then be used to set a \em{singular limit}, that is the eigenvalue limit below which the eigenvalues would be treated as singular. All these effects can be seen if \Fg{al eig rho}.

\fig{fig/pdf/al_eigenvalues_rho.pdf}{al eig rho}{The dependence of normalized $\mat S$ matrix eigenvalues on the RMS of $\rh$. Theta 10 mrad, geometry 2.7x3.3, overlap=f. Colors correspond to the eigenvalue order. The top row shows the eigenvalues when only shifts in read-out direction are optimized. In middle row rotations about $z$ are added and in the bottom one also shifts in $z$. The two columns provide views in two different horizontal scales. The dashed lines correspond to the singular modes for any geometry. The rapidly changing eigenvalues demonstrate the transition from two to three and more groups.}

\ssubsection[al path tr dist]{Pathological track distributions}

So far we have discussed singular and weak modes that arise from the track parameterization and the geometry of read-out directions. Besides those, there could be singular modes arising from special track distributions. One could immediately think of a case where the detectors split into several groups and there would be no track going through detectors of several groups in the same time. Regarding RPs, this situation appears when the pots are not inserted close enough and therefore no track can go through the overlap between the vertical and horizontal pots. In this case, the alignment task would split into several smaller tasks (one per group) and for each of them one could write alignment equation like \Eq{fit equation}. Each of these equations contain a $\mat S$ matrix with its singular modes as discussed. Therefore the number of singular modes gets multiplied by the number of groups.

The LHC proton tracks are very parallel (\TODO{reference}), that is their slopes can be written:
\eqref{\vec a^n = \vec a_0 + \de\vec a^n,\qquad \si(\de\vec a^n) = \O{10^{-4}\un{rad}}\ .}{cnst rotz lt0}
 Let's look back to \Eq{cnst rotz 2} and check what happens when the spread $\de\vec a^n\to 0$. We first expand the rotation matrix keeping just the first Taylor terms:
\eqref{\pmatrix{1 & -\De\rh_i\cr \De\rh_i & 1\cr} (\vec a_0 + \vec b^n - \vec c_i - \De\vec c_i) = {\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i\ .}{cnst rotz lt1}
This equation can still be solved by $\De\rh_i\equiv\hbox{const.}$, which leads to the solution \Eq{cnst rotz 7}. But there is another solution:
\eqref{\De\rh_i = \al z_i\ ,}{cnst rotz lt2}
where $\al$ is a proportionality constant. This can be seen, for example, by rearranging the terms on the \lhs{}:
\eqref{
\underbrace{\left[ \vec a_0 + \al \pmatrix{-b^n_y\cr b^n_x} \right]}_{{\vec a'}^n} z_i
	+ \underbrace{\vec b^n}_{{\vec b'}^n}
	- \vec c_i
	- \underbrace{\De\vec c_i - \al z_i \left[ \pmatrix{-c_{i_y}\cr c_{i_x}} - z_i \pmatrix{-a_{0_y}\cr a_{0_x}} \right]}_{\De\vec c_i'}
}{cnst rotz lt3}

In analogy to the arguments above \Eq{cnst rotz 7}, one can conclude that
\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} \propto z_i\, \pmatrix{
1\cr
- \de s_i
},\qquad \de s_i = \vec d_{\perp_i} \dot (\vec c_i - \vec a_0 z_i)\ .}{cnst rotz lt4}
is a weak mode. It would be a true singular mode if we did not use the Taylor approximation of the rotation matrix. Or if all $\rh_i$'s would be zero. But as show in \Fg{al eig theta}, this weak mode is numerically indistinguishable from real singular modes for sufficiently parallel tracks.

It would be possible to draw a similar line of arguments for the case where $\vec b^n\to \vec b_0$. But keeping in mind the application to LHC proton tracks, this turns out to be very unrealistic scenario.

The treatment above started with \Eq{cnst rotz 2}, which assumes that the read-out directions can have all values. In section \Sc{al sing modes groups} we have derived that if there are just two read-out direction groups, the number of singular modes for rotations doubles. In a similar way one can find out that this is the case for the weak mode \Eq{cnst rotz lt4} too. There would be a copy of \Eq{cnst rotz lt3} for every group, with independent proportionality constants $\al_g$. This would lead to one weak mode per group, just like in \Eq{cnst rotz g2}.

Eventually, let's remark that parallel tracks do not introduce new weak modes for shifts in read-out nor in $z$ direction. The reason is simple, their $\ga$ factors (see \Tb{alignment quantities}) do not involve both track parameters (slope and intercept). Thus it is not possible that a misalignment would ''convert'' one to the other (in the sense of creating slope $\vec a'$ from intercept $\vec b$ in \Eq{cnst rotz lt2}). \TODO{For z shifts, the number would indeed increase, with no slope spread, the z shifts can not be determined at all}.

To summarize, the \Tb{al sing mode overview} lists the weak modes that emerge when tracks become very parallel. \Fg{al eig theta} illustrates the situation by showing the dependence of the $\mat S$ matrix eigenvalues on the RMS angle of the tracks.

\fig{fig/pdf/al_eigenvalues_theta.pdf}{al eig theta}{The dependence of $\mat S$ matrix eigenvalues on the RMS of the track slopes $\vec a$. Misalignment shr\_rotz=0. 2.7x33, overlap=f, whole station, $\si_\rh=0\un{mrad}$. For higher sigma(rho) there is just one line right where you can see the red and blue curves. The vertical dotted line marks the typical slope spread in the LHC data.}

\htab{al sing mode overview}{Overview of singular and weak modes. The bold numbers give the number of singular modes that are listed afterwards. The ''glob.'' abbreviation stands for ''global'' which is used to refer to a mode with constant coefficients for every detector. The ''l.p.'' stands for ''linearly-progressive'' which means a mode the coefficients of which are proportional to $z_i$. In that sense X and Y shearings can be seen as linearly-progressive X and Y shifts. Note that the additional modes for the parallel-track case ($\si(\vec a) = 0$) are weak only.}{
\omit&\multispan{4}\bhrulefill\cr
\omit			&\multispan2\bvrule\strut\hfil two read-out directions\hfil &\multispan2\strut\vrule\hfil three and more read-out directions\hfil\cr
\omit\bhrulefill&\multispan{4}\hrulefill\cr
\hbox{quantity class}	& \si(\vec a)>0 & \si(\vec a)=0 & \si(\vec a)>0 & \si(\vec a)=0 \cr\bln
\hbox{read-out shift}	&\multispan4\bvrule\hfil {\bf 4}: X and Y global shifts, X and Y shearings\hfil\cr\ln
%
&\hbox{{\bf 2}: glob. rot.}  &\hbox{{\bf 4}: glob. and l.p. rots.} &\hbox{{\bf 1}: glob. rot.} &\hbox{{\bf 2}: glob. and l.p. rot.} \cr
\omit\vbox to 0pt{\vss\hbox{ rotation about $z$ }\vss}&\multispan4\cr
& \hbox{for U and V indep.} & \hbox{for U and V indep.}&&\cr\ln
%
& \hbox{{\bf 4}: glob. and l.p.} &  & \hbox{{\bf 2}: glob. and l.p.}  & \cr
\hbox{shift in }z	& \hbox{shifts in }z &-& \hbox{shift in }z&-\cr
& \hbox{for U and V indep.} &&&\cr\bln
}

\subsection[al constr]{Constraints}

To solve the fit equation \Eq{fit equation}, one has to imply additional constraints that would regularize the $\mat S$ matrix. For the alignment task, these constraints may be for example metrology or laser measurements. Such constraints may be written in the following form
\eqref{\vec c \cdot \hat\vec\ch = v\ ,}{cnst form}
where the vector $\vec c$ describes the structure of the constraint and $v$ contains the measurement outcome.

To solve the fit equation with constraints, it is advantageous to employ the Lagrange multipliers technique (\TODO{reference}). It suggests to expand the fit equation to \TODO{T with tilde}
\eqref{\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
} \pmatrix{
\hat\vec\ch \cr
\vec\La \cr
} = \pmatrix{
\vec T\cr
\vec V\cr
}\ ,}{alignment equation}
where the $\mat C$ matrix contains the $\vec c$ vectors (see \Eq{cnst form}) in columns for all constraints applied and vector $\vec V$ includes corresponding $v$'s. $\vec\La$ is the vector Lagrange multipliers. Let's demonstrate that this equation does what we want. First, let's rewrite as two equations
\eqref{\tilde\mat S \hat\vec\ch = \vec T - \mat C \vec\La \equiv \vec T'(\vec\La)\ ,}{cnst aux1}
\eqref{\mat C^\T \hat\vec\ch = \vec V\ .}{cnst aux2}
The second one obviously presents a series of constraints of type \Eq{cnst form}. Since $\mat S$ is symmetric (\TODO{ref}), it can be diagonalized as follows (see e.g. \bref{wikipedia} key \em{symmetric matrix})
\eqref{\mat S = \mat Q \mat D \mat Q^{-1}, \qquad
\mat D = \diag(\underbrace{0, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}}; \underbrace{\la_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}}), \qquad
\mat Q = (\underbrace{\vec s_1, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}} ; \underbrace{\vec r_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}})
\ ,}{cnst aux3}
where we have ordered the eigenvalues and eigenvectors such that all singular modes go first. Let's remark that we don't require eigenvectors for the same eigenvalue to form an orthonormal set (although we could). This will enable us to work with singular modes as derived above (without ortnormalizing them). Since $\mat Q$ is regular, one can put
\eqref{\mat D \mat Q^{-1} \hat\vec\ch = (\mat Q^\T \mat Q)^{-1} \mat Q^T \vec T'(\vec\La)}{cnst aux4}
and expand the parts for singular vectors
\eqref{
\pmatrix{
\ddots & & & \vrule & \cr
& 0 & & \vrule & \cr
& & \ddots & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\mat Q^{-1} \hat\vec\ch = 
\pmatrix{
& & & \vrule & \cr
& (\mat E^\T \mat E)^{-1} & & \vrule & \cr
& & & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\pmatrix{
\cr
\mat E^\T\cr
\cr
\noalign{\hrule}
\vdots\cr
}
\vec T'(\vec\La)
\ .}{cnst aux5}
(The $\mat E$ matrix contains the singular vectors $\vec s_i$ in columns). The part above the vertical line on the \lhs{} is identically equal to zero and thus so the \rhs{} must be. Considering that $\mat E^T \mat E$ is regular, one finds
\eqref{\mat E^\T \vec T = \mat E^\T \mat C \vec\La\ .}{cnst aux6}
In order to find solution $\vec\La$ for any $\vec T$,
\eqref{\mat E^\T \mat C\hbox{ must be regular}\ .}{cnst condition}
This condition defines what constraints may be used. We will discuss some convenient choices later on.

For the moment, let's get back to \Eq{cnst aux1}. (As $\vec\La$ has been resolved from \Eq{cnst aux6}, $\vec T'$ is known.) This equation has infinite number of solutions that can be written
\eqref{\hat\vec\ch(\vec\et) = \vec\ch^0 + \mat E \vec\et\ ,}{cnst aux7}
where $\vec\ch^0$ is a particular solution and $\vec\et$ are parameters in the solution space of the homogeneous equation. Inserting that to \Eq{cnst aux2} yields
\eqref{\vec\et = (\mat C^\T \mat E)^{-1} (\vec V - \vec C^\T \vec\ch^0)}{cnst aux8}
and therefore \Eq{alignment equation} has always a unique solution that satisfies all constraints \Eq{cnst form}.

Now it would be nice to show that the actual misalignments can play the role of $\vec\ch^0$. Unfortunately, this is the case only for shifts in the read-out direction. For the other misalignment classes it is violated because of the linearization step \Eq{tau linearization} -- see section \Sc{fit equation}. Combining \Eq{exact fit equation,cnst aux6} yields
\eqref{\vec\La = (\mat E^\T \mat C)^{-1} \mat E^\T \bar\mat S \vec\ch_a\ .}{cnst aux9}
If we were not forced to make the linearization step \Eq{tau linearization}, $\mat E$ would contain singular vectors of $\bar\mat S$ and thus their product would be identically zero. Then, $\vec\La = 0$, $\tilde\vec T = \vec T$ and \Eq{cnst aux1} would become trivial
\eqref{\tilde\mat S \hat\vec\ch = \tilde\mat S \vec\ch_{\rm a}\ ,}{cnst aux10}
which demonstrates that $\vec\ch_{\rm a}$ could play the role of the particular solution $\vec\ch^0$.

\TODO{Even with the linearization step, we will be assuming the same singular vectors for $\tilde\mat S$ as for $\bar\mat S$, hence $\vec\La = 0$ and the particular would obey
\eqref{\tilde\mat S \vec\ch^0 = \bar\mat S \vec\ch_{\rm a}}{cnst aux11}
$\vec\ch^0$ close to $\vec\ch_{\rm a}$ ...
}

We have seen that a set of constraints must fulfill \Eq{cnst condition}, but one has still a lot of freedom in their choice. Let's list here a few common options.
\> Probably the most natural choice is to take singular modes as the constraints, that is $\mat C = \mat E$. We will refer to this option as \em{homogeneous} constraints (the role of all detectors is equal, in contrary to the next option). 
\> Another natural choice is to select a subset of reference detectors the position of which would be fixed and let the other detectors align with respect to the reference ones. We will call this option \em{fixed-detectors} constraints. \TODO{how does the C matrix look like?}
\> The last option is called \em{final} since it has been agreed for the final alignment analysis. \Fg{al eig rho,al eig theta} suggest that, in standard conditions ($\De\rh_i = \O{5\un{mrad}}$, $\si(\vec a)=\O{0.1\un{mrad}}$), it is not possible to determine the rotation between U and V detectors and between near and far unit
%(following the weak mode \Eq{cnst rotz lt2} and the large $z$ difference between the units). 
with satisfactory precision. Thus one needs to constrain these modes too, increasing the number of rotation constraints to 4 (one constraint per U/V projection and per unit). The number of read-out shift constraint remains 4, but they will be a little different than the homogeneous constraints. The reason is that we trust the beam position determination by the touching exercise and therefore we want to preserve the vertical center between the top and bottom pots. Consequently, we will drop the horizontal pot from the vertical ($Y$) constraints. In fact we will drop the horizontal RP from the horizontal ($X$) constraints too. Since there is only one horizontal pot, the touching exercise cannot determine the horizontal beam position with a sufficient precision and the best (least bad) assumption is to keep the vertical pots (horizontally) at their nominal position. To summarize, for every unit, we will impose these 4 constraints:
\eqref{\eqnarray{
\hbox{shifts:}\qquad && \sum_{i\ \in\ \hbox{top, bottom}} \De s_i \, d_{x_i} = \sum_{i\ \in\ \hbox{top, bottom}} \De s_i \, d_{y_i} = 0\ ,\cr
\hbox{rotations:}\qquad && \sum_{i\ \in\ \hbox{U detectors}} \De \rh_i = \sum_{i\ \in\ \hbox{V detectors}} \De \rh_i = 0\ .
}}{final constraints}

The final set of constraints differs from the others in the sense that it includes some weak modes too. This means that the dimensions of the $\mat E$ and $\mat C$ matrices are different and one can not apply the arguments from the beginning of this section. The condition \Eq{cnst aux6} still remains valid, however, it does not fully determine $\vec\La$ and consequently \Eq{cnst aux7} does not hold. If all constraint vectors $\vec c$ were perpendicular to all regular modes $\vec r_i$ (like for homogeneous constraints), then one could obtain a generalization
\eqref{\hat\vec\ch(\vec\et_E, \vec\et_W) = \vec\ch^0 + \mat E \vec\et_E + \mat W \vec\et_W\ ,}{cnst gen sol space}
where the $\mat W$ matrix contains weak modes as columns. In this case, the $\vec\et$ parameters are still fully determined by the constraint values $\vec V$. However, fixed-detectors and final constrains do not fall even to this category and thus the difference $\hat\vec\ch - \vec\ch^0$ depends on the details of the $\mat S$ matrix. That means that the solution depends on the sample used. In other words, over-constraining may give rise to an extra error. \TODO{negligible in our case}.

For the last comment, let's recall that the $\mat S$ scales with the number of events $N_{\rm events}$ (see \Eq{S norm eig val}). In order to simplify the interpretation of the eigenvalues of the alignment matrix (see \Eq{alignment equation}), it is advantageous to let the $\mat C$ matrix scale with $N_{\rm events}$ too. This effectively means to use
\eqref{\mat C = N_{\rm events}\, \mat C^0\ ,}{C scaled}
where $\mat C^0$ is one of the constraint choices above, which does not scale with the number of events.

\subsection[al err]{Errors}

%\TODO{
%Generally - I want to show that the algorithm is performing well:
%\> no systematics under ideal circumstances
%\> errors under control
%}

Any error that might appear can be of two origins only -- \em{approximations} and \em{neglected effects} (multiple scattering, DAQ problems etc.). One can check the presence of problems of the latter type by dividing the sample into a number of subsamples. If results obtained from the subsamples are not compatible with each other, these effects are important (however, in \Sc{al exp res} we will see it is not the case). 

Let's review the approximations we have made while developing the alignment equations.
\bitm
\itm We have completely neglected the \em{pitch rounding}, described by \Eq{full measurement}.
\itm We have \em{linearized the rotation matrix}, see \Eq{small rotation approximation}.
%$$(\cos\rh_i - 1) \vec\d_i^\T (\vec h^n - \vec c_i)$$
\itm The $\hat\mat\Ga$ matrices include \em{biased track parameters}, see \Eq{tau linearization}.
%$$\vec\d_{\perp_i}^\T \left[ (\vec a^n - \hat\vec a^n) z_i - (\vec b^n - \hat\vec b^n) \right]$$
\eitm

The pitch rounding is a gentle effect -- the error is smaller than the half of the pitch $P$. This is to be compared to with hit distribution that is several centimeters wide. In the first approximation one could assume that the error is
\eqref{\eqnarray{
&\bullet \hbox{ a random variable uniformly distributed on } (-P/2, +P/2) \hbox{ and}\cr
&\bullet \hbox{ the errors in different detectors are independent.}\cr
}}{pitch error model}
Especially the second one is not really true, but we will see (in \Fg{al stat fixDet} for instance) that it leads to satisfactory results though.

An important property of the pitch error is that the errors in different events are independent. That is
%(event if one keeps the same track distribution and geometry)
if one doubles the sample, the errors in the second half will be independent of those in the first half. As a consequence, one may assume better results with increasing sample size. As rule of thumb, the error should be proportional to $1/\sqrt N$ where $N$ is the sample size. That is why the pitch rounding error is of \em{statistical} nature.

The other two error sources (approximations 2) and 3)) do not behave in this way. In contrary, one can assume that the final error would be independent of the sample size
%(provided that track distribution and geometry and misalignments remain the same)
. Therefore, the rotation-matrix linearization and biased $\ga$ coefficient lead to a \em{systematic} error.

The above statements are hypothesis only, we will illustrate their validity with a number of Monte-Carlo tests below (see \Sc{al mc tests})

The rotation-matrix linearization is an 2nd-order effect. If $\De\rho\approx 10\un{mrad}$ and $h\approx 2\un{cm}$ would be typical rotation misalignment and hit position, then the error would be of order $\De\rho^2\,h/2\approx 1\un{um}$. This is to be compared with the bias in the $\ga$ coefficients, the order of which is $\De\rho h \approx 20\un{\mu m}$. Thus the linearization effect is rather small and we will neglect it in what follows.


\ssubsection[al stat unc]{Statistical uncertainty estimate}

The solution of the alignment task is given by \Eq{alignment equation}. Here, there are two quantities that are subject to statistical uncertainties: $\vec T$ and $\vec V$. The uncertainty of $\vec T$ vector is propagated from the measurements $\vec M^n$ through \Eq{fit equation}. The assumptions about measurement errors have been summarized in the pitch error model \Er{pitch error model}. $\vec V$ is an outcome of an external measurement and as such it is likely to subject to certain uncertainty. All these uncertainties can be propagated to the uncertainty of the result $\hat\vec\ch$.

Eq\hbox{.} (4.19) on page 60 in \bref{barlow} reads
$$\vec y = \mat A\vec x \qquad \Rightarrow \qquad \Var\vec y = \mat A\ \Var\vec x\ \mat A^\T\ .$$
This can be directly applied to \Eq{alignment equation}:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\Var \pmatrix{\tilde\vec T\cr\vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}
Since $\tilde\vec T$ and $\vec V$ are independent and $\Var \tilde\vec T = \tilde\mat S$, one obtains:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\pmatrix{\tilde\mat S& 0\cr 0 & \Var \vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}
The uncertainties of the $\vec\ch$ vector components can be found on the diagonal of the matrix above:
\eqref{\si(\bar\ch_i) = \sqrt{\Var \pmatrix{\bar\vec\ch\cr\vec\La}_{i\,i}}}{al par unc}

\ssubsection[al iter]{Iterations}

\Tb{al iter} shows the principle of iterations. The symbol $\vec\ch$ represents a state of the alignment, thats is geometrical corrections to be applied on the basic geometry. The numerical lower indices refer to the relevant iteration, $\vec\ch_0$ stands for the initial alignment. The correction obtained in $i$-th iteration is denoted $\De \vec\ch_i$. The expression in the right-hand side column summarizes our understanding of the errors. That is the correction shall be equal to the difference between the actual alignment $\vec\ch$ and the pre-iteration alignment $\vec\ch_{i-1}$ (modulo constraints -- filter matrix ${\cal F}_{\rm constr}$) altered by the statistical ($\De \vec\ch_{\rm stat}$) and systematic ($\De \vec\ch_{\rm syst}$) errors. For a given sample the statistical error (given by the pitch rounding) is constant (when not changing the cut parameters which would modify the sample). The systematic error depends on ''how far we are from the actual alignments,'' that is $\vec\ch - \vec\ch_i$. The iterations continue as long as the corrections are important (their size is larger than a limit). In the LHC data analysis, two iterations turned out to be sufficient. That is the correction in the third one was already negligible.

After the iteration process has converged, the final error still have two components -- the statistical and the systematic. The latter one is proportional to the distance to the actual alignments. The distance can not vanish because of two reasons -- the constraints (some alignment modes remain undetermined) and the statistical error. \Fg{al syst err uv rot,al syst err fn rot} show the systematic errors due to undermined $U$-$V$ and far-near unit rotations. \TODO{The systematic error induced by the statistical error}

\tab[\strut\hfil#\qquad&#\hfil\qquad&#\hfil\cr]{al iter}{A scheme of alignment iterations with the error evolution.}{\ln
			& alignment & correction \cr\ln
			& $\vec\ch_0$ \cr
iteration 1	& $\downarrow$	\cr
			& $\vec\ch_1 = \vec\ch_0 + \De \vec\ch_1$ & $\De \vec\ch_1 = {\cal F}_{\rm constr} (\vec\ch - \vec\ch_0) + \De \vec\ch_{\rm stat} + \De \vec\ch_{\rm syst}(\vec\ch - \vec\ch_0) $ \cr
iteration 2	& $\downarrow$	\cr
			& $\vec\ch_2 = \vec\ch_1 + \De \vec\ch_2$ & $\De \vec\ch_2 = {\cal F}_{\rm constr} (\vec\ch - \vec\ch_1) + \De \vec\ch_{\rm stat} + \De \vec\ch_{\rm syst}(\vec\ch - \vec\ch_1) $ \cr
			& $\vdots$	\cr
(last) iteration n	& $\downarrow$	\cr
			& $\vec\ch_n = \vec\ch_{n-1} + \De \vec\ch_n$ & $|\De \vec\ch_n| < \hbox{limit}$ \cr\ln
}

\TODO{Iterations: an example of convergence?}


\subsection[al mc tests]{Monte-Carlo tests}

\TODO{Keep it standalone or under the Errors section?}

In the previous section the errors of the algorithm were discussed. To support our hypotheses we will use Monte-Carlo simulations now. But before, we will briefly review how these simulations are performed and evaluated.

Fast simulation. Random tracks generated at $z=217\un{m}$ (station 12 used). Slopes generated with gauss distribution with $\si$ either $0.1\un{mrad}$ (realistic scenario\TODO{reference}) or $10\un{mrad}$ (the highest angle that can be detected simultaneously in both units). Intercepts generated with either uniform distribution on $ -20\un{mm} < x, y < +20\un{mm}$ or Gauss distribution with $\si_x = 6\un{mm}$ and $\si_y = 8\un{mm}$. The latter distribution represents a more realistic scenario, where tracks cumulate close to the beam. The quoted RMS have been chosen to approximately match the experimental distributions.

Theoretical hits of such tracks are calculated according to \Eq{local track,global to local,full measurement}. The charge-sharing effects are simplified to the creation of one and two-strip clusters, as shown in \Fg{fast simulation scheme}. This effectively means that, if the theoretical hit falls in a blue region, its position is rounded to the nearest dash-dotted line, if it falls in a white region, the position is rounded to the nearest strip. One-strip hits were assigned the error or $P/\sqrt{12}\approx 19\un{\mu m}$. Regarding the uncertainty of double-strip hits, we have made two sorts of simulations -- with full error $P/\sqrt{12}$ and with reduced error $P/\sqrt{4\cdot12}$. We will show (\Fg{al syst err pitch}) that the reduced errors violate the assumptions \Er{pitch error model}. Thus, later on, full error simulations will be meant, unless specified differently.

\TODO{We haven't used G4 as it would take too long time. What difference may one expect compared to the G4 simulations/real data?}

\fig{fig/pdf/fast_simulation_scheme.pdf}{fast simulation scheme}{One and two-strip cluster regions as used in the fast simulation. The solid lines represent the strip centers, the dash-dotted lines mark the half way between the strips. The blue areas correspond to the double-strip-cluster regions, the white ones to the regions where one-strip clusters are created.}

The simulations could have been run with the pitch rounding on or off (the rounding in \Eq{full measurement} applied or not). Also, the $\ga$ parameters could have been calculated from the fitted track parameters (biased) or from the original generated track (non-biased). While the combination with pitch rounding on and biased parameters corresponds to the \em{real} alignment application, the combination with no pitch rounding and non-biased parameters corresponds to the \em{reference} results. There only the negligible rotation linearization error is present. The reference result was cross-checked with the \em{ideal} result that follows from \Eq{cnst aux7,cnst aux8}:
\eqref{\vec\ch_{\rm ideal} = \left[ 1 - \mat E (\mat C^\T \mat E)^{-1} \mat C^\T \right] \vec\ch^0 + \mat E (\mat C^\T \mat E)^{-1} \vec V\ .}{ideal result}
The first term removes the singular modes from the actual alignments $\vec\ch^0$ and the second term adds the singular modes with the coefficients as given by the constraints. \TODO{Indeed, the reference and ideal result compare well when only singular and weak modes are present. The equality breaks when some weak modes are not weak anymore -- large $\th$.}

\TODO{Overconstraints -- additional statistical error -- a picture?}

We have performed a number of simulations to explore the influence of various parameters. For every settings, the simulation has been repeated 20 times with different random seeds. For every repetition, we have calculated real results with their uncertainty and reference results. This provided us with a statistical sample on which we evaluated
\eqref{\vbox{\halign{\strut#\qquad&#\cr
quantity & label\cr\ln
\hbox{mean(real result - reference result)}	& \hbox{systematic error} \cr
\hbox{sigma(real result - reference result)}& \hbox{statistical error} \cr
\hbox{mean(uncertainty)} 					& \hbox{estimated uncertainty} \cr
}}}{al stat quan def}
the term sigma is used as square-root of variance here, the full formulae used can be found in \Sc{stat estim}. The \rhs{} column lists the labels that will be used for these quantities.

An example of such a statistical study can be seen in \Fg{al stat fixDet}. Here we chose fixed-detectors type of constraints, with rotations fixed only in the near unit. This is the reason for much higher errors in the far unit (bottom part). Let us make three important observations. First, the systematic error is compatible with zero within the estimated error \TODO{with a small exception}. Second, the estimated uncertainty falls as $1/\sqrt{N_{\rm tracks}}$. Third, the ratio of statistical error to estimated uncertainty is almost flat, but below the expected value of one. This means that the uncertainty estimated with the help of the model \Er{pitch error model} is overestimated. However, the most important observation was the first one, that there is no bias.

This was just an example, for other conditions and settings the results confirm the observations above. Another example can be found in \Fg{al stat final}.

\fig{fig/pdf/al_stat_fixDet.pdf}{al stat fixDet}{A statistical study of the alignment algorithm. We imposed a set of fixed-detectors constraints (for read-out shifts we fixed planes 1200, 1201, 1248 and 1249, for rotations 1200 and 1201). Every curve corresponds to the 3rd plane of a pot, see the legend. The near/far unit plots are at the top/bottom of the figure. The filled areas show $1\si$ error bands. The vertical dotted line marks a typical number of events in LHC runs.
%[20 repetitions, geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad, 3 iterations]
}

\Fg{al syst err pitch} demonstrates the impact of multi-strip-cluster uncertainties choice. The left plot shows the simulations for non-reduced uncertainties and confirms our previous statement about systematic errors. The picture changes dramatically when reduced uncertainties are used, see the right plot.
%Pitch rounding effect is different for every seed while the reduced ms cluster error one is the same for every seed.
That is why we will always use the non-reduced uncertainties in all following simulations and experimental data analyses.

\fig{fig/pdf/al_syst_err_pitch.pdf}{al syst err pitch}{The systematic error in read-out shifts as a function of the detector pitch. The error shown in the r.h.s.{} plot is due to the use of the reduced multi-strip-cluster uncertainties. Every line corresponds to one plane in near top RP. The plots for rotations about $z$ look likewise in the scale from $-0.5$ to $0.5\un{\mu m}$. The size of the double-strip-cluster region (see \Fg{fast simulation scheme}) was kept at $50\percent$ of the pitch. The vertical dotted line marks the actual pitch.
%it3 - precise3
}

It has been revealed by \Fg{al eig rho} that the $\mat S$ eigenvalues related to the $z$ shifts are rather low. One can, thus, expect large alignment errors and, indeed, \Fg{al err shz theta} confirms this expectation. The uncertainty never falls below $1\un{m}$ \TODO{compare to the misalignment expectation}. For the realistic beam divergence (dashed vertical line) the uncertainty is of the order of $10\un{m}$, which effectively means that there is no way to perform $z$-shift alignment.

Let us remark one feature of \Fg{al err shz theta} that is common for all $\si(\vec a)$ dependences -- the saturation above $\si(\vec a) \gs 10\un{mrad}$. The reason is simple, the $10\un{mrad}$ is roughly the maximum angle that can be detected by both units. Thus tracks of higher angles do not contribute.

\fig{fig/pdf/al_err_shz_theta.pdf}{al err shz theta}{The estimated uncertainty of $z$ shifts as a function of the track divergence $\si(\vec a)$. Simulations performed with $1000$ events and fixed-detectors constraints (fixed planes for $z$-shifts: 1200, 1201, 1248 and 1249). Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7). (The dashed lines are mostly covered by the solid ones in this picture.) The dotted vertical line shows the realistic track divergence.
%No misalignment, fix-ext constraints (rotz in 1200, 1201; shz in 1200, 1201, 1248 and 1249), extfit=f.
}

A similar situation takes place for relative $U$-$V$ rotations (see the rising $\mat S$ eigenvalue in \Fg{al eig rho}). \Fg{al err rotz rho} then confirms the expectation of large uncertainty of the rotation between $U$ and $V$ planes. In these simulations we modified the basic geometry -- instead of the nominal rotations $\rh_i$ we used $\rh_i + \de\rh_i$, where $\de\rh_i$ were randomly generated according to Gaussian distribution with zero mean and variance as indicated on the horizontal axes. Let us focus on the rotations in the near unit only (the far-near rotation issues will be discussed later, e.g. in \Fg{al err rotz theta}). Since we fixed the rotation of plane 1200, which is a $V$ plane, the uncertainties of all $V$ planes stays low (see the left plot). For $U$ planes one finds similar uncertainties for $\de\gs 0.1\un{rad}$ only. As one approaches the nominal geometry, the uncertainty grows almost like $1/\si(\de\rh)$. The expected rotational deviations from the nominal geometry are $\si(\de\rh) \approx 5\un{mrad}$ (see the vertical dotted lines). At this point, the $U$ uncertainties are about $10$ times larger that the $V$ ones. For typical LHC runs one can expect $10^5$ tracks, which give reduction factor of $10$ with respect to the uncertainties in the figure. This would mean $U$-$V$ rotation uncertainties of the order of $1\un{mrad}$, which is the misalignment expectation. Therefore the track-based alignment is unable to provide reasonable corrections to the relative $U$-$V$ rotations.

\fig{fig/pdf/al_err_rotz_rho.pdf}{al err rotz rho}{The estimated uncertainty of rotations about $z$ as a function of $\si(\de\rh)$ ($\de\rh$ gives the detector rotation difference from the nominal geometry). Simulations done with $1000$ events, fixed-detectors constraints and $\si(\vec a) = 0.1\un{mrad}$. The fixed for rotations was 1200 (a $V$ plane). Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7). (The dashed lines are mostly covered by the solid ones in this picture.) The vertical dotted line shows the realistic deviation from the nominal geometry.
%No misalignment (misaligned and real geometry contain detectors rotated with the given rho distribution). 1000 events. Extfit=false. fix-bas
}

If \Fg{al eig theta} we have seen that the eigenvalues of the linearly-progressive rotations depend strongly on the track divergence $\si(\vec a)$. Recalling the RP station geometry \TODO{reference} one can see the large gap in $z$ between the near and far units. These two facts may make us expect large uncertainties of the relative far-near rotation in the case of very parallel tracks. This is demonstrated in \Fg{al err rotz theta}. The uncertainties get saturated above $\approx 10\un{mrad}$, below they roughly follow $1/\si(\vec a)$. The lowest uncertainties can be found in the near top and bottom pots (the fixed planes are in the top RP). The near horizontal pot takes a bit higher uncertainty, it is $??\un{cm}$ downstream from the near verticals. The uncertainty of all the far pots is about $10$ times higher than of the near horizontal. If we take the typical LHC track divergence (vertical dotted line) and number of tracks ($10^5$), we are left with the far-pot rotation uncertainty of the order of $1\un{mrad}$. Since the misalignment estimate is\TODO{??}, it turns out that track-base alignment can not improve our knowledge of the far-near rotation.

\fig{fig/pdf/al_err_rotz_theta.pdf}{al err rotz theta}{The estimated uncertainty of rotation about $z$ as a function of the track divergence $\si(\vec a)$. Simulations performed with $1000$ events and fixed-detectors constraints (fixed planes for rotations: 1200 and 1201). Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7). The dotted vertical line shows the realistic track divergence.
%No misalignment, extfit=f. 
}

\Fg{al err rotz rho,al err rotz theta} provide another motivation to use of the final constraints (see \Eq{final constraints}). However, as it was mentioned in \Sc{al constr}, constraining weak modes (with low but non-zero eigenvalues) may lead to additional errors -- they are plotted in \Fg{al err overconstraints}. For every value of track divergence, we have made 20 simulations (with different random seeds). On this sample we have evaluated the sigma of the reference result (statistical error) and the mean difference between the reference and ideal result (systematic error). As expected, both errors are negligible for low values of $\si(\vec a)$, which is still true for the typical LHC track divergence (the vertical dotted line). For large $\si(\vec a)$ values the errors become relevant, however, in this case one could determine the far-near rotation and a ''lighter'' set of constraints could be used. The simulations used in \Fg{al err overconstraints} were performed with a misalignment scenario with the far-near rotation of $10\un{mrad}$. Let us remark that if a misalignment with no far-near rotations was used, the additional errors would vanish.

\fig{fig/pdf/al_err_overconstraints.pdf}{al err overconstraints}{The errors due to constraining the weak modes in the final set of constraints, plotted as a function of the track divergence $\si(\vec a)$.Every line corresponds to a detector in the near top RP. The dashed lines represent $V$ detectors while the solid $U$ detectors. The vertical dotted line marks the typical LHC track spread.
% Jan(round=f,extFit=t) - Ideal, 3 iterations, 
}

As already revealed by \Fg{al stat fixDet}, the systematic error is practically negligible. But still, let us explore them a bit more in detail. As discussed in \Sc{al err}, the systematic errors may arise either from the linearization of the rotation matrix, which gives a negligible contribution, or from undetermined alignment modes (they bias the $\ga$ coefficients). With the final constraints the are two types of undetermined modes: $U$-$V$ and far-near rotations. 

To study the systematic errors due to undetermined $U$-$V$ rotation, we have a created a set of misalignments scenarios. They all have had no read-out shift misalignment. The rotations have been generated according to Gaussian distributions with $\si = 1\un{mrad}$. The mean has been zero for $V$ detectors, for $U$ detectors as indicated on the horizontal axes in \Fg{al syst err uv rot}. One can see the errors are practically zero for $U$ detectors (solid lines), but non-zero for $V$ (detectors). This can be easily understood from the form of the $\ga$ coefficient for rotations (see \Tb{alignment quantities}) -- it contains the direction perpendicular to the read-out one. And in the nominal geometry, the direction perpendicular to $U$ is $\pm V$ and vice versa. Hence by neglecting (not determining) the rotations of $U$ detectors, one biases the $\ga$ coefficients for $V$ detectors (and gives raise to the related error).

\fig{fig/pdf/al_syst_err_uv_rot.pdf}{al syst err uv rot}{Systematical errors due to undetermined $U$-$V$ rotation $\De_{U-V}\rh$. The simulations have done with $\si(\vec a) = 0\un{mrad}$, final constraints and a special track distribution -- uniform on $0\un{mm}<x<10\un{mm}$ and $-20\un{mm}<y<20\un{mm}$. This distribution is closer to the typical LHC one and, moreover, amplifies the effect. Every curve corresponds to a detector in the near top RP ($V$ detectors are dashed, $U$ solid).
%geometry 2.7x3.3, Jan(round=f, extfit=f) - Jan(f, t), 3 iterations
}

A similar study has been performed for the far-near rotations, the results are in \Fg{al syst err fn rot}. Again, the misalignment scenarios had no read-out shifts. The rotations in the near unit were generated according to a Gaussian distribution with zero mean and $\si=1\un{mrad}$. The rotations in the far unit had the same sigma, but the mean as indicated on the horizontal axes of the figure. The figure is showing the results for the top far RP, for the near unit the effects are smaller by an order. The fact that the $V$ detectors have very low error is just a coincidence.
\TODO{Note the increasing difference between U and V detectors.}

\fig{fig/pdf/al_syst_err_fn_rot.pdf}{al syst err fn rot}{Systematical errors due to undetermined far-near rotation $\De_{F-N}\rh$. The simulations have done with $\si(\vec a) = 0\un{mrad}$, final constraints and a special track distribution (the same as in \Fg{al syst err uv rot}). Every curve corresponds to a detector in the far top RP ($V$ detectors are dashed, $U$ solid).
%geometry 2.7x3.3, 3 iterations, Jan(round=f, extfit=f) - Jan(f, t)
}

\Fg{al err rotz rho,al err rotz theta} gave us the motivation to use the final constraints, \Fg{al err overconstraints,al syst err uv rot,al syst err fn rot} reassured us that there is no relevant systematic error. To conclude this section, we include an equivalent of \Fg{al stat fixDet}, but with the use of the final constraints: \Fg{al stat final}. The interpretation is equivalent too: no systematic error and slightly overestimated uncertainty.

\fig{fig/pdf/al_stat_final.pdf}{al stat final}{A statistical study of the alignment algorithm with the final constraints. Every curve corresponds to the third plane of a RP, see the legend. The filled areas represent $1\si$ error bands. The vertical dotted lines mark the typical number of tracks in LHC runs.
%(20 repetitions), geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad.
}


\subsection[al data sel]{Input data selection}

With the fast Monte-Carlo one a priory knows that there was exactly one track per event and that all detector hits belong to this track. Consequently all track-fit residuals follow from misalignments. This is not true for real data. There might be a number of tracks per event, moreover different in every RP. There might be a number of hits that do not belong to any particle track -- noise, data corruption. That is why it is necessary to select carefully the input for the track-based alignment. It is better to loose some statistics than to bias the results with false input.

The selection algorithm has two components: hit selection and event selection. In the first one some hits are removed, since they are doubtful. In the latter one, entire events are dropped.

The hit selection is integrated with track fitting and can be described as follows.
\bitm
\itm Input: the collection of all hits from all detectors and all RPs.
\itm Local track fit (parameterization \Eq{local track}).
\itm Outlier removal: remove all points for which
\eqref{m_i - \hat m_i > \pmt{maxResidualToSigma}\, \si(m_i)\ ,}{al outlier cond}
where $\hat m_i = \vec d_i \cdot (\hat\vec a^n z_i + \hat\vec b^n)$ is the track interpolation and $\si(m_i)$ is the corresponding measurement error. \pmt{maxResidualToSigma} is a parameter of the algorithm.
\itm Remove all hits from RPs where there are less hits per projection than a given limit\break \pmt{minimumHitsPerProjectionPerRP}.
\itm If some points have been removed, go back to step 2. Stop otherwise.
\eitm

The event selection starts with a $\ch^2$ cut, that is all events with track fits the $\ch^2/\hbox{n.d.f.}$ of which exceeds a limit \pmt{chiSqPerNdfCut} are discarded. Then, there are few optional (they can be switched on or off) boolean checks, see \Tb{al alg flags}.

\tab[\strut\hfil#\ &#\hfil\cr]{al alg flags}{The boolean settings of alignment data selection.}{\ln
parameter							& meaning\cr\ln
\pmt{removeImpossible} 				& remove events with signal in a top and a bottom pot simultaneously\cr
\pmt{requireBothUnits} 				& require signal in both units\cr
\pmt{requireOverlap} 				& require signal in the overlap between horizontal and vertical pots\cr
\pmt{requireAtLeast3PotsInOverlap}	& if there is signal in the overlap, require signal in at least three pots\cr\ln
}

\TODO{
\> iterations, making cuts more strict
\> the cuts -- depend on situation, don't give values here but only later
}

\subsection[al rp fac]{Roman Pot alignment}

The basic structures in the track-based alignment are the detectors (sensors). Only these provide measurements and only these can be aligned. On the other side, the sensors are inserted (per groups) in RPs and thus, they share (per groups) common misalignments. One could, therefore, try to extract these common misalignments and call them \em{RP alignments}. However, this should be still understood in the sense of common shifts and rotations of the sensors in a RP. In no way, the track-based alignment can determine the positions of inactive elements, like the thin window.

\fig{fig/pdf/al_rp_misalignment.pdf}{al rp misalignment}{A side view on a RP (for simplicity only 4 planes are drawn). The displaced detectors are drawn in black, their centers are marked with dots. The centers of non-displaced detectors are shown as gray dots. The blue arrows represent $\vec c_i$ vectors from \Eq{al rp de c}. The green arrow represents the RP shift $\vec s^{\rm RP}$.}

Any RP misalignment can be decomposed to the shift of its center $\vec s^{\rm RP}$ and the rotation about its center. The rotation can be represented by a matrix $\mat R^{\rm RP}$, an equivalent of the rotation matrix for sensors (cf.~\Eq{global to local}). Let us define the center of a RP ($\vec c^{\rm RP}$) as the mean of its sensors' centers. The RP misalignments are naturally inherited by all sensors of this RP, but moreover, the rotation may give rise to additional shifts, see \Fg{al rp misalignment}. The center of $i$-th detector is
\eqref{\vec c'_i = \mat R^{\rm RP} (\vec c_i - \vec c^{\rm RP}) + \vec c^{\rm RP} + \vec s^{\rm RP}\ ,}{al rp c'}
where $\vec c$ would be its nominal center (without the RP misalignment). The only non-negligible component of $\vec c_i - \vec c^{\rm RP}$ vector is the $z$ one. Furthermore, since the expected mis-rotations are of the order \TODO{?? reference}, we can use the approximation \Eq{rotation parameterization approximated} for the rotation matrix $\mat R^{\rm RP}$. Then, keeping only $x$ and $y$ components, one finds
\eqref{\De\vec c_i \equiv \vec c'_i - \vec c_i = \vec s^{\rm RP} + \pmatrix{\rh_y^{\rm RP}\cr \rh_x^{\rm RP}} z_i^{\rm eff}, \qquad z_i^{\rm eff} = c_{z_i} - c_z^{\rm RP}\ .}{al rp de c}
Since the sensors are placed in RPs in regular $z$ intervals, one can expect the shifts to be linearly dependent on the plane number. And indeed, this can be seen in experimental data, for example in \Fg{al comp det per unit}. The shifts in read-out direction (this is what is determined by track-based alignment) can be compactly written
\eqref{
\pmatrix{\vdots\cr \De s_i\cr \vdots} = \mat F \pmatrix{s_x^{\rm RP}\cr s_y^{\rm RP}\cr \rh_x^{\rm RP}\cr \rh_y^{\rm RP}\cr}, \qquad
\mat F = \pmatrix{
\vdots & \vdots & \vdots & \vdots\cr
d_{x_i} & d_{y_i} & d_{x_i}\,z_i^{\rm eff} & d_{y_i}\,z_i^{\rm eff} \cr
\vdots & \vdots & \vdots & \vdots\cr
}\ ,}{al rp fit matrix}
where $i$ lists all sensors in the given RP. The last equality can easily be combined with the Least Squares method in order to determine the RP misalignments from experimental data:
\eqref{\pmatrix{s_x^{\rm RP}\cr s_y^{\rm RP}\cr \rh_x^{\rm RP}\cr \rh_y^{\rm RP}\cr} = (\mat F^\T \mat V^{-1} \mat F)^{-1} \mat F^\T \mat V^{-1} \pmatrix{\vdots\cr \De s_i\cr \vdots}\ ,}{al rp fit}
where $\mat V$ is the covariance matrix of the $\De s$ vector. The results of the track-based alignment is on the r.h.s. and the LS estimate on the l.h.s. 

As it has been said above, all sensors in a pot inherit its rotation misalignment. Since we can determine sensors' rotations about $z$, we can extract the RP rotation by simply taking the mean rotation
\eqref{\rh_z^{\rm RP} = {\sum_i {\rh_{z_i}\over \si^2_i} \over \sum_i {1\over\si_i^2}}\ .}{al rp rotz fit}
Again, $i$ lists all sensors in the given RP and $\si_i$ abbreviates the uncertainty of $\rh_{z_i}$.

Some results extracted from the LHC data can be found in \Fg{al comp rp all rot}.

\TODO{why slopes not extracted, why errors not used : they are used in the end!}

\subsection[al exp res]{Experimental results}

\ssubsection{Internal alignment comparison}



There are 3 sources: optical metrology, beam and cosmic tests in H8 and LHC data.

\vskip\baselineskip
\em{Optical metrology}

The position of the detectors within the RP assembly has been measured. There are 3 reference points on a detector and one point on the RP. For each detector a zoomed high resolution photo was taken and a relative position of the points 1 and 2 (see \Fg{opticalMetrology}) and the RP reference point was measured. Theoretical values and results are summarized in \Tb{metrology theoretical}. The precision of this measurement is $\approx 10\un{\mu m}$.

\fig{fig/pdf/opticalMetrology.pdf}{opticalMetrology}{An illustration of the optical metrology measurement. \TODO{points on detector or hybrid?} \TODO{add mark photo}}

\tab{metrology theoretical}{The theoretical values for the optical measurement of RPs (the positions of the fiducial marks).}{\bln
\multispan{2}\strut\bvrule\hfil reference point 1\hfil&\multispan{2}\strut\vrule\hfil reference point 2\hfil& \omit\bvrule\hfil control\hfil\cr
\multispan4\hrulefill&\cr
x\un{(mm)}	& y\un{(mm)}	& x\un{(mm)}	& y\un{(mm)}	& \omit\bvrule\hfil\ distance (mm)\hfil\	\cr\bln
75.068 & 31.631 & 25.932 & 31.631 & 49.136\cr\bln
}

\iffalse
\eqref{\hbox{control distance}\ d_c = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}}{metrology distance}

\fig{fig/pdf/opticalMetrologyControlDistance.pdf}{opticalMetrologyControlDistance}{The distribution of the control distance around the theoretical value (the dashed line) -- a measure of the statistical uncertainty.}

If one assumes that the uncertainty of a measurement in any direction is $\si_m$, then the error of the control distance is approximately $\si_m \sqrt2$. This follows from the error propagation via \Eq{metrology distance} and considering that $y_2-y_1\approx 0$ while $x_1-x_2\approx d_c$. Then, the distribution in \Fg{opticalMetrologyControlDistance} suggests that $\si_m \approx 1\un{\mu m}$. However, since the measurements enter \Eq{metrology distance} in differences, this error estimate is only valid for rotations as defined by \Eq{metrology rot}. For shifts, we will keep the more conservative estimate $10\un{\mu m}$
\fi

Shifts and rotations are extracted as follows
\eqref{\hbox{rotation} = {y_2 - y_1\over x_2 - x_1}}{metrology rot}
\eqref{x\hbox{ shift} = {x_1 + x_2\over 2} - \bar x,\qquad y\hbox{ shift} = {y_1 + y_2\over 2} - \bar y}{metrology shift}
where $\bar x$ and $\bar y$ are the arithmetic means of the theoretical values displayed in \Tb{metrology theoretical}

\htab{al opt uv rot}{Mean $U$-$V$ rotations determined from the optical metrology. Values in $\rm mrad$.}{\bln
\hbox{DP}	 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12\cr\ln
\De_{U-V}\rh & -0.13 & 0.51 & -0.07 & 0.00 & 0.19 & -0.24 & -0.21 & -0.08 & -0.10 & 0.06 & 0.03 & -0.08\cr\bln
}

\vskip\baselineskip
\em{H8 tests}

These are beam-test and/or cosmics ray data taken at H8 \TODO{explain H8}. The tests were done with one pot at a time.

The track-based alignment has been done with the following settings:
{\itskip0pt\itindent=\parindent
\> \pmt{minimumHitsPerProjectionPerRP} = 4,
\> \pmt{removeImpossible} = True,
\> \pmt{requireBothUnits} = False,
\> \pmt{requireOverlap} = False and
\> \pmt{requireAtLeast3PotsInOverlap} = False.
}

In total 5 iterations have been performed. In the first two only the read-out shifts have been optimized, in the rest the rotations about $z$ have been added. Some of the cuts have been made increasingly more strict, see \Tb{al H8 iter par}. \TODO{Justify the choice of the values}.
\htab{al H8 iter par}{The iteration-dependent alignment parameters as used in the H8 data analysis. s stands for read-out shifts, r for rotations about $z$.}{\bln
\hbox{iteration}&1 & 2 & 3 & 4 & 5\cr\bln
\hbox{quantities optimized}& \rm s & \rm s & \rm s+r & \rm s+r & \rm s+r \cr
\hbox{\pmt{maxResidualToSigma}}&10 & 7 & 3 & 3 & 3\cr
\hbox{\pmt{chiSqPerNdfCut}}&50 & 25 & 5 & 5 & 5\cr\bln
}

We have applied fixed-detector constraints. The fixed planes for read-out shifts were 0, 1, 8 and 9 (for every RP), same planes for rotations about $z$. We have made an attempt to fix only two planes for rotations (0 and 1), but the linearly-progressive rotation turned out to be badly constraint, spoiling the results -- see \Fg{al comp det per pot dp1 ext}.

\tab{al H8 stat}{Some statistics on the H8 data.}{\bln
\hbox{detector} & \hbox{later installed}  & \hbox{particle} & \hbox{events} & \hbox{events} & \si(a_x) & \si(a_y)\cr
\hbox{package} & \hbox{as RP}             & \hbox{type} & \hbox{total} & \hbox{used} & \rm mrad & \rm mrad\cr\bln
\hbox{1}  & \hbox{45-220-far-hor}  & \hbox{muons} & 2\cdot10^{4} & 1\cdot10^{4} & 4.9 & 4.9\cr\ln
\hbox{2}  & \hbox{56-220-far-hor}  & \hbox{muons} & 4\cdot10^{4} & 2\cdot10^{4} & 3.4 & 3.9\cr\ln
\hbox{3}  & \hbox{56-220-far-bot}  & \hbox{cosmics} & 9\cdot10^{2} & 4\cdot10^{2} & 53.4 & 53.1\cr\ln
\hbox{4}  & \hbox{56-220-far-top}  & \hbox{cosmics} & 6\cdot10^{2} & 3\cdot10^{2} & 55.3 & 53.5\cr\ln
\hbox{5}  & \hbox{56-220-near-top} & \hbox{cosmics} & 4\cdot10^{2} & 2\cdot10^{2} & 54.6 & 53\cr\ln
\hbox{6}  & \hbox{56-220-near-bot} & \hbox{cosmics} & 4\cdot10^{2} & 1\cdot10^{2} & 56.7 & 45.2\cr\ln
\hbox{7}  & \hbox{56-220-near-hor} & \hbox{cosmics} & 6\cdot10^{2} & 3\cdot10^{2} & 52.8 & 54.5\cr\ln
\hbox{8}  & \hbox{45-220-near-hor} & \hbox{muons} & 2\cdot10^{5} & 3\cdot10^{4} & 2.6 & 2.7\cr\ln
\hbox{9}  & \hbox{45-220-far-top}  & \hbox{muons} & 3\cdot10^{4} & 1\cdot10^{4} & 2.1 & 2.1\cr\ln
\hbox{10} & \hbox{45-220-far-bot}  & \hbox{muons} & 2\cdot10^{4} & 7\cdot10^{3} & 2.2 & 2.8\cr\ln
\hbox{11} & \hbox{45-220-near-top} & \hbox{muons} & 1\cdot10^{4} & 4\cdot10^{3} & 2.6 & 2.1\cr\ln
\hbox{12} & \hbox{45-220-near-bot} & \hbox{muons} & 6\cdot10^{4} & 2\cdot10^{4} & 2.3 & 2.1\cr\bln
}

\vskip\baselineskip
\em{LHC runs}

Track-based alignment with the same settings as for H8 data applied on the LHC runs (see \Tb{al lhc datasets})


\fig{fig/pdf/al_comp_det_per_pot_dp2_ext.pdf}{al comp det per pot dp1 ext}{An attempt to determine the $z$ rotations with one fixed plane per projection (planes 0 and 1).}

\fig{fig/pdf/al_comp_det_per_pot_dp1_ext2.pdf}{al comp det per pot dp1 ext2}{Internal alignment comparison for DP1 (an example of bad match). All LHC points are overlapping (one can see only the top orange) and hence only few data-sets are shown.
%ext2 constraints
}

\fig{fig/pdf/al_comp_det_per_pot_dp2_ext2.pdf}{al comp det per pot dp2 ext2}{Internal alignment comparison for DP2 (an example of good match). All LHC points are overlapping (one can see only the top orange) and hence only few data-sets are shown.
%ext2 constraints
}

\TODO{A conclusion:
\> compatibility of results?
\> which rotations can be determined - no way for U-V? Difficult event last-first plane.
}

\ssubsection{LHC data analysis}

To analyze the LHC data we selected the runs with horizontal RPs in, see \Tb{al lhc datasets}. \TODO{Usually the horizontal RPs were inserted in the very end, sometimes the beam died even before.} The alignment was applied with the following parameters:
{\itskip0pt\itindent=\parindent
\> \pmt{minimumHitsPerProjectionPerRP} = 4,
\> \pmt{removeImpossible} = True,
\> \pmt{requireBothUnits} = True,
\> \pmt{requireOverlap} = False (some analyses done with True, these will be \TODO{noted})
\> \pmt{requireAtLeast3PotsInOverlap} = True.
}

In total five iterations were performed. In the first two only the read-out shifts were optimized, then the rotations about $z$ were added. The reason was to remove as many pathological evens as possible before the rotations are optimized. The rotations are sensitive and if used from the very beginning, the convergence might be endangered. Some of the selection cuts were tightened during iterations, see \Tb{al LHC iter par}. \TODO{Justify the values}.
\htab{al LHC iter par}{The iteration-dependent alignment parameters as used in the LHC data analysis. s stands for read-out shifts, r for rotations about $z$.}{\bln
\hbox{iteration}&1 & 2 & 3 & 4 & 5\cr\bln
\hbox{quantities optimized}& \rm s & \rm s & \rm s+r & \rm s+r & \rm s+r \cr
\hbox{\pmt{maxResidualToSigma}}&100 & 10 & 10 & 3 & 3\cr
\hbox{\pmt{chiSqPerNdfCut}}&5000 & 50 & 50 & 5 & 5\cr\bln
}

Indeed, the final constraints were imposed.

\tab{al lhc datasets}{List of data takings \TODO{what data-takings}. The RP position gives an approximate distance of the vertical pot thin windows from the beam, in terms of beam sigmas.}{
\multispan3&\multispan6\bhrulefill\cr
\multispan3&\multispan3\bvrule\strut\hfil\hbox{sector 45}\hfil&\multispan3\vrule\hfil\strut\hbox{sector 56}\hfil\cr
\multispan3&\multispan6\hrulefill\cr
\multispan3&\omit\bvrule\hfil\strut\hbox{events}\hfil & \si(a_x) & \si(a_y) &\hbox{events} & \si(a_x) & \si(a_y)\cr
\multispan3\bhrulefill&&&&&&\cr
\hbox{date} & \hbox{RP position} & \hbox{run numbers} & \times 10^5 & \rm mrad & \rm mrad  & \times 10^5 & \rm mrad & \rm mrad \cr\bln
\hbox{24 Aug}    & 20\,\sigma & 2762,2763,2770,2772 & 7 & 0.3 & 0.3 & 8.4 & 0.3 & 0.3\cr\ln
\hbox{26 Aug}    & 20\,\sigma & 2896,2895,2892,2891 & 2.5 & 0 & 0 & 3.8 & 0 & 0\cr\ln
\hbox{21 Sep}    &  8\,\sigma & 3230,3231 & 0.5 & 0.2 & 0.2 & 0.6 & 0.3 & 0.2\cr\ln
\hbox{28 Sep}    & 18\,\sigma & 3285,3286,3287,3288 & 5 & 0.4 & 0.4 & 6.2 & 0.3 & 0.3\cr\ln
\hbox{05 Oct}    & 18\,\sigma & 3336,3337 & 10.8 & 0.4 & 0.4 & 15.1 & 0.3 & 0.3\cr\ln
\hbox{07 Oct}    & 18\,\sigma & 3359,3360,3361 & 4 & 0.3 & 0.3 & 4.6 & 0.3 & 0.3\cr\ln
\hbox{14 Oct}    & 18\,\sigma & 3457,3459,3460 & 0.8 & 0.4 & 0.4 & 1.1 & 0.3 & 0.3\cr\ln
\hbox{24 Oct}    & 18\,\sigma & 3609 & 6.2 & 0.2 & 0.2 & 6.6 & 0.2 & 0.2\cr\ln
\hbox{26 Oct}    & 18\,\sigma & 3634,3635 & 5.2 & 0.4 & 0.3 & 6.5 & 0.3 & 0.3\cr\ln
\hbox{29-30 Oct} &  7\,\sigma & 3723,3725,3728 & 2.5 & 0.2 & 0.2 & 2.9 & 0.3 & 0.2\cr\bln
}

$U$-$V$ rotation is impossible to determine, not even showing. However, the optical metrology suggests that is rather small, see \Tb{al opt uv rot}.

An attempt to determine the far-near rotations is in \Fg{al comp det per unit weak}. Here all runs are used (even those without horizontal RPs). The standard results (i.e. with final constraints) are taken as the starting point, then 5 iterations made with fixed-detectors constraints (fixed rotation planes: 1200 and 1201). The results are practically identical in the near unit, but incompatible in the far one. Moreover, in the far unit, the results have ''the same shape'' but are ''shifted by a constant''. This outcome is quite easy to understand. The alignment equation \Eq{alignment equation} (dropping the constraints for a moment) reads
%$$\bar \mat S \vec\ch = \vec T \equiv \mat S \vec\ch^0 $$
%$$\bar \mat S \vec\ch = \bar\mat S \vec\ch^0 + \underbrace{(\mat S - \bar\mat S) \vec\ch^0}_{\De\vec T}$$
\eqref{\bar \mat S \vec\ch = \bar\mat S \vec\ch^0 + \De\vec T\ ,}{al de T}
where the $\De\vec T$ sums all error contributions. The solution can be symbolically written as
$$\vec\ch = \vec\ch^0 + " {\bar\mat S}^{-1} " \De \vec T$$
This form is quite instructive, although is has very vague mathematical meaning. The message is that for weak modes, with small eigenvalues $\la$, the error contribution
$$\De\vec\ch = \vec\ch - \vec\ch^0 \sim {\De\vec T\over\la}$$
can become big. In our case, the important weak modes are far-near rotations (for $U$ and $V$ detectors separately, see \Tb{al sing mode overview}). Since we constrained the rotations in the near unit, the error would fully manifest in the far one. Looking at the $z$ positions of the RPs (\Tb{rp station}), one can approximate and take one $z$ for the near and one $z$ for the far unit. In this approximation, the error would be constant for every pot (but indeed different for every projection) -- this is exactly the observed effect.

\fig{fig/pdf/al_comp_det_per_unit_weak.pdf}{al comp det per unit weak}{Alignment comparison with fixed-detectors constraints (for rotations: 1200 and 1201). Top row: near unit, bottom row: far unit. October 24 (black), 26 (red), 29-30 (blue).}

As expected, it is not possible to determine the far-near rotations with sufficient precision and therefore we will use the final constraints. Such an example, for 56-220-near unit, is in \Fg{al comp det per unit}. On the first sight, one can see the shift points forming lines. This is exactly what one expects with rotated RPs, see \Sc{al rp fac}. The second interesting outcome is the stability of the results, especially for the shifts. The stability of the shifts means that the RP rotations about $x$ and $y$ do not change in time and the stability of the rotations infers the stability of the rotations about $z$ (see also \Fg{al comp rp all rot}). 


\fig{fig/pdf/al_comp_det_per_unit.pdf}{al comp det per unit}{Alignment comparison with the final constraints for 56-220-near unit. Each point corresponds to a data-taking from \Tb{al lhc datasets}. The dashed lines correspond to the fits \Eq{al rp fit,al rp rotz fit}. The internal shift/rotation is the sensor shift/rotation with respect to the RP shift/rotation.
%overlap=f
}

Let's investigate a bit more the stability of the RP shifts and rotations. Since a comparison for all sensors would require to much space, we decided to compare the RP alignments calculated according to \Eq{al rp fit,al rp rotz fit}. A comparison for unit 56-220-far can be found in \Fg{al comp rp all rot}. For each data-taking there are two points representing two analyses: with \pmt{requireOverlap} = False (circles) and with \pmt{requireOverlap} = True (squares). There were several reasons to do so. First, imagine there were some pathological events biasing the alignment results. Then, splitting the sample into two parts is likely to lead to results incompatible with each other (withing the estimated errors). The overlap requirement provides a subsample selection, moreover the subsample would have a rather different distribution of the rotation $\ga$ factors (see \Tb{alignment quantities}). Hence, this would test also the stability of the rotation determination. Looking at the results, one finds both analyses compatible -- this suggests that the results are robust.

Now, let's return to the RP position stability. Most shift corrections lie in a band of $\pm 10\un{\mu m}$ around the mean (dashed vertical line). This a good result which could have been achieved only thanks to the reliability of the (corrected) LVDT measurements. In fact, the mean values could be used to improve the corrections obtained in \Sc{al collim}. There we determined the corrections for the vertical positions of the vertical pots. Looking at the second row, one finds that track-based alignment brings a modification of $90\un{\mu m}$, which is below the uncertainty of the collimation alignment. Regarding the rotations, the situation is less homogeneous. Some rotations are very stable (all rotations of the horizontal pot), some less ($\rh_z$ of the two vertical pots). For the latter, the fluctuations go up to $\pm 0.4\un{mrad}$ from the mean. This is already an important rotation, which shall not be neglected. A quantitative summary of the rotations can be found in \Tb{al rp rot}. One can see the higher fluctuation of the rotations about $z$ also there.

\fig{fig/pdf/al_comp_rp_all_rot.pdf}{al comp rp all rot}{RP alignment comparison with fixed-detectors constraints. The order of points is the same as in \Tb{al lhc datasets} (top-down in both cases). There are might be two points for each data-set: a circle (all tracks) and a square (overlap tracks only). Showing only 56-220-far unit, in the near one, the $\rh_z$ fluctuations are smaller (see \Fg{al comp det per unit}).}

In fact, such a direct comparison of shifts as in \Fg{al comp rp all rot} is slightly misleading. Every rotation misalignment induces a shift correction, see the $\De\rh \de s_i$ term in \Eq{cnst rotz 6}. This correction is perpendicular to the position of the detector ($\vec c_i$ vector), that's why $\vec d_{\perp_i}$ in the formula. This means that the correction for vertical pots would be horizontal and vertical for horizontal pots. Moreover, the correction is proportional to the distance of the detector from the origin. Hence, this correction would be different for different RP approaches. That is why the comparison for different data-takings is misleading. For the data-takings in \Tb{al lhc datasets}, the thin-window positions varied approximately from $2.6$ to $8\un{mm}$ for the vertical pots and from $2.3$ to $5.6\un{mm}$ for the horizontal pots. The span was, thus, of the order of $\De c \approx 4\un{mm}$. From the \Eq{cnst rotz 6} one could expect the rotation-induced shifts to vary by $\De c \De \rh$. Taking $\De\rh \approx 10 \un{mrad}$ gives us variation by $40\un{\mu m}$. However, in the real case, the variation is much smaller, simulations give the order of $5\un{\mu m}$. There are two reasons for this. First, the final constraints are used, which mix shift and rotation degrees of freedom and make the calculation more complex. And second, the rotations of the top and bottom pots have nearly the same values but opposite signs. This leads to partial cancellations. To summarize, the shifts obtained from different data-takings can be compared within the error of $5\un{\mu m}$.

\htab{al rp rot}{Summary of the RP rotations results (all values in $\rm mrad$). Only analyses with all tracks (\pmt{requireOverlap} = False) have been included, since the other ones have very large errors for the sector 45. Mean is the (weighted) mean which is drawn as the dashed line in \Fg{al comp rp all rot}. $\si$ stands for the standard deviation of the results. 
% weighted mean, non-weighted sigma
}{
\omit&\multispan6\bhrulefill\cr
\omit&\multispan2\bvrule\strut\hfil$\rh_x$\hfil&\multispan2\vrule\strut\hfil$\rh_y$\hfil&\multispan2\vrule\strut\hfil$\rh_z$\hfil\cr
\omit\bhrulefill&\multispan6\hrulefill\cr
\hbox{RP} & \hbox{mean} & \si  & \hbox{mean} & \si  & \hbox{mean} & \si \cr\bln
  20 & -10.8& 0.08 & -4.8 & 0.15 & -4.5 & 0.07\cr\ln
  21 & -6.1 & 0.08 & +5.9 & 0.06 & +6.1 & 0.09\cr\ln
  22 & +1.7 & 0.02 & -1.4 & 0.04 & -1.6 & 0.03\cr\ln
  23 & -1.9 & 0.03 & -9.9 & 0.04 & -2.4 & 0.06\cr\ln
  24 & -7.3 & 0.04 & -0.9 & 0.04 & -2.4 & 0.15\cr\ln
  25 & -9.2 & 0.04 & +4.7 & 0.02 & +4.8 & 0.15\cr\bln
 120 & -7.7 & 0.05 & +2.3 & 0.03 & -3.5 & 0.08\cr\ln
 121 & -7.3 & 0.05 & \phantom{+}0.0 & 0.05 & +5.0 & 0.09\cr\ln
 122 & +1.2 & 0.03 & -5.7 & 0.03 & -1.6 & 0.03\cr\ln
 123 & -0.2 & 0.03 & -3.4 & 0.02 & -2.6 & 0.05\cr\ln
 124 & -3.8 & 0.06 & \phantom{+}0.0 & 0.02 & -4.5 & 0.19\cr\ln
 125 & -4.4 & 0.07 & +2.5 & 0.02 & +7.1 & 0.17\cr\bln
}

\TODO{Generally - want to show that everything is stable and consistent}



\section[al prof]{Profile methods}

\TODO{Comment about beam position}
\> beam position is the theoretical hit position of an elastic proton with $\th = 0$ and the mean vertex position.
\> (in our OfflineSW convention, the beam is at zero)
\> misalignements $\De q$ and RP positions $q^{\rm RP}$ (in accordance with \Eq{misalignment definition})
$$q^{\rm RP}(\hbox{actual/misaligned}) = q^{\rm RP}(\hbox{thought/nominal}) + \De q$$
hence for hit positions $q$
$$q(\hbox{reconstructed with thought geometry}) = q(\hbox{real}) - \De q$$

Profile methods are those which use symmetries in track and/or angular distributions. The expected symmetries depend on the studied physical processes as well as on the optics. However, the vertical symmetry around the beam can be assumed quite generally. If there was no crossing-angle, the process would have full azimuthal symmetry (about the beam axis). Even if the crossing-angle is non-zero, it is horizontal, hence the up-down symmetry is preserved. On the optics side, most of them are designed with vanishing vertical dispersion $D_y$, therefore the vertical symmetry remains also after the proton transport.

This vertical symmetry can be used even on-line, before data-taking, to symmetrized the position of the vertical RPs around the beam. This would increase the low $|t|$ acceptance.

Profile methods have also offline applications, that is those that can provide alignment corrections for registered data. Let us focus low-$\be$ optics, which was the case for 2010 data-takings. \Fg{al prof simu} shows typical hit distributions (MC simulation) for some important forward-physics processes. Beyond the aforementioned vertical symmetry, one can immediately spot the horizontal symmetry of the green points (elastic scattering). The entire next section will be devoted to the alignment with elastic scattering, but let us comment on how to use this symmetry even without separating a sample of elastic events. The ''hot spot'' close to $x\approx 0$ contains also a contribution from non-elastic processes with low $\xi$ (see for example the red dots -- DPE). Due to the horizontal dispersion, the hits are shifted to the right and the symmetry is broken. This can be well seen \Fg{al prof x dists}: the elastic peak is close to zero, but the non-elastic events form a broad structure shifted towards higher $x$ values. But what is important is that around $x=0$, the distribution is dominated by elastics events and their peak can be well fitted, as illustrated in the figure.

\Fg{al prof simu} shows the distributions as expected from simulations, however, in reality they look quite different, see \Fg{al prof hits}. On the first sight, we one can two major differences.
\bitm
\itm The \em{tilt of the elastic peak} (around the red line). Our current understanding is a XY coupling, \TODO{because of ...}
\itm The unexpected distribution of the diffractive hits (around the blue line, mainly for the sector 56). The distribution is tilted and deformed. The slope of the diffractive hits could be explained by the presence of a vertical dispersion \TODO{... more, comment about the shape}.
\eitm

As a consequence of the elastic peak tilt, the peak in the $x$ distribution widens up, see \Fg{al prof x dists} left, and its center does not correspond to the $x$ position of the beam. To mitigate this problem, one may divide the scatter plot into horizontal slices and build and fit the $x$ distributions for each of them (an example is in \Fg{al prof x dists} right; note the thinner peak). Then, the peak positions then be plotted versus the center of the slice, see an example in \Fg{al prof fits} left. The vertical error bands represent the slice widths, the horizontal are coming from the peak fit uncertainty. The points in green were removed as outliers. The red line represent a common fit through top and bottom pot data and it confirms that the tilt is the same for both RPs. Ideally (were there no errors), the red line would go through the beam position.

In principle, the same slicing method could be applied to the diffractive hits (see \Fg{al prof fits} right), however it is complicated by two facts. First, the profile is non-linear (can be seen by bare eyes in \Fg{al prof hits} right and is manifested by the point fluctuation in \Fg{al prof fits} right). Thus the linear-fit result will be burdened by an important systematic error. Since the diffractive hit distribution is wide and therefore the statistical error of the fit is large as well. This all is made even worse by the second complication: since there is just one horizontal pot, the fit must be extrapolated to the beam position. At the end, the error propagation makes this method uninteresting.

\TODO{broken symmetries - assymetric acceptance, optics deviations, apperture limitations, trigger and detector efficiency bias}

\fig{fig/pdf/al_prof_simu.pdf}{al prof simu}{A Geant4 simulation of hit distributions at the RPs of the 56-220m near unit. The geen points represent elastic scattering (Elegent, PPP3), blue SD (Pythia) and red DPE (Phojet). All processes simulated at $\sqrt s = 3.5\un{GeV}$ and with nominal optics with $\be^* = 2.5\un{m}$. The black solid lines are the contours of the sensors. The dotted lines represent symmetry axes, the middle black dot marks the position of the beam.}

\fig{fig/pdf/al_prof_x_dists.pdf}{al prof x dists}{Horizontal hit distributions in the 56-220-near-top pot (data from 29-30 Oct). Left: all hits, Right: one horizontal slice only. The peak is mostly formed by elastic events, the background is dominated by DPE. The red curve is a Gaussian fit with quadratic background.}

\fig{fig/pdf/al_prof_hits.pdf}{al prof hits}{Typical hit distributions at near stations (scoring planes at $\pm 217\un{m}$). Data from 21 Sep. The far stations look qualitatively the same.
% analysis with vsym2 geometry
}

\fig{fig/pdf/al_prof_fits.pdf}{al prof fits}{The results of the sliced fits for the 56-220-near unit and data from 21 Sep. Left: fit of the elastic peaks, Right: fit of the diffractive hit distribution. The fit lines use the same color code as in \Fg{al prof hits}. The green points excluded from the fit.}

\TODO{With an interesting precision, the alignment can be done in the horizontal direction only.}

Practically, the profile alignment is used as the step prior to the alignment with elastic tracks. It simplifies the selection of the elastic sample, but the precision is superseded in the next step.

\section[al elast]{Elastic Alignment}

\TODO{Certain statements hold only for the low $\be$ optics.}

One first needs to select a sample of elastic events...

The transport of elastic events can be well described as \TODO{reference}:
\eqref{\eqnarray{
q(s) &= L_q(s) \th_q^* + v_q(s) q^*\ ,& \qquad q = x, y\cr
\th_q \equiv {\d q\over\d s} &= L_q'(s) \th_q^* + v_q'(s) q^*\ ,& \qquad L_q' \equiv {\d L_q\over \d s}\cr
}}{el transport}
Moreover, the vertex terms can be neglected \TODO{reference}. In addition, the optics is rather symmetric \TODO{reference}, that is:
\eqref{L_q(s) \approx L_q(-s),\quad L_q'(s) \approx - L_q'(-s)\ .}{al el sym opt}
Furthermore, the optics is such that the phase advance $\ph$ (see Hill's equation \Eq{hill eq}) at the $220\un{m}$ stations is close to $\pi/2$ in $x$ or $0$ in $y$ \TODO{reference}. This means that $L_x(220)$ almost vanishes, but $L_x'(220)$ is large and vice versa for the vertical projection.

The $q(s)$ gives the true hit position (wrt. the beam), however a detector (i.e. a RP) misaligned by $\De q$ would make a measurement $q'$:
\eqref{q' = q - \De q\ .}{al el misal}

Later on, we will use the relation between the angle $\th_q$ and far-near difference $q_F - q_N$:
\eqref{q_F - q_N = \th_q \, d\ ,}{al FN diff}
where $d$ stands for the distance between far and near RPs (see \Tb{rp station}).

The above considerations will help us find the properties useful for both, elastic event selection and alignment.

First of all, the angles left and right should be highly correlated. We recall that left stands for sector 45 and right for sector 56. Given the phase advance conditions make the angular resolution in $x$ much better, thus will focus on the horizontal projection. Using the far-near difference, one finds:
\eqref{\De_{F-N} x^{56} \approx \underbrace{ {L_x^{56'}\over L_x^{45'}} }_{-1 + a} \De_{F-N} x^{45} + 
\underbrace{ {L_x^{56'}\over L_x^{45'}} (\De x_F^{45} - \De x_N^{45}) - (\De x_F^{56} - \De x_N^{56}) }_{b} \ .
}{al el dxdx}
The small slope correction $a$ arises from small asymmetries in the optics, the intercept $b$ is an effect of the RP misalignments. The relation is, indeed, just an approximations -- this will be discussed later -- but let's remark that the elastic events will be distributed along the above line, see \Fg{al el selection} (cut 1).

When the vertex terms in \Eq{el transport} are negligible, there is a high correlation between the hit position and the track angle -- the hits will cumulate along line
\eqref{\De_{F-N} y \approx
\underbrace{ {L_y^{N'}\, d\over L_y^N} }_a y_N 
+ \underbrace{ {L_y^{N'}\, d\over L_y^N} \De y_N - (\De y_F - \De y_N) }_b \ .
}{al el dyy}

In the above relation, we used the vertical projection, since the resolution in $x$ is poor -- $L_x\approx 0$ follows from the phase advance settings. This fact can also be used for elastic event selection. In \Sc{al prof} we saw that the actual optics gave raise to the tilts ($a$) of the elastic peaks, the axes of which can be described as
\eqref{x \approx ay + \underbrace{a \De y - \De x}_{b}\ .}{al el x} 


\tab[\strut\hfil\ #\ \hfil&\ #\ \hfil&\hfil\ #\ \hfil&\hfil\ #\ \hfil\cr]{al el cuts}{The cuts used for elastic event selection. The threshold gives the maximal permitted distance from the line. The right-most column gives the ratio of the threshold to the RMS of the distance-to-line distribution (see the rhs.~plots in \Fg{al el selection}).}{\ln
cut & line & threshold & num.~of sigmas \cr\ln
1 & $\De_{F-N} x^{56} = (-1+a) \De_{F-N} x^{45} + b$	& $80\un{\mu m}$	& $2.5$ \cr
2 & $\De_{F-N} y = a y_N + b$							& $45\un{\mu m}$	& $2.5$ \cr
3 & $x = ay + b$ 										& $400\un{\mu m}$	& $2.5$ \cr\ln
}

The relations \Eq{al el dxdx,al el dyy,al el x} provide the basis for our elastic selection cuts. All of them can be expressed as ''distance from a line must be smaller than a given threshold.'' The details are summarized in \Tb{al el cuts}. The distribution of events around the cut lines has two sources: the beam smearing and the proton transport approximations that we have made. The distributions have a Gaussian shape as can be seen in \Fg{al el selection} and their RMS values were used to set the cut thresholds -- they roughly correspond to $2.5$ multiple of the RMS.

The $a$ and $b$ cut parameters were determined empirically in several iterations. Starting with the values coming from the ideal optics and no misalignments and with liberal cuts. After a selection, the resulting graphs were fitted and improved values of the cut parameters were obtained.

\fig{fig/pdf/al_el_selection.pdf}{al el selection}{Selection of elastic events (data from 21 Sep). Each row corresponds to a cut. Left: the events before (black) and after (colorful) the cut. The red dots belong to 45 bottom -- 56 top diagonal, the blue to the other one. The lightgreen area represents the cut requirement. Right: the distribution of events around the cut line (black) with a Gaussian fit (red). The dotted lines show the cut thresholds, cf. \Tb{al el cuts}.}

Since the relations \Eq{al el dxdx,al el dyy,al el x} involve the misalignment parameters, they can be used for alignment purposes. In the rest of this section we will present a few alignment methods. The first one is dedicated to the horizontal alignment, methods 2a-c are several attempts for the vertical alignment. As we will see later on, the precision of the absolute vertical alignment will to be fully satisfactory. That is why we will mention also methods 3 and 4, which can resolve certain relative components of the vertical alignment.

\em{Method 1}: vertical fit in $y$ vs.~$x$ plots. According to \Eq{al el x}, the horizontal shift $\De x = a \De y - b$. The $a$ and $b$ parameters are the result of the fit and $\De y$ can be determined from methods 2a-c. NB: the influence of $\De y$ is small because of the tilts $a$ are small (see \Tb{al el yx}). If $\De y$ would be of the order of $100\un{\mu m}$ and would completely neglect it, the error of $\De x$ would be of the order of $4\un{\mu m}$.

The fits were performed with the parameterization \Eq{al el x}. To reduce the impact of any possible outliers, every hit was assigned weight (one of the suggested outlier treatments from \bref{millepede})
\eqref{w = \left\lbrace \matrix{
\strut 1				& \de < c_H \cr
\strut c_H^2\over\de^2	& \de > c_H \cr
}\right.\ ,\qquad c_H = 1.345\ .}{al el fit weight}
Here, $\de$ stands for the ratio of the hit distance to the fit line and the RMS of the distance distribution. We made five fit iterations.

The uncertainty of the fit was determined as from the Least-Squares method \TODO{reference}. As the error input, we assigned the RMS of the cut-line distance as the error of $x$ variable.

An illustration of the method is shown in \Fg{al el plots yx}. Similar illustrations will be shown for all other methods. The left plot will always be done for the data from 5~Oct (a $18\si$ run with low statistics), while the right plot from 29-30~Oct (a $7\si$ run with high statistics).

The \Fg{al el plots yx} shows the top and bottom RP fits (red and blue) are compatible with each other and the global one (green). This means that the shifts of the top and bottoms are the same. This confirms that the track-base alignment, the previous step, worked correctly.

The results are summarized in \Tb{al el yx}.

\fig{fig/pdf/al_el_plots_yx.pdf}{al el plots yx}{Illustration of the alignment method 1 (unit 45-220-far). The red line fits the red points only, similarly for the blue one. The green line represents a global fit.}

{\SmallerFonts
\htab{al el yx}{The results of the elastic alignment method 1 -- vertical fits of y vs.~x data. Slope $a$ in $\rm mrad$, intercept $b$ in $\rm\mu m$.}{
\omit&\multispan8\bhrulefill\cr
\omit&\multispan2\strut\bvrule\hfil 45 near\hfil & \multispan2\vrule\hfil 45 far\hfil  & \multispan2\vrule\hfil 56 near\hfil & \multispan2\vrule\hfil 56 far\hfil\cr
\omit&\multispan8\hrulefill\cr
\omit\strut & a & b & a & b & a & b & a & b\cr\bln
\hbox{21 Sep}    & -35.3 \pm    0.8& -33.4 \pm    3.5& -29.8 \pm    0.7& -46.1 \pm    3.2&  43.5 \pm    0.7& -23.1 \pm    3.4&  38.7 \pm    0.7& -26.3 \pm    3.4\cr\ln
\hbox{05 Oct}    & -36.7 \pm    0.5& -42.9 \pm    4.4& -32.4 \pm    0.5& -36.0 \pm    3.9&  44.0 \pm    0.5& -23.6 \pm    4.4&  38.4 \pm    0.5& -24.4 \pm    4.4\cr\ln
\hbox{07 Oct}    & -37.7 \pm    0.4&   1.9 \pm    3.6& -31.3 \pm    0.4& -11.7 \pm    3.2&  42.7 \pm    0.4& -38.1 \pm    3.5&  39.4 \pm    0.4& -27.2 \pm    3.5\cr\ln
\hbox{24 Oct}    & -37.7 \pm    0.2& -46.2 \pm    2.1& -32.2 \pm    0.2& -34.2 \pm    1.8&  43.8 \pm    0.2& -37.6 \pm    2.0&  39.5 \pm    0.2& -14.8 \pm    2.1\cr\ln
\hbox{26 Oct}    & -37.2 \pm    0.2& -24.3 \pm    1.8& -32.4 \pm    0.2& -20.3 \pm    1.6&  43.9 \pm    0.2& -35.2 \pm    1.7&  38.9 \pm    0.2& -67.5 \pm    1.7\cr\ln
\hbox{29-30 Oct} & -36.4 \pm    0.2& -25.5 \pm    0.7& -31.7 \pm    0.2&  -4.0 \pm    0.7&  44.3 \pm    0.1&  -6.5 \pm    0.7&  38.4 \pm    0.1&  -5.7 \pm    0.7\cr\bln
}}



\em{Method 2a}. The vertical distribution of elastic hits shall be symmetric around the position of the beam. This remains true even if the axis of elastic scattering is tilted with respect to $y$ axis. In this case, the $y$ distribution shrinks, but symmetrically around the beam's position. Hence a way to determine the position of the beam is to fit a symmetric function through the data registered by a top and bottom pot of the same unit. Looking at the data in \Fg{al el plots y full}, a Gaussian fit looks as a plausible choice. 

The results are summarized in \Tb{al el y full}. The quoted errors are statistical only. They do not reflect the fact that we fit tails of the distribution only (data from 5 Oct), neither the deviations from Gaussian shape (data from 29-30 Oct). The latter deficiency will lead us to a fit improvement, see method 2b.


\fig{fig/pdf/al_el_plots_y_full.pdf}{al el plots y full}{Illustration of the alignment method 2a (unit 56-220-far). The violet curve shows a Gaussian fit.}

\htab{al el y full}{The results of the elastic alignment method 2a -- Gaussian fits of $y$ distributions. Values in $\rm \mu m$, uncertainties are statistical only.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -54.3 \pm   18.7&  24.5 \pm   21.9& -61.4 \pm   31.3& -26.1 \pm   31.3\cr\ln
\hbox{05 Oct}    &  72.2 \pm   20.5&  93.0 \pm   35.0& -81.8 \pm   39.6&-214.1 \pm   45.6\cr\ln
\hbox{07 Oct}    &  42.6 \pm   16.8&  85.6 \pm   24.0& -48.7 \pm   28.6& -76.6 \pm   30.7\cr\ln
\hbox{24 Oct}    & -88.4 \pm   12.9& -20.4 \pm   15.5&  39.5 \pm   29.2&   8.7 \pm   38.4\cr\ln
\hbox{26 Oct}    &  91.8 \pm    9.9& 160.1 \pm   10.8&-248.2 \pm   22.1&-217.5 \pm   23.8\cr\ln
\hbox{29-30 Oct} &  12.4 \pm   11.0&  99.9 \pm   10.4& -36.7 \pm   13.3& -32.9 \pm   14.1\cr\bln
}



\em{Method 2b}. In the previous method we fitted the $y$ distributions with a Gaussian, without any justification. In fact, one may expect an (approximately) Gaussian shape for for sufficiently small $|y|$. Here is the reason. $y$ is (approximately) proportional to $\th_y$ and that is proportional to $\th_y^*$ and$\th_y^*$ is normally distributed as far as $\d\si/\d t$ falls off exponentially. This is (approximately) true for $|t|$ below the elastic dip. Actually, the ''elastic dip structures'' can be seen in \Fg{al el plots y gauss} right as the bumps on the tails. Hence one should restrain the Gaussian fit to the data below the elastic dip. In terms of $y$, the limit is $\approx 4.2\un{mm}$ (see the dotted lines in the figure).

For the case of 29-30 Oct, the fit quality improved significantly. For 5 Oct there is no fit, since there are no data in the ''Gaussian'' region, the RPs were not close enough. Unfortunately, this is the case for most data-takings. \Tb{al el y gauss} summarizes the results for the two data-takings where we could apply this method.

The results of methods 2a and 2b (\Tb{al el y full,al el y gauss}) compare surprisingly well. The differences fall below the error estimate (with the only exception of the shift of 56-220-far for the data from 29-30 Oct).

\fig{fig/pdf/al_el_plots_y_gauss.pdf}{al el plots y gauss}{Illustration of the alignment method 2b (unit 56-220-far). The violet curve shows a Gaussian fit through the data in the fit region (delimited by the vertical dotted lines). The selected data points are marked in green. There are no data and no fit in the left plot.}

\htab{al el y gauss}{The results of the elastic alignment method 2b -- Gaussian fits of $y$ distributions, low $|y|$ regions only. Values in $\rm \mu m$, uncertainties are statistical only.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -56.3 \pm   10.5&  30.0 \pm   16.3& -62.2 \pm   25.3& -25.0 \pm   30.8\cr\ln
\hbox{29-30 Oct} &   8.6 \pm    7.6&  89.5 \pm    8.5& -18.8 \pm   10.8&  -2.5 \pm   15.0\cr\bln
}

\bmfig
\vbox{\hsize9cm\noindent\leftskip0pt\rightskip0pt\parfillskip0pt plus1fil
\em{Method 2c}. Another approach to mitigate the deficiency of the method 2a is to remove the Gaussian-shape assumption. The only assumption would be that the $y$ distributions measured from the top and bottom pots are parts (cut by acceptance) of the same distribution. One can flip the $y$ distribution from the bottom pot (blue in \Fg{al el shift test}) and shift it such that it matches to the distribution from the top pot (red). When the best match is found, the position of the beam is given
$${f_B + f_T + s\over 2}\ ,$$
where $f_B$ is the position of the highest bottom pot bin, $f_T$ the lowest top pot bin and $s$ the shift of the blue histogram (left edge) wrt. the red one. Indeed, $s$ can only by a multiple of the bin size. The best match is the one which gives the lowest value of
}%
\fig{fig/pdf/al_el_shift_test.pdf}{al el shift test}{[]To the explanation of the shift test}%
\emfig

\eqref{S^2/N = {1\over N} \sum_{i\ \in \hbox{overlapping bins}} \left( C_{\rm red}(i) - C_{\rm blue}(i) \right)^2\ ,}{al el shift test}
where $N$ is the number of overlapping bins and $C_{\rm red}(i)$ represents the contents of the bin $i$ of the red histogram.


As measure of uncertainty, one may take a half of the bin size. Of course, this does not reflect systematic errors that may appear because incompatible distributions from the top and bottom RP. An example of this incompatibility can be seen in \Fg{al el plots y shift} left. For the right plot, it is less pronounced, but still present. The differences in shape may come from different acceptances, trigger, detector and reconstruction efficiencies etc. For a fine alignment one would need to correct for all these effects.

The results are summarized in \Tb{al el y shift}. Comparing these to the method 2a (\Tb{al el y full}), one finds differences with RMS of roughly $30\un{\mu m}$, that is well below the estimated uncertainty.

\fig{fig/pdf/al_el_plots_y_shift.pdf}{al el plots y shift}{Illustration of the alignment method 2c (unit 56-220-far). The $y$ distribution from the bottom pot (blue) has been shifted to match the best to the distribution from the top pot (red).}

\htab{al el y shift}{The results of the elastic alignment method 2c -- shift matching the $y$ distributions from the top and bottom pot. All values in $\rm \mu m$. The ucertainty can be estimated as a half of the bin size. That is $25\un{\mu m}$ for 26 and 29-30 Oct and $50\un{\mu m}$ for the others.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -50.0&   0.0&-100.0&   0.0\cr\ln
\hbox{05 Oct}    & 150.0& 150.0& -50.0&-200.0\cr\ln
\hbox{07 Oct}    & 100.0& 150.0& -50.0& -50.0\cr\ln
\hbox{24 Oct}    &-100.0&   0.0&  50.0&  50.0\cr\ln
\hbox{26 Oct}    & 100.0& 200.0&-200.0&-200.0\cr\ln
\hbox{29-30 Oct} &   0.0& 100.0& -50.0& -50.0\cr\bln
}


\em{Method 3} is based on \Eq{al el dyy}. The slopes $a$ turn out to be of the order of $20\un{mrad}$ (see \Fg{al el plots dyy}) hence neglecting the middle term would create an error of $\approx 2\un{\mu m}$, assuming $\De y_n$ is of the order of $100\un{\mu m}$. The $2\un{\mu m}$ are a negligible error compared to the corrections one may get with this method. Thus, we will use
$$b = \De y_F - \De y_N\ .$$
In other words, the intercept gives the relative far-near vertical misalignment.

The fits are performed in a similar manner as in method 1, with the difference that the RMS of distance-to-cut-line distribution is attributed to $\De_{F-N} y$ quantity. An example of the fits is shown if \Fg{al el plots dyy}. Again the one-side fits are compatible with each other and the global fit (with the exception of the red fit in the left-hand side plot). This means that the far-near misalignments are the same for top and bottom pots, a result that is expected after a track-based alignment step.

\Tb{al el dyy} summarizes the results (left part) and provides a comparison to method 2a (right part) -- the $\De y$ results from \Tb{al el y full} were used to predict the intercepts. With the exception of the sector 56 measurement from 5 Oct data, all the differences lie below the estimated error.

\fig{fig/pdf/al_el_plots_dyy.pdf}{al el plots dyy}{Illustration of the alignment method 3 (sector 45). The red line fits the red points only (top pots), blue line blue points (bottom pot). The green line represents a global fit.}

\bgroup
\def\ln{\multispan3\hrulefill&&\multispan2\hrulefill\cr}
\def\bln{\multispan3\bhrulefill&&\multispan2\bhrulefill\cr}
\htab{al el dyy}{Left: the results of the elastic alignment method 3 -- intercepts of $\De_{F-N} y$ vs.~$y$ data fits. Right: a comparison to method 2a (\Tb{al el y full}).}{
\omit&\multispan2\bhrulefill&&\multispan2\bhrulefill\cr
\omit&\strut\hbox{sector 45}&\hbox{sector 56}&&\hbox{sector 45}&\hbox{sector 56}\cr\bln
\hbox{21 Sep}    &  69.3 \pm    0.7&  37.9 \pm    0.7 & \hskip1mm & -10 \pm 29 & -3   \pm 44\cr\ln
\hbox{05 Oct}    &  70.4 \pm    0.8&  12.8 \pm    1.3 & \hskip1mm & 50  \pm 41 & -145 \pm 60\cr\ln
\hbox{07 Oct}    &  72.0 \pm    0.9&   6.0 \pm    1.0 & \hskip1mm & 29  \pm 29 & -34  \pm 42\cr\ln
\hbox{24 Oct}    &  86.8 \pm    0.4&  -1.4 \pm    0.6 & \hskip1mm & 19  \pm 20 & -29  \pm 48\cr\ln
\hbox{26 Oct}    &  79.6 \pm    0.5&  -7.9 \pm    0.6 & \hskip1mm & 11  \pm 15 & 39   \pm 32\cr\ln
\hbox{29-30 Oct} &  79.6 \pm    0.2&  -1.1 \pm    0.2 & \hskip1mm & -8  \pm 15 & 5    \pm 19\cr\bln
}
\egroup



\em{Method 4}. The correlation between $y$ hit positions left and right can be written (follows from \Eq{el transport}):
\eqref{y^{56} =
\underbrace{ {L_y^{56}\over L_y^{45}} }_{-1+a}  y^{45}
+ \underbrace{ {L_y^{56}\over L_y^{45}} \De y^{45} - \De y^{56} }_b
}{al el yy}

\TODO{Method 4 does not compare well to the method 2a, but it is consistent with method 3.}

\fig{fig/pdf/al_el_plots_ylyr.pdf}{al el plots ylyr}{Illustration of the alignment method 4 (far units). The red line fits the red points only (diagonal 45 top -- 56 bottom), blue line blue points (diagonal 45 bottom -- 56 top). The green line represents a global fit. The dark points have been cut off not to bias the fit because of the asymmetric acceptance.}

\bgroup
\def\ln{\multispan3\hrulefill&&\multispan2\hrulefill\cr}
\def\bln{\multispan3\bhrulefill&&\multispan2\bhrulefill\cr}
\htab{al el ylyr}{
Left: the results of the elastic alignment method 4 -- fits of $y^{56}$ vs.~$y^{45}$ data. Right: a comparison to method 2a (\Tb{al el y full}).
}{
\omit&\multispan2\bhrulefill&&\multispan2\bhrulefill\cr
\omit&\strut\hbox{near units}&\hbox{far units}&&\hbox{near units}&\hbox{far units}\cr\bln
\hbox{21 Sep}    & -40.4 \pm   21.3&  78.6 \pm   21.4 & \hskip1mm & 75   \pm 42 & 80   \pm 44\cr\ln
\hbox{05 Oct}    & 170.8 \pm   26.3& 264.5 \pm   28.6 & \hskip1mm & 180  \pm 52 & 386  \pm 64\cr\ln
\hbox{07 Oct}    &  95.4 \pm   20.2& 181.9 \pm   21.8 & \hskip1mm & 102  \pm 39 & 173  \pm 45\cr\ln
\hbox{24 Oct}    & -75.8 \pm   10.7&  15.3 \pm   11.4 & \hskip1mm & -27  \pm 34 & 27   \pm 43\cr\ln
\hbox{26 Oct}    &  19.5 \pm    9.1&  98.6 \pm    9.9 & \hskip1mm & 176  \pm 26 & 156  \pm 28\cr\ln
\hbox{29-30 Oct} &-240.9 \pm    4.9&-158.3 \pm    4.9 & \hskip1mm & -217 \pm 18 & -225 \pm 18\cr\bln
}
\egroup


\TODO{A summary -- how shall the beam position be determined for each data-taking. 21 Sep and 29-30 Oct using 2b, what for the others?}

\iffalse
RP position corrections (only dy vs. y data used)								
	45 near		45 far		56 near		56 far	
	x	y	x	y	x	y	x	y
2010_09_21	-33	0	-48	69	-23	0	-25	38
2010_10_05	-43	0	-38	70	-24	0	-24	13
2010_10_07	2	0	-14	72	-38	0	-27	6
2010_10_24	-46	0	-37	87	-38	0	-15	-1
2010_10_26	-24	0	-23	80	-35	0	-68	-8
2010_10_29-30	-26	0	-7	80	-7	0	-6	-1
								
								
RP position corrections (y distributions data used)								
	45 near		45 far		56 near		56 far	
	x	y	x	y	x	y	x	y
2010_09_21	-31	-54	-47	25	-26	-61	-27	-26
2010_10_05	-46	72	-39	93	-27	-82	-33	-214
2010_10_07	0	43	-14	86	-40	-49	-30	-77
2010_10_24	-43	-88	-34	-20	-36	40	-14	9
2010_10_26	-28	92	-25	160	-46	-248	-76	-218
2010_10_29-30	-26	12	-7	100	-8	-37	-7	-33
\fi


\section[al sum]{Summary}

\> tasks accomplished/non-accomplished
\>> TBA left 4 shift and 4 rotation modes unresolved
\>> Elastic/profile methods fixed the 4 shift modes
\>> From Optical alignment there is no indication of U-V rotation.
\>> Once optics is known better, the far-near rotation could be determined from the shift of the elastic peaks.

\> final uncertainty
\>> internal shifts and rotations
\>> inter-RP shifts and rotations
\>> x al. wrt beam
\>> y al. far-near
\>> y al. absolute wrt beam

\> error impact on the physics reconstruction (of elastic $t$)
\>> errors and unresolved modes
