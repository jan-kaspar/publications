\chapter[alignment]{Alignment of Roman Pots}

MOTIVATION: An accurate alignment is of major importance for the TOTEM experiment in order to deliver precise measurements. Among the subdetectors of TOTEM, the alignment of the RPs presents the biggest challenge since they are movable. The importance of alignment is most pronounced at the $\be^* = 1535\un{m}$ optics, where the beam divergence (the dominant smearing effect) is rather low and hence the impact of any misalignment has a large relevance. To give a feeling, a $100\un{\mu m}$ displacement of a vertical RP would lead to angular shift of about $0.4\un{\mu rad}$ (based on an effective length $L_y\approx 270\un{m}$, typical for this optics). This is to be compared to the spread of the beam divergence $0.3\un{\mu rad}$.

\TODO{experience from other experiments}

WHAT WE ALIGN, WRT WHAT:
What is important is the relative position between RP sensors (the other parts do not matter much) and the beam. Hence there are two players in the game -- RP positions and beam positions.

\section[alignment procedure]{Alignment procedure}
The procedure has two steps. First, move the pots to the desired position as precisely as possible. Then take data, analyze them and find what error has been done in the first step.

The first step relies mainly on two types devices -- RP motor control and Beam Position Monitors (BPMs). Both are calibrated to determine position of outer edge of the window or the beam with respect to the ideal beam-pipe center.

For the second step, a number of methods is available. Undoubtedly, one of the most powerful ones is the track-based alignment. It uses the tracks passing through the overlap between vertical and horizontal RPs and is, hence, capable of determining the relative position between the pots. Its strength is underlined by the fact that it is based on a single assumption: tracks are straight lines. To determine the position of the beam, other methods must be used. One may profit from know symmetries of certain physics processes. Here, the analysis becomes delicate because in the observables the properties of the processes are mixed with the properties of the optics. This gives a certain superiority to elastic scattering. This process is often easy to separate and hence can provide a clean sample, as the first argument. As the second one, it comprises two protons exactly in the opposite direction and can thus be used for the alignment of the opposite arms of the experiment. Yet another advantage the protons have, by definition, zero momentum-loss and therefore, the dependence on the optics is largely reduced.

Reference to \sref{expected misalignments}.
As it follows from \Sc{rp measurement}, only the rotation around $z$ axis is relevant.

\section[expected misalignments]{Expected misalignments}

Let's first asses what may go wrong and what are the corresponding misalignment estimates.

\noindent\em{Internal misalignments} arise from finite precision of fixing the detectors within a package. The precision is estimated to be
\eqref{20\un{\mu m}\ .}{internal misalignment shift}
This also gives estimate about the rotation
\eqref{\De\rh \approx {2\cdot 20\un{\mu m}\over 4\un{cm}} = 1\un{mrad}\ .}{internal misalignment rotation}

\noindent\em{Errors in RP positions}
\> z shifts
\> errors in RP motor control $~20\un{\mu m}$
\> RP frame deformation ???

\noindent\em{Errors in optical functions} are also sort of misalignments -- global alignment

\htab{expected misalignments}{Expected misalignments orders. \TODO{}}{\bln
	& \hbox{within RP package} & \hbox{Roman Pot} \cr\bln
\hbox{transverse shift} \un{\mu m}& & \cr\ln
\hbox{shift in }z & & \cr\ln
\hbox{rotation around }z & & \cr\bln
}

\section{Collimation alignment}

PUT THIS TO INTRODUCTION? In principle both \abb{BPM}s and \abb{RP} motor controls should have been calibrated such that they give the position of beam/RP edge with respect to the beam-pipe center. However, a cross-check is always good. Moreover, this exercise was needed for the alignment against the system of the LHC collimators.

In the beginning, the collimators scrape the beam such that its edge is sharp and its size and center is well defined. Then a RP is approached to the beam, until it touches the sharp edge. In this moment, particles from the beam edge are scattered of the RP edge and they give raise to peaks in the BLMs downstream (see \Fg{collimation alignment example} bottom). In this moment, the RP edge is at the same beam-sigma-distance as the collimators.

With the vertical RPs we can make use of the fact that we have 2 jaws and determine the beam-sigma (in millimeters) and the beam-center. Suppose that we have touched the beam with the top RP. In that moment, the RP became the primary collimator and scraped the beam a bit. Due to the multi-turn effect, the beam was scraped symmetrically about the vertical center of the beam. Then, one can approach the bottom pot, again until a BLM peak appears. Then, both RPs are at the same distance from the vertical beam-center and the distance corresponds to one beam-sigma (up to the step-size, indeed). These steps can be repeated in order to improve the precision of the beam-center determination. An example of this procedure can be found in \Fg{collimation alignment example}.

\fig{fig/pdf/CollimationAlignmentExample.pdf}{collimation alignment example}{An example of collimation alignment data from 29 November 2009 (sector 56, near unit). The top and bottom pot movements (up) induced the BLM signals (bottom).}

The precision is obviously given by the step size. Mostly because of the limited time resolution one cannot determine when during the movement the beam was touched. One should, thus, aim at as little steps as possible. On the other hand, the smaller step, the less scraping and the lower peak in the BLM signal. If the step is too small, the induced beam loss can not be distinguished from the noise. We observed a step of $50\un{\mu m}$ to be on the practical limit.

So far, the collimation alignment has been repeated three times: 29 November 2009, 25 June 2010 (both at $450\un{GeV}$) and 29 September 2010 at $3.5\un{TeV}$. The results suggest an unfortunate conclusion -- both RP LVDTs and BPMs seemed wrongly calibrated. For an immediate indiation, let's look back to \Fg{collimation alignment example}. Assuming the the beam was touched in the middle of the movement, one obtains the beam center at $(313\pm 63)\un{\mu m}$ according to the LVDTs. However, the corresponding BPM claimed the beam to be at $(-550\pm50)\un{\mu m}$. The discrepancy is evident, what is not clear is, however, which device to blame. A valuable hint was provided later by the track-based alignment method. The results contained large per-RP shifts, moreover almost run independent. This suggested that the LVDTs do not have a common origin, in other words, every LVDT reading shall be corrected by an offset. 

These offsets can be determined with the collimation alignment -- the principle is shown in \Fg{collimation alignment}. The beam size at the collimator location ($n\si_0$) is known and can be propagated to the RP location, thus $n\si$ is known too. $t$ and $b$ are the top and bottom LVDT readings. The offsets then follow:
\eqref{o_t = n\si - t,\qquad o_b = -n\si - b\ .}{LVDT offsets}
Note that the offsets are determined with respect to the beam center (not the beam-pipe center), which 


\fig{fig/pdf/collimationAlignment.pdf}{collimation alignment}{How to determine LVDT offsets with collimation alignment. The beam is drawn in blue, its envelope with solid and its ceter with dashdotted line. The origins of the LVDT scales are marked with red dots.}

\section{Track--based alignment}

\TODO{few notes about the implementation in OfflineSW}

In \Sc{rp measurement}, the relation between a proton kinematics and RP detector measurement has been derived -- see \Eq{xlyl i approximated}. In principle, all geometry parameters (the situation is depicted in \Fg{detector geometry}) may be subjects to misalignments. Using primes (no primes) for misaligned (ideal) quantities, this might be described as
\eqref{\eqnarray{
z' &=& z + \De z\cr
\vec c' &=& \vec c + \De\vec c\cr
}}{misalignment definition}
(The z component of the $\vec c$ vector will be denoted simply as $z$ from now on, while $\vec c$ will refer to the two-component vector $(c_x, c_y)^\T$). The $\rh_z$ already refers to misalignment. In this regard, we will change the notation
\eqref{\rh_z \rightarrow \De\rh}{misalignment definition 2}
(the $z$ subscript will be dropped as it is the only rotation in our picture from now on).

With the new notation, one can write
\eqref{
\vec d^\T \pmatrix{1 & \De\rh\cr -\De\rh & 1} =
\vec d + \De\rh \underbrace{\pmatrix{-d_y\cr d_x}}_{\vec d_\perp}\ .
}{d perp definition}

\fig{fig/pdf/detector_geometry.pdf}{detector geometry}{The detector geometry. A sample hit is drawn as the blue dot, the corresponding measurement is visualized as the thick solid blue line.}

To summarize, the measurement of the $n$-th event in the $i$-th detector is
\eqref{
m_i^n = (\vec d_i + \De\rh_i\,\vec d_{\perp i})^\T \left[\vec a^n (z_i + \De z_i) + \vec b^n - (\vec c_i + \De\vec c_i)\right] + \De m_i^n\ ,
}{n i measurement}
where the last term includes the errors introduced by various approximations and by neglecting the ``rounding'' step. It will be treated as an error in what follows. One can rearrange the terms in the last equation
\eqref{\eqnarray{
\mu_i^n \equiv m_i^n - \vec d^\T \vec c = & &\cr
& +\vec d_i^\T (\vec a^n z_i + \vec b^n)&\qquad 10^{-2}\un{m}\cr
& -\vec d_i^\T \De\vec c_i&\qquad 10^{-5}\un{m}\cr
& +\vec d_i^\T \vec a^n \De z_i&\qquad 10^{-??}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i) &\qquad 10^{-5}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n \De z_i - \De\vec c_i) &\qquad 10^{-8}\un{m} \cr
}}{effective measurement}
The order estimates on the \rhs{} follow from \Tb{expected misalignments} and \Eq{z i order estimates}. It is clear that the last term can be neglected with respect to the others and hence we will do so. It is very advantageous since this is the only term non-linear in misalignments. 

The first term on the \rhs{} of \Eq{effective measurement} accounts for the measurement of a track by a perfectly aligned detector, the other terms then constitute alignment corrections. Since these corrections are linear in misalignments, one can write
\eqref{\mu_i^n =
\underbrace{\vec d_i^\T (\vec a^n z_i + \vec b^n)}_{\hbox{track}}
+
\underbrace{\sum_j \ga_{j, i}^n \ch_{j, i}}_{\hbox{alignment corrections}}
\ ,}{effective measurement 2}
introducing symbol $\ch_{j, i}$ for any misalignment. The mapping between the index $j$ and misalignment type can be found in \Tb{alignment quantities}.

\htab{alignment quantities}{Alignment quantities and their coefficients.}{\bln
j & \hbox{quantity} & \ch_{j, i}					& \ga_{j, i}^n\cr\bln
1 & \hbox{shift in read-out direction} & \De s_i \equiv \vec d_i^\T \De\vec c_i		& -1\cr\ln
2 & \hbox{shift in }z & \De z_i						& \vec d_i^\T \vec a^n  \cr\ln
3 & \hbox{rotation around}z & \De\rh_i					& \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i)\cr\bln
}

\Eq{effective measurement 2} can written for all events in a compact form using matrix formalism. Let's put all measurements to a vector
\eqref{\vec M = (\mu^1_1 \ldots, \mu^2_1, \ldots)^\T\ .}{vector M}
The vector of parameters $\vec P$ has two parts, first the track parameters for all events, second the alignment parameters for all detectors
\eqref{\vec P = (a_x^1, a_y^1, b_x^1, b_y^1, a_x^2, \ldots || \ch_{1, 1}\ldots \ch_{1, D}, \ch_{2, 1}\dots \ch_{2, D}, \ldots)^\T}{vector P}
Then, \Eq{effective measurement 2} reads
\eqref{\vec M = \mat A \vec P\ ,}{effective measurement all}
where
\eqref{\mat A = \pmatrix{
\al^1 & 		&		&\vrule	&\Ga_1^1	&\cdots	&\Ga_G^1	\cr
	& \al^2	&		&\vrule	&\vdots		&		&\vdots		\cr
	&		& \ddots&\vrule	&\Ga_1^N	&\cdots	&\Ga_G^N	\cr
}}{mat A}
and
\eqref{\mat \al^n = \pmatrix{
\vdots & \vdots & \vdots & \vdots \cr
d_{ix} z_i & d_{iy} z_i & d_{ix} & d_{iy} \cr
\vdots & \vdots & \vdots & \vdots \cr
}, \quad \hbox{for all detectors involved in }n\hbox{-th event}}{mat alpha}
and
\eqref{\Ga_i^n = {\rm diag}\,\left(\ga_{i, 1}^n, \ldots, \ga_{i, D}^n \right)\ .}{mat Gamma}
\TODO{Gamma is of dimension Dn x D !!!}

\TODO{$N$ events, $D$ detectors, $D_n$ detectors active in $n$-th event, $G$ misalignment classes, $\vec\mu^n = (\mu^n_1, \ldots, \mu_{D_n}^n)^\T$}

\eqref{\vec\mu^n =
\underbrace{\mat\al^n \vec\ta}_{\hbox{track}}
+
\underbrace{\sum_j \mat\Ga_j^n \vec \ch_j}_{\hbox{misalignments}}
\ ,}{todo1}

\eqref{\vec P = (\vec\ta^1, \vec\ta^2, \ldots || \vec\ch_1, \vec\ch_2, \ldots)^\T}{todo2}



\subsection{Simultaneous fit of track and alignment parameters}

This idea was first implemented in Millepede (see \bref{millepede}). Here we use different notation as this work as been done independently.

Now we would like to estimate parameters $\vec P$ based on the measurements $\vec M$. For that, we can use the Least Squares method \TODO{reference}, which gives the following prescription:
\eqref{\hat\vec P = (\mat A^\T \mat V^{-1} \mat A)^{-1} \mat A^\T \mat V^{-1}\,\vec M\.}{P estimate exact}
(The hat in $\hat\vec P$ is to emphasize it is an estimate.) The $\mat V$ matrix, is the correlation matrix for the measurements $\vec M$.

The $\mat\Ga$ matrices (contained in $\mat A$ matrix) include track parameters which are unknown at the fit time. Instead, one can use track parameter estimates obtained via model where all misalignments are neglected. This is basically using $\mat \al^n$ as fit matrix for data $\vec \mu^n$. Let's denote gamma and A matrices obtained in this way as $\tilde\mat\Ga$ and $\tilde\mat A$:
\eqref{\vec\ta \rightarrow \hat\vec\ta: \quad \mat\Ga \rightarrow \tilde\mat\Ga, \mat A \rightarrow \tilde\mat A}{tau linearization}
 One can then use
\eqref{\hat\vec P = (\tilde\mat A^\T \mat V^{-1} \tilde\mat A)^{-1} \tilde\mat A^\T \mat V^{-1}\,\vec M\ .}{P estimate}

The \rhs expression will be evaluated now bit by bit, keeping in mind one is mainly interested in the $\ch$ parameters (i.e. the bottom part of $\hat\vec P$ vector).
\eqref{\mat A^\T \mat V^{-1}\mat A = \pmatrix{
{\mat\al^1}^\T \mat V^{1^{-1}}\mat\al^1	&		&						&\vrule	&{\mat\al^1}^\T \mat V^{1^{-1}} \mat\Ga_1^1	&\cdots	&{\mat\al^1}^\T \mat V^{1^{-1}} \mat\Ga_G^1	\cr
					&\ddots	&						&\vrule	&\vdots					&		&\vdots					\cr
					&		&{\mat\al^N}^\T \mat V^{N^{-1}}\mat\al^N		&\vrule	&{\mat\al^N}^\T \mat V^{N^{-1}}\mat\Ga_1^N	&\cdots	&{\mat\al^N}^\T \mat V^{N^{-1}} \mat\Ga_G^N	\cr
\noalign{\hrule}
{\mat\Ga_1^1}^\T \mat V^{1^{-1}} \mat\al	&\cdots	&{\mat\Ga_1^N}^\T \mat V^{1^{-1}} \mat\al	&\vrule	&\sum_n {\Ga_1^n}^\T \mat V^{1^{-1}} \Ga_1^n	&\cdots	&\sum_n {\Ga_1^n}^\T \mat V^{1^{-1}} \Ga_G^n	\cr
\vdots				&		&\vdots					&\vrule	&\vdots					&		&\vdots					\cr
{\mat\Ga_G^1}^\T \mat V^{N^{-1}}\mat\al	&\cdots	&{\mat\Ga_G^N}^\T \mat V^{N^{-1}} \mat\al	&\vrule	&\sum_n {\Ga_G^n}^\T \mat V^{N^{-1}} \Ga_1^n	&\cdots	&\sum_n {\Ga_G^n}^\T \mat V^{N^{-1}}\Ga_G^n	\cr
}\ .}{mat ATA}
This matrix can be inverted (\TODO{provided ...}) with the use of the following identity for block matrices (taken from \bref{wikipedia} keyword \em{matrix inverse}): 
\eqref{\pmatrix{
\mat A	&\strut\vrule	&\mat B	\cr
\noalign{\hrule}
\mat C	&\strut\vrule	&\mat D\cr
}^{-1} = \pmatrix{
\ldots							&\strut\vrule	&\ldots\cr
\noalign{\hrule}
-\mat S^{-1}\mat C\mat A^{-1}	&\strut\vrule	& \mat S^{-1}\cr
},\qquad \mat S = \mat D - \mat C\mat A^{-1}\mat B\ .}{BlockInverse}
(The upper row was skipped as it will not be needed to estimate $\ch$ parameters.) After some algebra manipulations, matrix $\mat S$ can be written
\eqref{\tilde\mat S = \pmatrix{
\sum_n {\tilde\mat\Ga}_1^{n^\T} \mat\si^n {\tilde\mat\Ga}_1^n	&\cdots	&\sum_n {\tilde\mat\Ga}_1^{n^\T} \mat\si^n {\tilde\mat\Ga}_G^n	\cr
\vdots								&		&\vdots									\cr
\sum_n {\tilde\mat\Ga}_G^{n^\T} \mat\si^n {\tilde\mat\Ga}_1^n	&\cdots	&\sum_n {\tilde\mat\Ga}_G^{n^\T} \mat\si^n {\tilde\mat\Ga}_G^n	\cr
}\ ,}{mat S}
where we used
\eqref{\mat\si^n = \mat V^{n^{-1}} - \mat V^{n^{-1}} \mat\al^n({\mat\al^n}^\T \mat V^{n^{-1}} \mat\al^n)^{-1} \mat {\mat\al^n}^\T V^{n^{-1}}\ .}{sigma n}

The second bit needed for \Eq{P estimate} is
\eqref{\mat A^\T \mat V^{-1}\,\vec M = \pmatrix{
{\mat\al^1}^\T \mat V^{1^{-1}} \,\vec \mu^1\cr
\vdots\cr
{\mat\al^n}^\T \mat V^{N^{-1}} \,\vec \mu^N\strut\cr
\ln
\sum_n\mat{\Ga_1^n}^\T \mat V^{n^{-1}} \, \vec \mu^n\vrule width0pt height15pt\cr
\vdots\cr
\sum_n\mat{\Ga_G^n}^\T \mat V^{n^{-1}} \, \vec \mu^n\cr
}\ .}{vec ATm}
Finally, the $\ch$ parameters (the bottom part of $\hat\vec P$ vector) can be determined from
\eqref{\hat\vec\ch = \mat S^{-1}\,\pmatrix{
\sum_n {\mat\Ga_1^n}^\T\mat\,\mat\si^n\,\vec \mu^n\cr
\vdots\cr
\sum_n {\mat\Ga_G^n}^\T\mat\,\mat\si^n\,\vec \mu^n\cr
}\ .}{chi estimate}

In fact, the elements of $\mat\si^n\,\vec \mu^n$ vector are residuals for the $n$-track divided by the corresponding measurement uncertainty. We will call this ratio \em{normalized} residuals and denote $\vec r^n$. The full residuals will be denoted by $\vec R^n$:

\eqref{\mat\si^n\,\vec \mu^n \equiv \vec r^n = \mat V^{n^{-1}} \vec R^n\ .}{vec R}

It is worth mentioning some properties of the $\mat\si^n$ matrix. It is symmetric
\eqref{\mat\si^{n^\T} = \mat\si^n\ ,}{sigma n symmetric}
it is idempotent
\eqref{\mat\si^n \mat\si^n = \mat\si^n}{sigma n idempotent}
and it is singular
\eqref{\mat\si^{n^\T} \mat\al^n = 0\ .}{sigma n singular}

Since $\mat\si^n$ is singular (and so $\mat S$ might be \TODO{...}), one had better write
\eqref{\tilde \mat S\, \hat\vec\ch = \tilde \vec T, \qquad 
\tilde\vec T = \pmatrix{
\sum_n {\tilde\mat\Ga}_1^{n^\T} \,\vec r^n\cr
\vdots\cr
\sum_n {\tilde\mat\Ga}_G^{n^\T} \,\vec r^n\cr
}\ .}{fit equation}

\TODO{Overview of the approximations:
\> linearization of rotation matrix (and cosine correction)
\> linearization of gamma coefficients (external fitter)
}


\subsection[fit equation]{Justification of the alignment equation}

As we will show in the following, the $\mat S$ matrix is singular and therefore the identity \Eq{BlockInverse} cannot be used. Thus, it is important to justify the validity of the final result \Eq{fit equation}. By plugging \Eq{vec R,todo1} to the definition of $\tilde\vec T$ in \Eq{fit equation} one obtains
\eqref{\tilde\vec T =
\pmatrix{
\vdots \cr
\sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \vec\mu^n\cr
\vdots \cr
}
=
\pmatrix{
\ddots & & \udots \cr
 & \sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \mat\Ga_i^n\cr
\udots & & \ddots \cr
}
\pmatrix{\vdots \cr {\vec\ch_{\rm a}}_i \cr \vdots}
=
\bar\mat S \vec\ch_{\rm a}
}{exact fit equation}
(the a subscript in $\vec\ch_{\rm a}$ is to emphasize the we mean the actual misalignments). This is close to \Eq{fit equation}, but not completely equivalent. The difference is that $\tilde\mat S$ contains both $\mat\Ga$ matrices with tildes. This difference represents the error we make by the linearization step \Eq{tau linearization}. Since the expected misalignments are small, the difference between $\mat\Ga$ and $\tilde\mat\Ga$ are small too and it is reasonable to expect that the solution of \Eq{fit equation} would be close to the actual misalignments $\vec\ch_a$. The error can be reduced by taking several iterations \TODO{...}. Note that this problem is not present if only shifts in the read-out direction are considered. The corresponding $\mat\Ga$ matrices are independent of track parameters and therefore there is no difference between tilded and non-tilded versions.

\subsection{Singular and weak modes}

It is clear that not all $\ch$ parameters can be determined by the track-based alignment. It is a consequence of the fact that measurements enter the fit equation \Eq{fit equation} in the form of residuals. That means that misalignment modes that can be compensated by track-parameters variation, cannot be revealed. These misalignment modes manifest themselves as eigenvectors of the $\mat S$ matrix with zero eigenvalue. This makes $\mat S$ singular and the naive, matrix-inversion solution \Eq{chi estimate} is not possible. For this reason we will refer to such misalignment modes as \em{singular modes}.

\TODO{Define weak mode.}

\TODO{This is for the exact fit equation, for the real one, the singular modes are "almost" singular modes.}

Let's prove the statements above. Imagine that one could change misalignments $\vec\ch_j$ and track parameters $\vec\ta^n$ such that all measurments $\vec\mu^n$ in all events $n$ would remain unchanged. That is
\eqref{\vec\ch_j \rightarrow \vec\ch_j',\quad \vec\ta^n \rightarrow {\vec\ta'}^n(\vec\ta^n, \vec\ch_j, \vec\ch_j') : \quad \vec\mu^n \rightarrow {\vec\mu'}^n = \vec\mu^n\ .}{track-parameter compensation}
From \Eq{todo1} it follows
\eqref{\sum_j \mat\Ga_j^n (\vec\ch_j' - \vec\ch_j) = \mat \al^n (\vec\ta^n - {\vec\ta'}^n) }{aux1}
and thus
\eqref{
\mat S \pmatrix{\vdots\cr \vec\ch_i' - \vec\ch_i\cr\vdots} = 
\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \sum_j \Ga_j^n (\vec\ch_j' - \vec\ch_j) \cr\vdots} =
\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \mat \al^n (\vec\ta^n - {\vec\ta'}^n) \cr\vdots} = 0\ ,
}{equivalence singular mode track parameter variation}
which is a direct consequence of $\mat\si^n \al^n = 0$.

Now, let's explore what are the singular modes that we have to face. This will done it two steps -- first for an arbitrary detector geometry and second for the actual case of TOTEM Roman Pots, where only two read-out directions are used.

\TODO{there can be at most 4 singular modes per misalignment class. Prove it!}

\ssubsection{Singular modes for any geometry}

In this section we will discuss what the singular modes are when no assumptions about the geometry are made. That will be performed for all misalignment classes as listed in \Tb{alignment quantities}.

\em{Shifts in readout direction}. Let's try to find a variation of track parameters $\vec a^n$ and $\vec b^n$ that would compensate shifts $\De\vec c_i$. That is
\eqref{\vec d_i \cdot (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n - \vec c_i)\ .}{cnst shr 1}
If this is fulfilled, such $\De\vec c_i$ configurations will be singular modes, for all values of ${\vec a'}^n$ and ${\vec b'}^n$ vectors. Explicitly:
\eqref{- \De s_i \equiv -\vec d_i \cdot \De\vec c_i = \vec d_i \cdot \left[ ({\vec a'}^n - \vec a^n) z_i + ({\vec b'}^n - \vec b^n) \right]\ .}{cnst shr 2}
Since the ${\vec a'}^n$ and ${\vec b'}^n$ vectors are two-dimensional, there four singular modes:
\eqref{\De s_i \propto z_i\cos\rh_i,\quad \De s_i \propto z_i\sin\rh_i,\quad \De s_i \propto \cos\rh_i,\quad \De s_i \propto \sin\rh_i\ .}{cnst shr 3}
\TODO{Like columns of complete $\mat\al$ matrix. 2 shifts and 2 shearings.}


\em{Shifts in $z$}. 
\eqref{\vec d_i \cdot \left[ \vec a^n (z_i + \De z_i) + \vec b^n \right] = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n)\ .}{cnst shz 1}
\eqref{\vec d_i \cdot \vec a^n \De z_i = \vec d_i \cdot (\De\vec a^n z_i + \De\vec b^n)\ .}{cnst shz 2}
This shall hold for every $\vec d_i$ and therefore one obtains
\eqref{\vec a^n \De z_i = \De\vec a^n z_i + \De\vec b^n\ .}{cnst shz 3}
Moreover, this must be obeyed for every value of $\vec a^n$, which is only possible if both $\De\vec a^n$ and $\De\vec b^n$ are proportional to $\vec a^n$. That means
\eqref{\De z_i = \al z_i + \be\ ,}{cnst shz 4}
where $\al$ and $\be$ are the proportionality constants. Thus there are two sinuglar modes (magnification and shift):
\eqref{\De z_i \propto z_i, \quad \De z_i \propto 1\ .}{cnst shz 5}

\em{Rotations around $z$}. We will use symbol $\mat R(\rh)$ for a rotation matrix around $z$ axis by angle $\rh$:
\eqref{\mat R(\rh) = \pmatrix{
\cos\rh & -\sin\rh \cr
\sin\rh & \cos\rh \cr
}\ .}{rotation matrix}
Again, let's search for track-parameter variations that could compensate a rotation. This time, we will include also transverse (read-out) misalignments as it will turn out that they are linked.
\eqref{[\mat R(\De\rh_i) \vec d_i]^\T (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = \vec d_i \cdot ({\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i)\ .}{cnst rotz 1}
Since this must be fulfilled for all $\vec d_i$, one can write
\eqref{\mat R(\De\rh_i)^\T (\vec a^n z_i + \vec b^n - \vec c_i - \De\vec c_i) = {\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i\ .}{cnst rotz 2}
Comparing $n$-dependent quantities, one finds
\eqref{\mat R(\De\rh_i)^\T \vec a^n z_i = {\vec a'}^n}{cnst rotz 3}
(and similarly for $\vec b^n$). This can be guaranteed only provided $\De\rh_i$ is $i$-independent, that is constant. Then it is easy to find that
\eqref{\De\vec c'_i = \mat R(\De\rh) \De\vec c_i + [\mat R(\De\rh) - 1] \vec c_i\ .}{cnst rotz 4}
The second term reflects the fact that the singular mode is a uniform rotation around the $z$ axis, while alignment rotations (described by angles $\De\rh_i$) are performed around detector axes. These axes are parallel, but displaced by vectors $\vec c_i$.

Considering the misalignment expectations (see \Tb{expected misalignments}), it is reasonable to replace the rotation matrix by the first Taylor terms and also neglect terms containing the product of $\De\rh$ and $\De\vec c_i$. These simplifications yield
\eqref{\De\vec c'_i = \De\vec c_i + \De\rh \pmatrix{
- {c_y}_i\cr
{c_x}_i\cr
} + \O{\De\rh^2, \De\rh \De\vec c_i}}{cnst rotz 5}
or in terms of read-out shift $s_i$
\eqref{\De s'_i = \De s_i - \De\rho\, \de s_i + \O{\De\rh^2, \De\rh \De\vec c_i}, \qquad \de s_i = \vec d_{\perp i}\cdot\vec c_i\ .}{cnst rotz 6}
To summarize, we have just derived that transition from overall rotation $\De\rh$ and shifts $\De s_i$ to zero rotation and shifts $\De s_i'$ generates a singular mode. This is the only singular mode for rotations, but it also involves shifts. It can be schematically written as
\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} \propto \pmatrix{
1\cr
- \de s_i
}\ .}{cnst rotz 7}


\ssubsection[sing modes groups]{Singular modes for few read-out directions}

In the previous section, we have used the fact that certain equalities shall hold for all read-out directions $\vec d_i$. However, the TOTEM detectors are designed such that the read-out directions are all parallel to either $U$ or $V$ axes (\TODO{make sure these are defined}). In this section we will show that such a geometry may increase the number of singular modes. We will consider a more general case, where the detectors split into groups according to their read-out direction:
\eqref{\vec \d_i \in \lbrace \pm\vec\de_1, \pm\vec\de_2, \ldots \rbrace \ ,\qquad |\vec\de_i \cdot \vec\de_j| \neq 1\hbox{ for } i \neq j\ .}{read-out groups}

For \em{shifts in read-out direction} the assumption of all direction has not been used and thus the result \Eq{cnst shr 3} remains valid also for these geometries.

For \em{shifts in $z$} one gets a copy of \Eq{cnst shz 2} for every group $g$:
\eqref{\vec\de_g \cdot \vec a^n \De z_i = \vec\de_g \cdot (\De\vec a^n z_i + \De\vec b^n)\ ,}{cnst shz g1}
valid, indeed, for detectors $i$ from the group $g$. (note the $\pm$ signs cancel). Since this shall hold for all $\vec a^n$, the ratio $\vec\de_g\cdot\De\vec a^n / \vec\de_g\cdot\vec a^n$ must be $n$-independent. That means constant, at least per group. Formally written (and similarly for the $\De\vec b^n$ term):
\eqref{
{\vec\de_g\cdot\De\vec a^n \over \vec\de_g\cdot\vec a^n} = \al_g,\qquad
{\vec\de_g\cdot\De\vec b^n \over \vec\de_g\cdot\vec a^n} = \be_g
\ .}{cnst shz g2}
For \em{one group}, there is infinite number of $\De\vec a^n$ vectors fulfilling this condition for a fixed value of $\al_1$. For \em{two groups}, there is a unique solution for given values $\al_1$ and $\al_2$. This means that singular modes are independent for each group, they are of form
\eqref{\De z_i = \al_g z_i + \be_g,\qquad \hbox{for groups }g \in \lbrace 1, 2\rbrace\ .}{cnst shz g3}
This means that the number of singular modes is doubled compared to \Eq{cnst shz 5}.

For \em{three and more groups}, the $\vec a^n$ vector is defined by two (let's say first and second) $\al$ values. Let's check what are the conditions for the other $\al$ values so as all requirements \Eq{cnst shz g2} are satisfied. Since $\vec\de_g$ vectors are two dimensional, one can put
\eqref{\vec\de_g = \et_{g1}\vec\de_1 + \et_{g2}\vec\de_2\ .}{cnst shz g4}
(For $g>2$ both $|\et| < 1$). Inserting that to \Eq{cnst shz g2} yields
\eqref{\al_g = {
\et_{g1} \vec\de_1\cdot\De\vec a^n \al_1 + \et_{g2} \vec\de_2\cdot\De\vec a^n \al_2
\over
\et_{g1} \vec\de_g\cdot\vec a^n + \et_{g2} \vec\de_g\cdot\vec a^n
}\ .}{cnst shz g5}
If $\al_1 \neq \al_2$, then $\al_g$ would become $n$-dependent, which is not possible. Therefore, there is no solution for this case. If $\al_1 = \al_2$, then all $\al_g$ are equal. This is exactly the solution \Eq{cnst shz 5} derived in the preceding section.

\em{Rotations around $z$}. Here, one can proceed in a similar way as for shift in z. One gets an analogy of \Eq{cnst rotz 3} for every group
\eqref{\de_g \cdot \mat R(\de\rh_i)^\T \vec a^n = \de_g \cdot {\vec a'}^n\ ,}{cnst rotz g1}
 which limits the dependence of $\De\rh$ only to group: $\De\rh_i \rightarrow \De\rh_g$. For \em{one} group there exist infinitely many solutions, for \em{two groups} there is exactly one. The solution has the form of \Eq{cnst rotz 7}, but separately for each groups -- therefore there are two linearly-independent singular modes. Schematically written

\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} = \al_g \pmatrix{
1\cr
- \de s_i
},\qquad \hbox{for groups }g \in \lbrace 1, 2\rbrace\ .}{cnst rotz g2}


For \em{three and more groups}, the ${\vec a^n}'$ vector is fixed by two values of $\De\rh_g$ (again, take the first and second). Using the decomposition \Eq{cnst shz g4} one finds (in infinitesimal approximation)
\eqref{\De\rh_g = {
\et_{g1} \vec\de_1\cdot\De\vec a^n \De\rh_1 + \et_{g2} \vec\de_2\cdot\De\vec a^n \De\rh_2
\over
\et_{g1} \vec\de_g\cdot\vec a^n + \et_{g2} \vec\de_g\cdot\vec a^n
}\ .}{cnst rotz g5}
This is a similar result to \Eq{cnst shz g5} and thus the interpretation is similar too. There is no solution if $\De\rh_1 \neq \De\rh_2$ and if they are equal, then all $\De\rh_g$ are equal. This reveals the solution \Eq{cnst rotz 7} from the previous section.

The singular mode numbers are summarized in \Tb{singular mode number}.

\htab{singular mode number}{Numbers of singular modes for different geometry types.}{\bln
\hbox{quantity class}				& \hbox{two read-out directions} & \hbox{three and more read-out directions} \cr\bln
\hbox{shift in read-out direction}	& 4 & 4\cr\ln
\hbox{shift in }z					& 4 & 2\cr\ln
\hbox{rotation around}z				& 2 & 1\cr\bln
}

As it was already said, the \em{design} of the Roman Pot detectors is such that there would be only two read-out directions. However in \em{reality}, because of misalignment rotations, the number of read-out directions is as large as the number of detectors. But since the misalignments small only, one stays close to the 2-readout-direction case. This will manifest in a presence of several modes with low but non-zero eigenvalues. 

\TODO{A few comments about numerics here.} First of all, it is clear that the eigenvalues of $\mat S$ would scale with the number of events (if the track-distribution is constant). Then, it make sense to define \em{normalized eigenvalues} as the eigenvalues of $\mat S/N_{\rm events}$. These should be, in first approximation, independent of the number of events. Second, due to limited precision of calculations\footnote{Double precision and ROOT matrix libraries have been used.}, the singular modes will not have their eigenvalues strictly zero. Because of the computational error it is even possible that their eigenvalues would come out negative. That is why we will always use the absolute value of the normalized eigenvalues. Although the singular modes will have non-zero values, they would be much smaller than those for regular modes. In between, one can expect band with no eigenvalues. This band can then be used to set a \em{singular limit}, that is the eigenvalue limit below which the eigenvalues would be treated as singular. All these effects can be seen if \Fg{al eig rho}.

\fig{fig/pdf/al_eigenvalues_rho.pdf}{al eig rho}{The dependence of normalized $\mat S$ matrix eigenvalues on the RMS of $\rh$. Theta 10 mrad, geometry 2.7x3.3, overlap=f. Colors correspond to the eigenvalue order. The top row shows the eigenvalues when only shifts in read-out direction are optimized. In middle row rotations about $z$ are added and in the bottom one also shifts in $z$. The two columns provide views in two different horizontal scales. The dashed lines correspond to the singular modes for any geometry. The rapidly changing eigenvalues demonstrate the transition from two to three and more groups.}

\ssubsection{Pathological track distributions}

So far we have discussed singular and weak modes that arise from the track parameterization and the geometry of read-out directions. Besides those, there could be singular modes arising from special track distributions. One could immediately think of a case where the detectors split into several groups and there would be no track going through detectors of several groups in the same time. Regarding RPs, this situation appears when the pots are not inserted close enough and therefore no track can go through the overlap between the vertical and horizontal pots. In this case, the alignment task would split into several smaller tasks (one per group) and for each of them one could write alignment equation like \Eq{fit equation}. Each of these equations contain a $\mat S$ matrix with its singular modes as discussed. Therefore the number of singular modes gets multiplied by the number of groups.

The LHC proton tracks are very parallel (\TODO{reference}), that is their slopes can be written:
\eqref{\vec a^n = \vec a_0 + \de\vec a^n,\qquad \si(\de\vec a^n) = \O{10^{-4}\un{rad}}\ .}{cnst rotz lt0}
 Let's look back to \Eq{cnst rotz 2} and check what happens when the spread $\de\vec a^n\to 0$. We first expand the rotation matrix keeping just the first Taylor terms:
\eqref{\pmatrix{1 & -\De\rh_i\cr \De\rh_i & 1\cr} (\vec a_0 + \vec b^n - \vec c_i - \De\vec c_i) = {\vec a'}^n z_i + {\vec b'}^n - \vec c_i - \De\vec c'_i\ .}{cnst rotz lt1}
This equation can still be solved by $\De\rh_i\equiv\hbox{const.}$, which leads to the solution \Eq{cnst rotz 7}. But there is another solution:
\eqref{\De\rh_i = \al z_i\ ,}{cnst rotz lt2}
where $\al$ is a proportionality constant. This can be seen, for example, by rearranging the terms on the \lhs{}:
\eqref{
\underbrace{\left[ \vec a_0 + \al \pmatrix{-b^n_y\cr b^n_x} \right]}_{{\vec a'}^n} z_i
	+ \underbrace{\vec b^n}_{{\vec b'}^n}
	- \vec c_i
	- \underbrace{\De\vec c_i - \al z_i \left[ \pmatrix{-c_{i_y}\cr c_{i_x}} - z_i \pmatrix{-a_{0_y}\cr a_{0_x}} \right]}_{\De\vec c_i'}
}{cnst rotz lt3}

In analogy to the arguments above \Eq{cnst rotz 7}, one can conclude that
\eqref{
\pmatrix{
\De\rh_i \cr
\De s_i
} \propto z_i\, \pmatrix{
1\cr
- \de s_i
},\qquad \de s_i = \vec d_{\perp_i} \dot (\vec c_i - \vec a_0 z_i)\ .}{cnst rotz lt4}
is a weak mode. It would be a true singular mode if we did not use the Taylor approximation of the rotation matrix. Or if all $\rh_i$'s would be zero. But as show in \Fg{al eig theta}, this weak mode is numerically indistinguishable from real singular modes for sufficiently parallel tracks.

It would be possible to draw a similar line of arguments for the case where $\vec b^n\to \vec b_0$. But keeping in mind the application to LHC proton tracks, this turns out to be very unrealistic scenario.

The treatment above started with \Eq{cnst rotz 2}, which assumes that the read-out directions can have all values. In section \Sc{sing modes groups} we have derived that if there are just two read-out direction groups, the number of singular modes for rotations doubles. In a similar way one can find out that this is the case for the weak mode \Eq{cnst rotz lt4} too. There would be a copy of \Eq{cnst rotz lt3} for every group, with independent proportionality constants $\al_g$. This would lead to one weak mode per group, just like in \Eq{cnst rotz g2}.

Eventually, let's remark that parallel tracks do not introduce new weak modes for shifts in read-out nor in $z$ direction. The reason is simple, their $\ga$ factors (see \Tb{alignment quantities}) do not involve both track parameters (slope and intercept). Thus it is not possible that a misalignment would ''convert'' one to the other (in the sense of creating slope $\vec a'$ from intercept $\vec b$ in \Eq{cnst rotz lt2}). \TODO{For z shifts, the number would indeed increase, with no slope spread, the z shifts can not be determined at all}.

To summarize, the \Tb{low theta singular mode number} lists the numbers of weak modes that emerge when tracks become very parallel. \Fg{al eig theta} illustrates the situation by showing the dependence of the $\mat S$ matrix eigenvalues on the RMS angle of the tracks.

\htab{low theta singular mode number}{Numbers of additional weak (or singular) modes due to low track slopes.}{\bln
\hbox{quantity class}				& \hbox{two read-out directions} & \hbox{three and more read-out directions} \cr\bln
\hbox{shift in read-out direction}	& 0 & 0\cr\ln
\hbox{shift in }z					& - & -\cr\ln
\hbox{rotation around}z				& 2 & 1\cr\bln
}

\fig{fig/pdf/al_eigenvalues_theta.pdf}{al eig theta}{The dependence of $\mat S$ matrix eigenvalues on the RMS of the track slopes $\vec a$. Misalignment shr\_rotz=0. 2.7x33, overlap=f, whole station, $\si_\rh=0\un{mrad}$. For higher sigma(rho) there is just one line right where you can see the red and blue curves. The vertical dotted line marks the typical slope spread in the LHC data.}

\subsection{Constraints}

Discuss two cases:
\> constraining singular modes only (dim E = dim C)
\> constraining also weak modes (dim E < dim C) and its danger when some of the weak modes are not that weak.

To solve the fit equation \Eq{fit equation}, one has to imply additional constraints that would regularize the $\mat S$ matrix. For the alignment task, these constraints may be for example metrology or laser measurements. Such constraints may be written in the following form
\eqref{\vec C \cdot \hat\vec\ch = v\ ,}{cnst form}
where $\vec C$ describes the structure of the constraint and $v$ contains the measurement outcome.

To solve the fit equation with constraints, it is advantageous to employ the Lagrange multipliers technique (\TODO{reference}). It suggests to expand the fit equation to \TODO{T with tilde}
\eqref{\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
} \pmatrix{
\hat\vec\ch \cr
\vec\La \cr
} = \pmatrix{
\vec T\cr
\vec V\cr
}\ ,}{alignment equation}
where the $\mat C$ matrix contains the $\vec C$ vectors (see \Eq{cnst form}) in columns for all constraints applied and vector $\vec V$ includes corresponding $v$'s. $\vec\La$ is the vector Lagrange multipliers. Let's demonstrate that this equation does what we want. First, let's rewrite as two equations
\eqref{\tilde\mat S \hat\vec\ch = \vec T - \mat C \vec\La \equiv \vec T'(\vec\La)\ ,}{cnst aux1}
\eqref{\mat C^\T \hat\vec\ch = \vec V\ .}{cnst aux2}
The second one obviously presents a series of constraints of type \Eq{cnst form}. Since $\mat S$ is symmetric (\TODO{ref}), it can be diagonalized as follows (see e.g. \bref{wikipedia} key \em{symmetric matrix})
\eqref{\mat S = \mat Q \mat D \mat Q^{-1}, \qquad
\mat D = \diag(\underbrace{0, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}}; \underbrace{\la_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}}), \qquad
\mat Q = (\underbrace{\vec s_1, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}} ; \underbrace{\vec r_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}})
\ ,}{cnst aux3}
where we have ordered the eigenvalues and eigenvectors such that all singular modes go first. Let's remark that we don't require eigenvectors for the same eigenvalue to form an ortonormal set (although we could). This will enable us to work with singular modes as derived above (without ortnormalizing them). Since $\mat Q$ is regular, one can put
\eqref{\mat D \mat Q^{-1} \hat\vec\ch = (\mat Q^\T \mat Q)^{-1} \mat Q^T \vec T'(\vec\La)}{cnst aux4}
and expand the parts for singular vectors
\eqref{
\pmatrix{
\ddots & & & \vrule & \cr
& 0 & & \vrule & \cr
& & \ddots & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\mat Q^{-1} \hat\vec\ch = 
\pmatrix{
& & & \vrule & \cr
& (\mat E^\T \mat E)^{-1} & & \vrule & \cr
& & & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\pmatrix{
\cr
\mat E^\T\cr
\cr
\noalign{\hrule}
\vdots\cr
}
\vec T'(\vec\La)
\ .}{cnst aux5}
(The $\mat E$ matrix contains the singular vectors $\vec s_i$ in columns). The part above the vertical line on the \lhs{} is identically equal to zero and thus so the \rhs{} must be. Considering that $\mat E^T \mat E$ is regular, one finds
\eqref{\mat E^\T \vec T = \mat E^\T \mat C \vec\La\ .}{cnst aux6}
In order to find solution $\vec\La$ for any $\vec T$,
\eqref{\mat E^\T \mat C\hbox{ must be regular}\ .}{cnst condition}
This condition defines what constraints may be used. We will discuss some convenient choices later on.

For the moment, let's get back to \Eq{cnst aux1}. (As $\vec\La$ has been resolved from \Eq{cnst aux6}, $\vec T'$ is known.) This equation has infinite number of solutions that can be written
\eqref{\hat\vec\ch(\vec\et) = \vec\ch^0 + \mat E \vec\et\ ,}{cnst aux7}
where $\vec\ch^0$ is a particular solution and $\vec\et$ are parameters in the solution space of the homogeneous equation. Inserting that to \Eq{cnst aux2} yields
\eqref{\vec\et = (\mat C^\T \mat E)^{-1} (\vec V - \vec C^\T \vec\ch^0)}{cnts aux8}
and therefore \Eq{alignment equation} has always a unique solution that satisfies all constraints \Eq{cnst form}.

Now it would be nice to show that the actual misalignments can play the role of $\vec\ch^0$. Unfortunately, this is the case only for shifts in the read-out direction. For the other misalignment classes it is violated because of the linearization step \Eq{tau linearization} -- see section \Sc{fit equation}. Combining \Eq{exact fit equation,cnst aux6} yields
\eqref{\vec\La = (\mat E^\T \mat C)^{-1} \mat E^\T \bar\mat S \vec\ch_a\ .}{cnst aux9}
If we were not forced to make the linearization step \Eq{tau linearization}, $\mat E$ would contain singular vectors of $\bar\mat S$ and thus their product would be identically zero. Then, $\vec\La = 0$, $\tilde\vec T = \vec T$ and \Eq{cnst aux1} would become trivial
\eqref{\tilde\mat S \hat\vec\ch = \tilde\mat S \vec\ch_{\rm a}\ ,}{cnst aux10}
which demonstrates that $\vec\ch_{\rm a}$ could play the role of the particular solution $\vec\ch^0$.

\TODO{Even with the linearization step, we will be assuming the same singular vectors for $\tilde\mat S$ as for $\bar\mat S$, hence $\vec\La = 0$ and the particular would obey
\eqref{\tilde\mat S \vec\ch^0 = \bar\mat S \vec\ch_{\rm a}}{cnst aux11}
$\vec\ch^0$ close to $\vec\ch_{\rm a}$ ...
}

\TODO{Scaling of constraints with N}

List of common constraint choices
\> \em{homogeneous} 
\> \em{fixed detectors}
\> \em{final} (used for the final analysis). \Fg{al eig rho,al eig theta} suggest that, in standard conditions ($\De\rh_i = \O{5\un{mrad}}$, $\si(\vec a)=\O{0.1\un{mrad}}$), it is not possible to determine the rotation between U and V detectors and between near and far unit (following the weak mode \Eq{cnst rotz lt2} and big z difference between the units). Need to fix these modes. Over-constrained case. Possible problems -- systematical errors.

\subsection{Monte-Carlo tests}

In the next section the errors of the algorithm will be discussed. To support our hypotheses we will use Monte-Carlo simulations. Here, we will briefly review how these simulations are performed and evaluated.

\> The reference result. Ideal and Jan(pitch round=t/f, ext fit=t/f).
\> Used simplified MC (fast). What to expect with G4 or real data?


\subsection{Errors}

\TODO{
Generally - I want to show that the algorithm is performing well:
\> no systematics under ideal circumstances
\> errors under control
}

The errors are of 3 origins:
\> pitch rounding (any measurement outcome is a multiple of the detector pitch)
\> rotation matrix linearization (cosine correction), \TODO{reference}
$$(\cos\rh_i - 1) \vec\d_i^\T (\vec h^n - \vec c_i)$$
\> biased track parameters in gamma coefficients, \TODO{reference}
$$\vec\d_{\perp_i}^\T \left[ (\vec a^n - \hat\vec a^n) z_i - (\vec b^n - \hat\vec b^n) \right]$$

The pitch rounding is a gentle effect. The error due to it is smaller than half of the pitch. This is to be compared to with hit distribution that is several centimeters wide. In first approximation one could assume that the error is
\> a random variable uniformly distributed on $(-P/2, +P/2)$ and
\> pitch errors in different detectors are independent.
Especially the second one is not really true, but it will give satisfactory results though.

An important property of the pitch error is that the errors in different events are independent. That is (event if one keeps the same track distribution and geometry) if one doubles the sample, the errors in the second half will be independent of those in the first half. As a consequence, one may assume better results with increasing sample size. As rule of thumb, the error should be proportional to $1/\sqrt N$ where $N$ is the sample size. That is why the pitch rounding error is of \em{statistical} nature.

The other two error sources do not behave in this way. In contrary, one can assume that the final error would be independent of the sample size (provided that track distribution and geometry and misalignments remain the same). Therefore, the cosine error and biased $\ga$ coefficient lead to a \em{systematical} error.

\TODO{The above statements are hypothesis, a MC proof should come here.
\> for s, r, z
\> choose a typical scenario (any big differences beyond the dependence on theta ??? I hope not.)
\> does the statistical error correspond well to the estimated uncertainty ???
\> any systematical errors ???
}

\TODO{Dependence of rho and z errors on theta}

\TODO{errors of z too large, abandon.}

\ssubsection{Statistical errors and uncertainty estimate}

The solution of the alignment task is given by \Eq{alignment equation}. In this equation there two quantities that are subject to statistical uncertainties: $\vec T$ and $\vec V$. The uncertainty of $\vec T$ vector is propagated from the measurements $\vec M^n$ through \Eq{fit equation}. $\vec V$ is an outcome of an external measurement and as such it is likely to subject to certain uncertainty. All these uncertainties can be propagated to the uncertainty of the result $\hat\vec\ch$. Eqn. (4.19) in \bref{barlow} on page 60 says that if $\vec y = \mat A\vec x$, then
$$\Var\vec y = \mat A\ \Var\vec x\ \mat A^\T\ .$$
This can be directly applied to \Eq{alignment equation}:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\Var \pmatrix{\tilde\vec T\cr\vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}

Since $\tilde\vec T$ and $\vec V$ are independent and $\Var \tilde\vec T = \tilde\mat S$, one can write:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\pmatrix{\tilde\mat S& 0\cr 0 & \Var \vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}

\TODO{Choice of $\mat V^n$: independent measurements is a good, but not perfect approximation. At least for small angles there is non-trivial correlation. But later we will see that this estimate will quite match with statistical evaluation of the result error.}

\Fg{al stat fixDet}: a statistical verification of the model of the pitch error. Just an example (that's why the fix-det constraints). Systematical error is compatible with zero ($3\sigma$), uncertainty falls as $1/\sqrt{N}$, statistical error over uncertainty almost flat, but below $1$ (error overestimations).

\fig{fig/pdf/al_stat_fixDet.pdf}{al stat fixDet}{Statistical study (20 repetitions), geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad, fixed detector constraints (shr: 1200, 1201, 1248, 1249, rotz: 1200, 1201). Plane 3 in every RP. \TODO{dotted lines}}

In some cases it is more difficult: reduced multi-strip cluster errors, see \Fg{al syst err pitch}.

\fig{fig/pdf/al_syst_err_pitch.pdf}{al syst err pitch}{it3 - precise3, near top RP, every plane by different color}

Conclusion: if non-reduced msc errors are used, then: negligible syst. error and real stat. fluctuation is smaller that the estimated uncertainty.

\Fg{al err rotz rho} that we can not determine the rotation between U and V planes with sufficient precision. The estimated error is $1\un{mrad}$, while the uncertainty is 10 times higher. We will give up trying to resolve this alignment mode. \TODO{Comment of the far unit errors}.

\TODO{Comment on the saturation at about $10\un{mrad}$ -- higher angles cannot be detected by both units.}

\fig{fig/pdf/al_err_rotz_rho.pdf}{al err rotz rho}{Rotation statistical error as a function of RMS of $\rh$. No misalignment (misaligned and real geometry contain detectors rotated with the given rho distribution). 1000 events. Extfit=false. fix-bas constraints, the fixed rotation in 1200. Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7).}

\Fg{al err shz theta} shows that the error of $z$ shift is huge \TODO{an expectation for comparison}. Even with high slopes, the uncertainty does not drop below $1\un{m}$. We will abandon the $z$-alignment.

\fig{fig/pdf/al_err_shz_theta.pdf}{al err shz theta}{Rotation statistical error as a function of RMS of $\rh$. No misalignment, fix-ext constraints (rotz in 1200, 1201; shz in 1200, 1201, 1248 and 1249), 100 events, extfit=f. Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7).}

\fig{fig/pdf/al_err_rotz_theta.pdf}{al err rotz theta}{Rotation statistical error as a function of RMS of $\vec a$. No misalignment, fix-ext constraints(rotz in 1200 and 1201). 1000 events, extfit=f. Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7).}

\TODO{Overconstraints -- additional statistical error}

\TODO{Iterations
\> idea
\> error behavior
\> example of convergence?
}

Systematical errors now. Still in game
\> cosine correction (at rhos around 10mrad, it is negligible to the other error contributions)
\> biased gamma factors due to undetermined rotations
\>> u-v
\>> f-n

\Fg{al syst err uv rot}. misalignment: shr zero, rotations in V det. sigma~1mrad, mean 0, rotations in U detectors as indicated on the hor. axis. Diff. between Jan(round=f, extfit=f) and Jan(f, t). Note that the error is created in V detectors while U detectors have the problem. \TODO{Explain}.

\fig{fig/pdf/al_syst_err_uv_rot.pdf}{al syst err uv rot}{Systematical errors due to undetermined uv rotation. near top RP (V det dashed, U solid, near pair same color), geometry 2.7x3.3, final constraints, special tr.dist x:box(5,10) y:box(0,20), it3 - precise3, theta=0mrad, }

\Fg{al syst err fn rot}. Misalignment: shr zero, rotations in near unit sigma~1mrad, mean 0, rotations in far unit sigma~1mrad and mean as indicated on the horizontal axis. Diff. between Jan(round=f, extfit=f) and Jan(f, t). Note the increasing diff. between U and V detectors.

\fig{fig/pdf/al_syst_err_fn_rot.pdf}{al syst err fn rot}{Systematical errors due to undetermined uv rotation. far top RP (V det dashed, U solid, near pair same color) (errors in near much lower!), geometry 2.7x3.3, final constraints, special tr.dist x:box(5,10) y:box(0,20), it3 - precise3, theta=0mrad, }

\Fg{al stat final}: another example of the statistical convergence. One more ''insurance'' that the final procedure would work.
\fig{fig/pdf/al_stat_final.pdf}{al stat final}{Statistical study (20 repetitions), geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad, final constraints. Plane 3 in every RP. Dashed lines}


\subsection{Input data selection}

With the fast Monte-Carlo one a priory knows that there was exactly one track per event and that all detector hits belong to this track. Consequently all track-fit residuals follow from misalignments. This is not true for real data. There might be a number of tracks per event, moreover different in every RP. There might be a number of hits that do not belong to any particle track -- noise, data corruption. That is why it is necessary to select carefully the input for the track-based alignment. It is better to loose some statistics than to bias the results with false input.

\> the algorithm

\> the cuts -- depend on situation, don't give values here but only later

\subsection{Roman Pot alignment}

Alignment of the entire RPs -- factorization process.



\subsection{Experimental results}

There are 3 sources

\> Optical metrology

\> beam-tests in H8
\>> The method has been applied to test-beam and commissioning data for all 12 RPs installed in the tunnel.
\>> Give statistics table (muon/cosmics run, total events, useful events, cut-off/low-quality events)...

\> LHC runs

(A) Internal alignment comparison

The position of the detectors within the RP assembly has been measured. There are 3 reference points on a detector and one point on the RP. For each detector a zoomed high resolution photo was taken and a relative position of the points 1 and 2 (see \Fg{opticalMetrology}) and the RP reference point was measured. Theoretical values and results are summarized in \Tb{metrology theoretical}. The precision of this measurement is $\approx 10\un{\mu m}$.

\fig{fig/pdf/opticalMetrology.pdf}{opticalMetrology}{An illustration of the optical metrology measurement. \TODO{points on detector or hybrid?} \TODO{add mark photo}}

\tab{metrology theoretical}{The theoretical values for the optical measurement of RPs (the positions of the fiducial marks).}{
\multispan{2}\strut\bvrule\hfil reference point 1\hfil&\multispan{2}\strut\vrule\hfil reference point 2\hfil& \omit\bvrule\hfil control\hfil\cr
x\un{(mm)}	& y\un{(mm)}	& x\un{(mm)}	& y\un{mm}	& \omit\bvrule\hfil\ distance (mm)\hfil\	\cr\bln
75.068 & 31.631 & 25.932 & 31.631 & 49.136\cr\bln
}

\eqref{\hbox{control distance}\ d_c = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}}{metrology distance}

\fig{fig/pdf/opticalMetrologyControlDistance.pdf}{opticalMetrologyControlDistance}{The distribution of the control distance around the theoretical value (the dashed line) -- a measure of the statistical uncertainty.}

If one assumes that the uncertainty of a measurement in any direction is $\si_m$, then the error of the control distance is approximately $\si_m \sqrt2$. This follows from the error propagation via \Eq{metrology distance} and considering that $y_2-y_1\approx 0$ while $x_1-x_2\approx d_c$. Then, the distribution in \Fg{opticalMetrologyControlDistance} suggests that $\si_m \approx 1\un{\mu m}$. However, since the measurements enter \Eq{metrology distance} in differences, this error estimate is only valid for rotations as defined by \Eq{metrology rot}. For shifts, we will keep the more conservative estimate $10\un{\mu m}$

Shifts and rotations are extracted as follows
\eqref{\hbox{rotation} = {y_2 - y_1\over x_2 - x_1}}{metrology rot}
\eqref{x\hbox{ shift} = {x_1 + x_2\over 2} - \bar x,\qquad y\hbox{ shift} = {y_1 + y_2\over 2} - \bar y}{metrology shift}
where $\bar x$ and $\bar y$ are the arithmetic means of the theoretical values displayed in \Tb{metrology theoretical}

\fig{fig/pdf/al_comp_det_per_pot.pdf}{al comp det per pot}{Internal alignment comparison. \TODO{chose 2 or 3 pots that would show all things worth discussing - compatible and non-compatible results, possible linearly progressive rotation, etc.}}

(B) show that U-V and N-F rotations can not be determined from beam-test/LHC data. Is there any hint from the optical metrology.?

\fig{fig/pdf/al_comp_det_per_unit_weak.pdf}{al comp det per unit weak}{Alignment comparison with fixed-detectors constraints. Shows full rotation about z.}


(C)  LHC results per unit (choose one typical) on detector level

\fig{fig/pdf/al_comp_det_per_unit.pdf}{al comp det per unit}{Alignment comparison with final constraints. Unit 56 near.
\TODO{Shift comparision is misleading because of different geometries!}
}

(D) The RP quantities for one station

\fig{fig/pdf/al_comp_rp.pdf}{al comp det rp}{RP alignment comparison with fixed-detectors constraints. Circles: all tracks, squares: overlap tracks only.}

Generally - want to show that everything is stable and consistent.

Why analyses with overlap true and false?
\> First, if there were some weird events fooling the alignment, they might be found by splitting the sample into several parts. Then one expect to find incompatible results (within the estimated uncertainty).
\> If tracks were hitting only a very small part of the detector, the corresponding gamma coefficient would be almost constant and the rotation would be indistinguishable from shifts. In case of wrongly determined rotations, one would expect rather different results here and when the ga distribution is large.
\> The overlap=true does both things as above: smaller sample and tracks accumulated in a rather small area.

\section{Profile methods}

\> Hit rate comparison
\> Hit spatial distributions
\> Kinematic peak method

\section{Elastic Alignment}

\section{Summary (if any)}
