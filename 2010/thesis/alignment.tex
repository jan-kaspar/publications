\chapter[al]{Alignment of Roman Pots}

\TODO{!! ADD CITATIONS !!}

MOTIVATION: An accurate alignment is of major importance for the TOTEM experiment in order to deliver precise measurements. Among the subdetectors of TOTEM, the alignment of the RPs presents the biggest challenge since they are movable. The importance of alignment is most pronounced at the $\be^* = 1535\un{m}$ optics, where the beam divergence (the dominant smearing effect) is rather low and thus the impact of any misalignment has a large relevance. To give a feeling, a $100\un{\mu m}$ displacement of a vertical RP would lead to angular shift of about $0.4\un{\mu rad}$ (based on an effective length $L_y\approx 270\un{m}$, typical for this optics). This is to be compared to the spread of the beam divergence $0.3\un{\mu rad}$.

\TODO{experience from other experiments}

WHAT WE ALIGN, WRT WHAT:
What is important is the relative position between RP sensors (the other parts do not matter much) and the beam. Hence there are two players in the game -- RP positions and beam positions.

Coordinate system such that the beam is at x=y=0

\section[al proc]{Alignment procedure}
The procedure has two steps. First, move the pots to the desired position as precisely as possible. Then take data, analyze them and find what error has been done in the first step.

The first step relies mainly on two types devices -- RP motor control and Beam Position Monitors (BPMs). Both are calibrated to determine position of outer edge of the window or the beam with respect to the ideal beam-pipe center.

For the second step, a number of methods is available. Undoubtedly, one of the most powerful ones is the track-based alignment. It uses the tracks passing through the overlap between vertical and horizontal RPs and is, therefore, capable of determining the relative position between the pots. Its strength is underlined by the fact that it is based on a single assumption: tracks are straight lines. To determine the position of the beam, other methods must be used. One may profit from know symmetries of certain physics processes. Here, the analysis becomes delicate because in the observables the properties of the processes are mixed with the properties of the optics. This gives a certain superiority to elastic scattering. This process is often easy to separate and thus can provide a clean sample, as the first argument. As the second one, it comprises two protons exactly in the opposite direction and can thus be used for the alignment of the opposite arms of the experiment. Yet another advantage the protons have, by definition, zero momentum-loss and therefore, the dependence on the optics is largely reduced.

Reference to \Sc{al exp misal}.
As it follows from \Sc{rp measurement}, only the rotation around $z$ axis is relevant.

\section[al exp misal]{Expected misalignments}

Let's first asses what may go wrong and what are the corresponding misalignment estimates.

\noindent\em{Internal misalignments} arise from finite precision of fixing the detectors within a package. The precision is estimated to be
\eqref{20\un{\mu m}\ .}{internal misalignment shift}
This also gives estimate about the rotation
\eqref{\De\rh \approx {2\cdot 20\un{\mu m}\over 4\un{cm}} = 1\un{mrad}\ .}{internal misalignment rotation}

\noindent\em{Errors in RP positions}
\> z shifts
\> errors in RP motor control $~20\un{\mu m}$
\> RP frame deformation ???

\noindent\em{Errors in optical functions} are also sort of misalignments -- global alignment

\htab{expected misalignments}{Expected misalignments orders. \TODO{}}{\bln
	& \hbox{within RP package} & \hbox{Roman Pot} \cr\bln
\hbox{transverse shift}	& 20\un{\mu m} 			& 100\un{\mu m} \cr\ln
\hbox{shift in }z 		& ?						& ?\cr\ln
\hbox{rotations}		& \hbox{few }\rm mrad	& \hbox{few }\rm mrad \cr\bln
}

\section[al collim]{Collimation alignment}

PUT THIS TO INTRODUCTION? In principle both \abb{BPM}s and \abb{RP} motor controls should have been calibrated such that they give the position of beam/RP edge with respect to the beam-pipe center. However, a cross-check is always good. Moreover, this exercise was needed for the alignment against the system of the LHC collimators.

In the beginning, the collimators scrape the beam such that its edge is sharp and its size and center is well defined. Then a RP is approached to the beam, until it touches the sharp edge. In this moment, particles from the beam edge are scattered off the RP edge and they give raise to peaks in the BLMs downstream (see \Fg{al collim ex} bottom). In this moment, the RP edge is at the same beam-sigma-distance as the collimators.

With the vertical RPs we can make use of the fact that we have two jaws and determine the beam-sigma (in millimeters) and the beam-center. Suppose that we have touched the beam with the top RP. In that moment, the RP became the primary collimator and scraped the beam a bit. Due to the multi-turn effect, the beam was scraped symmetrically about the vertical center of the beam. Then, one can approach the bottom pot, again until a BLM peak appears. Then, both RPs are at the same distance from the vertical beam-center and the distance corresponds to one beam-sigma (up to the step-size, indeed). These steps can be repeated in order to improve the precision of the beam-center determination. An example of this procedure can be found in \Fg{al collim ex}.

\fig{fig/pdf/al_collim_ex.pdf}{al collim ex}{An example of collimation alignment data from 29 November 2009 (56-220-near unit). The top and bottom pot movements (upper plot) induced the BLM signals (bottom plot). The time is in minutes from the start of the test.}

The precision is obviously given by the step size. Mostly because of the limited time resolution one cannot determine when during the movement the beam was touched. One should, thus, aim at as little steps as possible. On the other hand, the smaller step, the less scraping and the lower peak in the BLM signal. If the step is too small, the induced beam loss can not be distinguished from the noise. We observed a step of $50\un{\mu m}$ to be on the practical limit.

So far, the collimation alignment has been repeated three times: 29 November 2009, 25 June 2010 (both at $450\un{GeV}$) and 21 September 2010 at $3.5\un{TeV}$. The results suggest an unfortunate conclusion -- both RP LVDTs and BPMs seemed wrongly calibrated. For an immediate indication, let's look back to \Fg{al collim ex}. Assuming the beam was touched in the middle of the movement, one obtains the beam center at $(313\pm 63)\un{\mu m}$ according to the LVDTs. However, the corresponding BPM claimed the beam to be at $(-550\pm50)\un{\mu m}$. The discrepancy is evident, what is not clear is, however, which device to blame.

Very soon it became clear that the BPMs very not reliable at that time. A quite typical BPM curves are plotted in \Fg{al collim bpm problem}, note the huge drifts. It was confirmed by BPM experts that these devices suffered from temperature and intensity effects. These made the use of BPMs uninteresting for alignment purposes.

\fig{fig/pdf/al_collim_bpm_problem.pdf}{al collim bpm problem}{The readings from sector 56 BPMs from 25 June 2010. Very pronounced drifts are evident.}

Another valuable hint was provided later by the track-based alignment method (\Sc{al tb}). The results contained large per-RP shifts (i.e. all sensors from a pot indicated the same shift), moreover almost run-independent. This suggested that the LVDT scales did not have a common origin, in other words, every LVDT reading should be corrected by an offset. 

These offsets can be determined with the collimation alignment -- the principle is shown in \Fg{al collim}. The beam size at the collimator location ($n\si_0$) is known and can be propagated to the RP location, thus $n\si$ is known too. $t$ and $b$ are the top and bottom LVDT readings. The offsets then follow:
\eqref{o_t = n\si - t,\qquad o_b = -n\si - b\ .}{LVDT offsets}
Note that the offsets are determined with respect to the beam center (not the beam-pipe center), which is, in fact, exactly what we need. The measurements were performed on 21 Sep, the results were published in \bref{al collim} (Tb.~1). The calculated offsets can be found in \Tb{al lvdt off}. The error is dominated by the touching-point determination. Taking a half of the step size yields an error of $\approx 100\un{\mu m}$.

\fig{fig/pdf/al_collim.pdf}{al collim}{How to determine LVDT offsets with collimation alignment. The beam is drawn in blue, its envelope with solid and its center with dash-dotted line. The origins of the LVDT scales are marked with red dots.}

\htab{al lvdt off}{The LVDT offsets (values in $\un{mm}$). Positive/negative value means shift up/down (like in \Fg{al collim}).}{\bln
\hbox{unit} & o_t & o_b \cr\bln
\hbox{45-220-near} & +0.515 & +0.135\cr\ln
\hbox{45-220-far} & +0.389 & +0.111\cr\bln
\hbox{56-220-near} & -1.254 & -0.286\cr\ln
\hbox{56-220-far} & +0.262 & -0.162\cr\bln
}

In this way, we've determined the vertical positions of the thin windows (the RP parts that face the beam, see \Sc{rp system}). The package with silicon sensors is inserted into the RP with a limited precision, which has even deteriorated by \TODO{the short-circuit incident}. Regarding the thin-window-to-sensor-edge distance, this may bring another $100\un{\mu m}$ of uncertainty. Thus, altogether, the vertical position of the sensors in the vertical pots is determined with a precision of $\approx 150\un{\mu m}$.

\section[al tb]{Track--based alignment}

Intro, partially the same as above: tracks should be straight lines, misalignments move the hits slightly off the track. They can be determined by an appropriate analysis of the residuals.

\TODO{define residuals}

\subsection[al psi]{The relation between proton kinimatics and RP measurements}

Since the magnetic field within RP stations is negligible, protons follow a straight trajectory, as drawn in the side view of \Fg{al proton sensor interaction} (the same is shown in \Fg{ttm proton transport}, but with the third axis called $s$). The track can be described
\eqref{\pmatrix{x\cr y\cr z} = \pmatrix{a_x\cr a_y\cr 1} z + \pmatrix{b_x\cr b_y\cr 0}\ ,}{al local track}
where $a$ and $b$ parameters give the track slopes and intercepts.

When a proton enters the sensitive volume of a silicon sensor, it creates electron-hole pairs along its trajectory. This charge is collected by neighbouring strips, giving raise to measurable signal. While details of this charge sharing process can be found, for example, in Sec.~7.4~in \bref{hubert}, here, we will assume that just the nearest strips is active (drawn in green in the front view of \Fg{al proton sensor interaction}). It is a reasonable assumption for the TOTEM sensors. Then, the measurement outcome $m$ can be written
\eqref{m = v + \De m\ ,}{al measurement}
where $v$ gives the projection of the hit point in the $\vec v$ direction (i.e. the read-out direction). $\De m$ is the \em{pitch-rounding error}, that is the error made by rounding $v$ to the nearest strip position.

\fig{fig/pdf/al_proton_sensor_interaction.pdf}{al proton sensor interaction}{A scheme of a proton interaction with a sensor. Left (side view when $\rh_y = 0$): the thick black line represents a sensor, the blue line a proton track. The blue dot marks the point where the proton hits the sensor. It has the same meaning in the right (front view) figure. There, the thick blue line shows the hit point projection into the read-out ($\vec v$) direction. The strip drawn in green is the active strip, the ``pitch rounding correction'' is drawn in red.}

The value of $v$ can be related to the track parameters with the aid of a transformation from (global) coordinate system $xyz$ to (local) system $uvz'$. The transformation can be written as follows
\eqref{\pmatrix{u\cr v\cr z'} = \mat R \left[ \pmatrix{x\cr y\cr z}  - \pmatrix{c_x\cr c_y\cr c_z}  \right] \ .}{al global to local}
The $c$ parameters give the position of sensor's center, the rotation $\mat R$ can be parameterized with three angles $\rh_{x,y,z}$:
\eqref{\mat R =
\pmatrix{
\cos\rh_z  & \sin\rh_z & 0\cr
-\sin\rh_z & \cos\rh_z & 0\cr
0		   & 0         & 1\cr
}
\pmatrix{
\cos\rh_y  & 0 & \sin\rh_y\cr
0		   & 1 &          \cr
-\sin\rh_y & 0 & \cos\rh_y\cr
}
\pmatrix{
1 & 0		   & 0        \cr
0 & \cos\rh_x  & \sin\rh_x\cr
0 & -\sin\rh_x & \cos\rh_x\cr
}\ .
}{al rotation parameterization}
This three shifts and three rotations reflect the position of a sensor in the global coordinate frame. In reality, despite our best efforts, the position can not be exactly the nominal one. It is therefore important to distinguish between \em{true/actual} (with primes) and \em{nominal/thought} (without primes) position parameters:
\eqref{\rh_i' = \rh_i + \De\rh_i\ ,\qquad c_i' = c_i + \De c_i\ ,}{al misalignments}
where $\De\rh_i$ and $\De c_i$ represent the \em{misalignment} or, on the other hand, \em{alignment corrections}.

The nominal sensors' positions (see \Sc{ttm}) are perpendicular to the $z$ axis, that is $\rh_x=\rh_y=0$. The order angular misalignments $\De\rh$ in summarized in \Tb{expected misalignments}. Taking $5\un{mrad}$ as the order of these angles, one obtains
\eqref{\cos\rh_{x,y}' = 1 + \O{10^{-5}},\qquad \sin\rh_{x,y}' = \rh_{x,y}' + \O{2\cdot 10^{-8}}}{al small rotation approximation}
and thus it is a good approximation to take just the lowest terms in the Taylor expansion. A similar statement holds for $\rh_z'$ too, just the expansion shall be made at the nominal value $\rh_z$.

The fact that the track \Eq{al local track} hits a sensor can be expressed as $z' = 0$. Then it is straightforward to calculate the $v$ coordinate of the hit:
\eqref{v =
	\Bigg[
		\underbrace{\pmatrix{-\sin\rh_z\cr\cos\rh_z}}_{\vec d}
		+ \underbrace{\pmatrix{-\cos\rh_z\cr -\sin\rh_z}}_{\vec d_\perp} \De\rh_z
	\Bigg]^\T
	\Bigg[
		\underbrace{\pmatrix{a_x\cr a_y}}_{\vec a} (c_z + \De c_z)
		 + \underbrace{\pmatrix{b_x\cr b_y}}_{\vec b}
		 - \underbrace{\pmatrix{c_x\cr c_y}}_{\vec c}
		 - \underbrace{\pmatrix{\De c_x\cr \De c_y}}_{\De \vec c}
	\Bigg]^\T
	+ \O{10^{-7}\un{m}}\ .
}{al hit v}
In fact, we have displayed just the most important terms, the others are included in the $\cal O$ factor. The separation follows from the following order estimates: $c_z \sim 1\un{m}$ (distances between pots in a station), $(b - c)_{x, y} \sim 10^{-2}\un{m}$ (size of the sensors) and $a_{x, y} \sim 10^{-2}\un{rad}$ (the maximal angle that can be detected by near and far units simultaneously). The last estimate is rather an upper bound, see the typical track angles in \Tb{al lhc datasets}. Thus for realistic data the neglected terms would be rather $\O{10^{-8}\un{m}}$.

In \Eq{al hit v} we have defined the \em{unit} vector $\vec d$ which represents the (nominal/thought) \em{read-out direction}. The vector $\vec d_\perp$ is perpendicular to the read-out direction, see \Fg{al proton sensor interaction}. The terms if the left-hand bracket represent the true/actual read-out direction. The vectors $\vec a$, $\vec b$, $\vec c$ and $\De \vec c$ represent two-dimensional vectors of the track slope, the track intercept, sensor's center and the sensor's position misalignment.

The only rotation misalignment that has survived in \Eq{al hit v} is the one about the $z$ axis. Also, this is the only rotation which has non-zero nominal value. To simplify the notation, we will drop the $z$ subscripts in what follows:
$$\rh_z \longrightarrow \rh\ ,\qquad \De\rh_z \longrightarrow \De\rh\ .$$

So far we have considered one sensor and one event. But \Eq{al measurement,al hit v} can be written for any event and any sensor, for $i$-th sensor and $n$-th event they read
\eqref{
m_i^n = (\vec d_i + \De\rh_i\,\vec d_{\perp i})^\T \left[\vec a^n (z_i + \De z_i) + \vec b^n - (\vec c_i + \De\vec c_i)\right] + \De m_i^n + \O{10^{-7}\un{m}}\ ,
}{al meas i n}
where for brevity reasons we have made a replacement
$$c_{z,i} \longrightarrow z_i\ ,\qquad \De c_{z,i} \longrightarrow \De z_i\ .$$

In what follows, we will drop the last two terms on the \rhs, they will be treate as an error, see \Sc{al err}. The first term can be expanded
\eqref{\eqnarray{
\mu_i^n \equiv m_i^n + \vec d_i^\T \vec c_i = & &\cr
& +\vec d_i^\T (\vec a^n z_i + \vec b^n)&\qquad 10^{-2}\un{m}\cr
& -\vec d_i^\T \De\vec c_i&\qquad 10^{-5}\un{m}\cr
& +\vec d_i^\T \vec a^n \De z_i&\qquad 10^{-??}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i) &\qquad 10^{-5}\un{m} \cr
& +\De \rh_i\ \vec d_{\perp i}^\T (\vec a^n \De z_i - \De\vec c_i) &\qquad 10^{-8}\un{m}\ , \cr
}}{al effective measurement}
where we have introduced an \em{effective measurement}. It differs from the full one just by constant $\vec d^\T \vec c$ (projection of sensor's center to its read-out direction). From the order estimates (shown above on the right-hand side) it is clear that one may neglect the last term. This is an important result since the remaining terms are (at most) linear in the misalignment parameters $\De \vec c_i$, $\De z_i$ and $\De \rh_i$. Furthermore, one can split the contributions of a track measurement by a sensor at the nominal position and the effect of misalignments:
\eqref{\mu_i^n =
\underbrace{\vec d_i^\T (\vec a^n z_i + \vec b^n)}_{\hbox{track}}
+
\underbrace{\sum_j \ga_{j, i}^n\ \ch_{j, i}}_{\hbox{misalignment corrections}}
\ .}{al effective measurement 2}
In the above relation we have unified the notation for all misalignment quantities $\ch_j$, which influence the measurement via their coefficients $\ga_j$, see the summary in \Tb{al alignment quantities}

\htab{al alignment quantities}{Alignment quantity classes and their coefficients.}{\bln
j & \hbox{quantity} & \ch_{j, i}					& \ga_{j, i}^n\cr\bln
1 & \hbox{shift in read-out direction} & \De s_i 	& -1\cr\ln
2 & \hbox{shift in }z & \De z_i						& \vec d_i^\T \vec a^n  \cr\ln
3 & \hbox{rotation around}z & \De\rh_i				& \vec d_{\perp i}^\T (\vec a^n z_i + \vec b^n - \vec c_i)\cr\bln
}

From \Eq{al effective measurement} it is clear that the measurement is only sensitive to one component of the detector shift, in particular the \em{shift in the read-out direction}:
\eqref{\De s_i \equiv \vec d_i \cdot \De\vec c_i\ .}{al shr def}
Thus, this is the only shift component that can be determined by the track-based alignment on a sensor level. For a RP package both transverse shift components can be determined, see \Sc{al rp fac}.


\subsection[al sim fit]{Simultaneous fit of track and alignment parameters}

From \Eq{al effective measurement 2} we see that sensors' measurements depend on the track parameters $\vec a$ and $\vec b$ and misalignment parameters $\ch$. One might thus fit sensors' data from a sample of events with the parameterization \Eq{al effective measurement 2}. This would result in misalignment parameter estimates and, as a byproduct, estimates of the track parameters.

This idea was first implemented in Millepede (see \bref{millepede}). Here we use different notation as our work as been done independently.

In order to perform the fit, it is useful to switch into a matrix formalism. Let us put all effective measurements in $n$-th event into vector $\vec\mu^n$. Then \Eq{al effective measurement 2} can be recast into:
\eqref{\vec\mu^n =
	\underbrace{\mat\al^n \vec\ta^n}_{\hbox{track}}
	+
	\underbrace{\sum_j \mat\Ga_j^n \vec \ch_j}_{\hbox{misalignments}}
\ ,}{al vec mu}
where
\eqref{\vec\ta^n = (a_x^n, a_y^n, b_x^n, b_y^n)^\T}{al vec tau}
is the vector of the track parameters and 
\eqref{\mat \al^n = \pmatrix{
	\vdots		& \vdots		& \vdots	& \vdots \cr
	d_{ix} z_i	& d_{iy} z_i	& d_{ix}	& d_{iy} \cr
	\vdots		& \vdots		& \vdots	& \vdots \cr
}, \quad i\hbox{ goes through all sensors involved in }n\hbox{-th event.}}{al mat alpha}
The vector $\vec\ch_j$ groups all the misalignments of the $j$-th type for all sensors. The matrices $\mat\Ga_j^n$ contain the coefficients $\ga^n_{j,i}$ as introduced in \Eq{al effective measurement 2}.

Let us remark that starting with \Eq{al vec mu}, the superscripts are reserved for event numbers, while subscripts fro the misalignment quantity class (see \Tb{al alignment quantities}).

Now we may put the measurement from all events into one vector:
\eqref{\vec M = (\vec\mu^1, \vec\mu^2, \ldots)^\T}{al vec M}
and similarly for the track and misalignment parameters
\eqref{\vec P = (\vec\ta^1, \vec\ta^2, \ldots || \vec\ch_1, \vec\ch_2, \ldots)^\T\ .}{al vec P}
With this notation, relations of the type \Eq{al vec mu} can be written
\eqref{\vec M = \mat A \vec P\ ,\qquad
	\mat A = \pmatrix{
	\ddots & 		&		&\vrule	&\ddots	&				&\udots	\cr
		&\mat \al^n	&		&\vrule	&		& \mat\Ga_j^n	&	\cr
		&		& \ddots	&\vrule	&\udots	&				&\ddots	\cr
	}\ .
}{al effective measurement all}
The left-hand part of $\mat A$ matrix is block-diagonal (with matrices $\mat\al^n$ on the diagonal). The right-hand part is built from $\mat\Ga_j^n$ matrices, the index $n$ increases in top-down direction, the index $j$ in the left-right one.

This form of \Eq{al effective measurement all} is convenient for an application of the linear Least Squares method (see e.g. Sec.~6.6 in \bref{barlow}). The method gives the following prescription for the estimate of the parameter vector $\vec P$:
\eqref{\hat\vec P = (\mat A^\T \mat V^{-1} \mat A)^{-1} \mat A^\T \mat V^{-1}\,\vec M\.}{al P estimate exact}
We use the hat in $\hat\vec P$ to emphasize that it is an estimate. The $\mat V$ matrix is the covariance matrix for the measurements $\vec M$. Since the measurements from different events are independent (as random variables), $\mat V$ has a block-diagonal structure
\eqref{\mat V = \pmatrix{
\ddots	&			&			\cr
		& \mat V^n	&			\cr
		&			& \ddots	\cr
}\ ,}{al mat V}
where a block $\mat V^n$ represents the covariance matrix of measurements from the $n$-th event (see \Sc{al err} for more details).

Unfortunately, \Eq{al P estimate exact} can not be applied directly. The problem comes from the fact that the $\ga^n_{j,i}$ coefficients (see \Tb{al alignment quantities}), which are contained in $\mat\Ga_j^n$ and $\mat A$ matrices, depend on the track parameters. And these are unknown at the fit time. Instead, one may adopt an \em{iterative} approach and use track parameter estimates obtained via a model where all misalignments are neglected. This is basically using $\mat \al^n$ as fit matrix for $\vec \mu^n$ data. Let us denote $\mat\Ga$ and $\mat A$ matrices obtained in this way with tildas:
\eqref{\vec\ta \rightarrow \hat\vec\ta: \quad \mat\Ga \rightarrow \tilde\mat\Ga, \mat A \rightarrow \tilde\mat A\ .}{al tau linearization}
This step brings in a necessity for several iterations, we will discuss them in \Sc{al err}.

Now we would like to extract the vector of misalignment estimates $\hat\vec\ch = (\hat\vec\ch_1, \hat\vec\ch_2, \ldots)^\T$ from the full parameter vector $\hat\vec P$ (see \Eq{al vec P}). It can be done by a straightforward evaluation of the \rhs{} of \Eq{al P estimate exact}. The inverse of
\eqref{\tilde\mat A^\T \mat V^{-1}\tilde\mat A =
\pmatrix{
\ddots 	& 											& 		&\vrule &\ddots & 														& \udots\cr
	 	& {\mat\al^n}^\T \mat V^{n^{-1}} \mat\al^n	& 		&\vrule & 		& {\mat\al^n}^\T \mat V^{n^{-1}}{\tilde\mat\Ga}_j^n 			& 		\cr
 		& 											&\ddots &\vrule &\udots & 														& \ddots\cr
\noalign{\hrule}
\ddots 	& 											&\udots	&\vrule &\ddots & 														& \udots\cr
	 	& {\tilde\mat\Ga_i}^{n^\T} \mat V^{n^{-1}} \mat\al^n& 		&\vrule & 		& \sum_n {\tilde\mat\Ga_i}^{n^\T} \mat V^{n^{-1}} {\tilde\mat\Ga}_j^n 	& \cr
\udots	& 											&\ddots &\vrule &\udots & 														& \ddots\cr
}
\ .}{al mat ATA}
can be obtained (let us assume momentarily that the inverse exists) with the aid of the following block matrix inverse rule (see e.g.~Sc.~4.3.2 in \bref{barnett}):
\eqref{\pmatrix{
	\cal A	&\strut\vrule	&\cal B	\cr
	\noalign{\hrule}
	\cal C	&\strut\vrule	&\cal D\cr
	}^{-1} = \pmatrix{
	\ldots							&\strut\vrule	&\ldots\cr
	\noalign{\hrule}
	-\mat S^{-1}{\cal C}{\cal A}^{-1}	&\strut\vrule	& \mat S^{-1}\cr
},\qquad \mat S = {\cal D} - {\cal C}{\cal A}^{-1}{\cal B}\ .}{al block inverse}
The matrix $\tilde\mat S$ can be written
\eqref{\tilde\mat S = \pmatrix{
	\ddots	& 																		& \udots\cr
			& \sum_n {\tilde\mat\Ga_i}^{n^\T} \mat\si^n {\tilde\mat\Ga}_j^n 	& \cr
	\udots	& 																		& \ddots\cr
}\ ,}{al mat S}
where we have used
\eqref{\mat\si^n = \mat V^{n^{-1}} - \mat V^{n^{-1}} \mat\al^n({\mat\al^n}^\T \mat V^{n^{-1}} \mat\al^n)^{-1} \mat {\mat\al^n}^\T V^{n^{-1}}\ .}{al sigma n}
The second bit needed for \Eq{al P estimate exact} is
\eqref{\tilde\mat A^\T \mat V^{-1}\,\vec M = \pmatrix{
	\vdots\cr
	{\mat\al^n}^\T \mat V^{n^{-1}} \,\vec \mu^n\cr
	\vdots\cr
	\ln
	\vdots\cr
	\sum_n{\tilde\mat\Ga_j}^{n^\T} \mat V^{n^{-1}} \, \vec \mu^n\cr
	\vdots\cr
}\ .}{al vec ATm}
Putting all together yields
\eqref{\tilde\mat S \hat\vec\ch \equiv
\tilde\mat S \pmatrix{
	\vdots\cr
	\hat\vec\ch_j\cr
	\vdots\cr
}
=\tilde\vec T\ ,\qquad
\tilde\vec T = \pmatrix{
	\vdots\cr
	\sum_n {\tilde\mat\Ga_j}^{n^\T} \mat\,\mat\si^n\,\vec \mu^n\cr
	\vdots\cr
}
\ .}{al fit equation}

In fact, the elements of $\mat\si^n\,\vec \mu^n$ vector are residuals for the $n$-track divided by the corresponding measurement uncertainty. We will call this ratio \em{normalized residuals} and denote $\vec r^n$. The \em{full residuals} will be denoted by $\vec R^n$:

\eqref{\mat\si^n\,\vec \mu^n \equiv \vec r^n = \mat V^{n^{-1}} \vec R^n\ .}{al vec R}

It is worth mentioning some properties of the $\mat\si^n$ matrix -- it is symmetric, singular\footnote{%
Each column of $\mat\al^n$ provides a non-trivial solution to $\mat\si^{n} \vec w = 0$ and thus $\mat\si^n$ is singular (see e.g.~theorem 1.5.3 in \bref{anton}).} and its product with $\mat V^n$ is idempotent
\eqref{
	\mat\si^{n^\T} = \mat\si^n\ ,\qquad
	\mat\si^{n} \mat\al^n = 0\ ,\qquad
	(\mat V^n \mat\si^n)^2 = \mat V^n \mat\si^n\ .
}{al prop sigma n}

Above, we have assumed that the $\mat S$ matrix is regular (and thus the matrix inversion in \Eq{al P estimate exact} can be performed). However, in \Sc{al sing modes} we will demonstrate the opposite -- this just reflects the fact that certain misalignment are inaccessible to the track-based alignment. Despite the deficiency, the result \Eq{al fit equation} is almost correct. An easy way to see it is to plug \Eq{al vec mu} to the definition of $\tilde\vec T$ in \Eq{al fit equation}, it yields
\eqref{\tilde\vec T =
\pmatrix{
	\vdots \cr
	\sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \vec\mu^n\cr
	\vdots \cr
}
=
\pmatrix{
	\ddots & & \udots \cr
	 & \sum_n {\tilde\mat\Ga}_j^{n^\T} \mat\si^n \mat\Ga_i^n\cr
	\udots & & \ddots \cr
}
\vec\ch_i
=
\bar\mat S \vec\ch
}{al exact fit equation}

The only difference between $\tilde\mat S$ in \Eq{al fit equation} and $\bar\mat S$ in \Eq{al exact fit equation} is that $\tilde\mat S$ contains both $\mat\Ga$ matrices with tildes (see \Eq{al mat S}). This difference represents the error we make by the simplification step \Eq{al tau linearization}. Since the expected misalignments are small, the difference between $\mat\Ga$ and $\tilde\mat\Ga$ shall be small too and it is reasonable to expect that the solution $\hat\vec\ch$ of \Eq{al fit equation} would be close to the actual misalignments $\vec\ch$. The error can be reduced by taking several iterations, it will be discussed in \Sc{al err}.

Let us close this section with a simple example -- let us consider only the shifts in the read-out direction and a data sample where all sensors are active in all events. In such a case the coefficients $\ga^n = -1$ (cf. \Tb{al alignment quantities}) and thus matrices $\mat\Ga^n = -1$. Note that the $\ga^n$ coefficients are independent of the track parameters $\vec a^n$ and $\vec b^n$. Thus there is no need for the simplification \Eq{al tau linearization}, which effectively means $\tilde\mat S = \bar\mat S$ and there is no difference between the exact fit equation \Eq{al exact fit equation} and the simplified one \Eq{al fit equation}. They can be written (here the indeces $i,j$ identify the sensors):
\eqref{\tilde\mat S \hat\vec\ch = \tilde\vec T\ , \quad
	\tilde\mat S = \pmatrix{
		\ddots	&						&\udots	\cr
				& \sum_n\mat\si^n_{ij}	&		\cr
		\udots	&						&\ddots	\cr
	}\ ,\quad
	\hat\vec\ch = \pmatrix{
		\vdots\cr
		\De \hat s_j\cr
		\vdots\cr
	}\ ,\quad
	\tilde\vec T = \pmatrix{
		\vdots\cr
		\sum_n r^n_i\cr
		\vdots\cr
	}\ .
}{al fit eq ex}
Hence the $\tilde\vec T$ vector is given by the sum of the normalized residuals, the $\tilde\mat S$ embodies the relation between the residuals and the misalignment shifts $\De s_i$.

\TODO{Conclusion? Bridge to the next chapter}.

\subsection[al sing modes]{Singular and weak modes}

In the previous section we have derived the fit equation \Eq{al fit equation}. If the matrix $\mat S$ were regular, one could obtain the alignment parameters $\hat\vec\ch$ by means of matrix inversion. But let us look closer on the fit equation. Note that the sensors' measurements enter the \rhs{} in the form of residuals. That means that any misalignment mode that does not generate residuals can not be revealed by the track-based algorithm. These misalignment modes are those where the misalignments $\vec\ch_j$ can be compensated (keeping measurements $\vec\mu^n$ unchanged) by varying the track parameters $\vec\ta^n \to {\vec\ta '}^n$ (cf. \Eq{al vec mu}):
\eqref{\mat\al^n {\vec\ta}^n + \sum_j \mat\Ga_j^n \vec\ch_j = \vec\mu^n = \mat\al^n {\vec\ta'}^n\ .}{al tau chi equiv}
The $\mat\Ga$ matrices may depend on the track parameters (see \Tb{al alignment quantities}), writing that yields
\eqref{\sum_j \mat\Ga_j(\vec\ta^n)\, \vec\ch_j = \al^n\, (\underbrace{{\vec\ta'}^n - \vec\ta^n}_{\De\vec\ta^n})\ .}{al sm con}
If one can find a vector $\De\vec\ta^n$ for any set of track parameters $\vec\ta^n$, then from \Eq{al mat S} it follows
\eqref{
	\mat S \pmatrix{\vdots\cr \vec\ch_i\cr\vdots} = 
	\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \sum_j \mat\Ga_j^n\, \vec\ch_j \cr\vdots} =
	\pmatrix{\vdots\cr \sum_n {\mat\Ga_i^n}^\T \mat\si^n \mat \al^n\, \De\vec\ta^n \cr\vdots} = 0\ ,
}{al sm}
which is a direct consequence of \Eq{al prop sigma n}. This would mean that $\mat S$ is singular (see e.g.~theorem 1.5.3 in \bref{anton}), with $\vec\ch$ being an eigenvector corresponding to zero eigenvalue. This vector represents an misalignment mode that is not accessible to the track-based alignment. We will refer to such modes as \em{singular modes}.

Let us come back to \Eq{al sm con}. It is important is to find a $\De\vec\ta^n$ vector for any vector $\vec\ta^n$. No matter what the interpretation is for the latter one -- whether it is the vector of true or estimated track parameters, cf. \Eq{al tau linearization}. This is exactly what makes the difference between $\mat\Ga$ and $\tilde\mat\Ga$ and consequently among $\mat S$, $\bar\mat S$ and $\tilde\mat S$. And that is why the singular modes found in \Eq{al sm} are also singular modes for $\bar\mat S$ and $\tilde\mat S$ matrices.

Later, we will find useful to use the definition of the $\mat\al$ matrix \Eq{al mat alpha} and rewrite the \rhs{} of \Eq{al sm con} as
\eqref{\mat\al^n\, \De\vec\ta^n = \pmatrix{
	\vdots\cr
	\vec d_i \cdot (\De\vec a^n z_i + \De\vec b^n)\cr
	\vdots\cr
}, \quad i\hbox{ goes through all sensors involved in }n\hbox{-th event.}}{al sm track par}
The vectors $\De\vec a^n$ and $\De\vec b^n$ are merely an alternative description of the track-parameter variation $\De\vec\ta^n$, cf. \Eq{al vec tau}.

In the rest of this section we will identify all singular modes that may appear in the alignment of the RP sensors. We will first focus on the singular modes that arise from the interplay between the geometry of the detector apparatus and the geometry of the tracks. Afterwards we will turn our attention to the singular modes provoked by special (pathological) track distributions.

\caption{Geometrical singular modes}

In this part we will discuss the singular modes corresponding to each alignment quantity class, one by one. But prior to that, let us remark one characteristics of the RP sensors -- all of their nominal read-out directions are parallel (or anti-parallel) to either $U$ or $V$ axes (see \Sc{ttm}). This could be written as $\vec\d_i \in \{\pm U, \pm V\}$. We will consider a bit more general case, where the sensors, classified by their read-out directions, split into several \em{read-out groups}:
\eqref{\vec d_i \in \lbrace \pm\vec\de_1, \pm\vec\de_2, \ldots \rbrace \ ,
	%\qquad |\vec\de_i \cdot \vec\de_j| \neq 1\hbox{ for } i \neq j\ .
}{al read-out groups}
where the (non-collinear) vectors represent the read-out directions of each group. 

For \em{shifts in the read-out direction}, the condition \Eq{al sm con} reads (using \Eq{al sm track par})
\eqref{
	\De s_i \equiv
	\vec d_i \cdot \De\vec c_i =
	- \vec d_i \cdot ( \De\vec a^n z_i + \De\vec b^n )\ .
}{al sm shr sol}

Since the \lhs{} does not depend on the event number $n$, neither must the \rhs{}. That is why the ${\De\vec a}=(\De a_x, \De a_y)^\T$ and ${\De\vec b=(\De b_x, \De b_y)^\T}$ vectors do not need to carry a superscript. These two vectors define the structure of the singular modes -- they correspond to \em{global} ($\De\vec b$) and \em{linearly-progressive} ($\De\vec a\, z_i$) shifts in $x$ and $y$. By global shift we mean a shift that is common for all sensors. The size of a linearly-progressive shift is proportional to the $z$-position of a sensor. There are four free parameters, thereby four singular modes. The situation is illustrated in \Fg{al sing modes shr}.

\fig{fig/pdf/al_sing_modes_shr.pdf}{al sing modes shr}{An illustration of the singular modes \Eq{al sm shr sol}: a front view on a sensor package. Each sensor is represented by a dot (its center $\vec c$) and an arrow (its read-out direction $\vec d$), cf.~the front view in \Fg{al proton sensor interaction}. The hollow dots mark the nominal positions, the solid ones represent the misalignment mode. For simplicity we have considered a simplified package of six sensors only (see the numbers), moreover with an equal spacing $\De z$. The $U$ (red) and $V$ (blue) sensors are regularly alternating, the first one is at $z = 0$.}

\em{Shifts in $z$}. Writing the condition \Eq{al sm con} for each read-out group yields
\eqref{\vec\de_g \cdot \vec a^n \De z_i = \vec\de_g \cdot (
	\De\vec a^n\, z_i + \De\vec b^n
)\ ,\qquad\hbox{for sensors }i\hbox{ from group }g\ .}{al sm shz con grp}
Since this shall hold for all $\vec a^n$, the ratio $\vec\de_g\cdot\De\vec a^n / \vec\de_g\cdot\vec a^n$ must be $n$-independent. On the other hand, it can be different for every group. Formally written (the treatment of the $\De\vec b^n$ term is identical):
\eqref{
{\vec\de_g\cdot\De\vec a^n \over \vec\de_g\cdot\vec a^n} = \al_g\ ,\qquad
{\vec\de_g\cdot\De\vec b^n \over \vec\de_g\cdot\vec a^n} = \be_g\ .
}{al sm shz ratio}
The above relation determines what the $\De\vec a^n$ vector should be for a given track slope vector $\vec a^n$ and a set of $\al_g$ parameters. In fact, there is one such a relation per one read-out group. This should be compared to the rank of the $\De\vec a^n$ vector -- it is two-dimensional. That means that for one group only, that there is an infinite number of solutions ($\De\vec a^n$ vectors that fulfil \Eq{al sm shz ratio}). For two groups, there is one and unique solution. From \Eq{al sm shz con grp} one can read off the corresponding singular modes:
\eqref{\De z_i = \al_g z_i + \be_g\ ,\qquad\hbox{for sensors }i\hbox{ from group }g\ ,}{al sm shz sol 2g}
For more than two groups there is generally no solution (it is an over-constrained problem). However, if the $\al_g$ parameters are equal for all the read-out groups, the equation has a solution: $\De\vec a^n = \al \vec a^n$. It corresponds to singular modes:
\eqref{\De z_i = \al z_i + \be\ .}{al sm shz sol 3g}
In fact, these are just special cases of the singular modes \Eq{al sm shz sol 2g}, therefore they are present for any type of geometry (any number of read-out groups). Both types of the singular modes are illustrated in \Fg{al sing modes shz}, for a summary see \Tb{al sing mode overview}.


\fig{fig/pdf/al_sing_modes_shz.pdf}{al sing modes shz}{An illustration of the singular modes \Eq{al sm shz sol 2g,al sm shz sol 3g}: a top view on a sensor package, cf.~\Fg{al proton sensor interaction}. Each sensor is represented by a dot (its center $\vec c$) and an arrow (the $x$ projection of its read-out direction $\vec d$). The hollow dots mark the nominal positions, the solid ones represent the misalignment mode. For simplicity we have considered a simplified package of six sensors only (see the numbers), moreover with an equal spacing $\De z$. The first sensor is at $z = 0$.
Left: the case with two read-out groups, as in the nominal geometry the $U$ (red) and $V$ (blue) sensors are alternating regularly.
Right: a hypothetical situation with a third read-out group added (sensor four drawn in green).
}

\em{Rotations around $z$}. When applying the condition \Eq{al sm con} one shall keep both rotation and read-out-direction shift misalignments. It will turn out that they can not be separated. Written for each read-out group the condition reads:
\eqref{
	\De\rh_i\, \vec \de_{\perp_g} \cdot (\vec a^n z_i + \vec b^n - \vec c_i) =
	\vec\de_g \cdot (
		\De\vec a^n\, z_i +
		\De\vec b^n +
		\De\vec c_i
	)\ .
}{al sm rotz con}
In any realistic (non-pathological) geometry the vectors $(z_1, z_2, \ldots)^\T$, $(c_{x,1}, c_{x,2}, \ldots)^\T$, $(c_{y,1}, c_{y,2},\ldots)^\T$ and $(1, 1, \ldots)^\T$ are linearly independent. This means that the above condition can only be fulfilled if the coefficients to these vectors are equal on both sides of the equation:
\eqref{
	\De\rh_i\, \vec\de_{\perp_g} \cdot \vec a^n = \vec\de_g \cdot \De\vec a^n\ ,\qquad
	\De\rh_i\, \vec\de_{\perp_g} \cdot \vec b^n = \vec\de_g \cdot \De\vec b^n\ ,\qquad
	- \De\rh_i\, \vec\de_{\perp_g} \cdot \vec c_i = \vec\de_g \cdot \De\vec c_i\ .
}{al sm rotz con sep}
The first two relations require $\De\rh_i$ to be constant within every read-out group: $\De\rh_i \rightarrow \De\rh_g$. Moreover they are very similar to \Eq{al sm shz ratio} and so is the interpretation. For one group only there exists infinitely many solutions (vectors $\De\vec a^n$ and $\De\vec b^n$ that obey \Eq{al sm rotz con sep}). For two groups, there is exactly one solution. For more than two groups, the equation is, generally over-constrained and with no solution. The only exception occurs if $\De\rh_g$ is the same for all groups, then the equation is solved by $\De\vec a^n = \De\rh (-a^n_y, a^n_x)^\T$, etc.

The third relation in \Eq{al sm rotz con sep} gives the read-out-direction shift accompanying the rotation singular modes:
\eqref{\De s_i \equiv \vec d_i \cdot \De\vec c_i = - \De\rh_i\, \de s_i\ ,\qquad \de s_i = \vec d_{\perp_i} \cdot \vec c_i\ .}{al sm rotz shr}
The reason for this shift is that the singular mode is a rotation about the $z$ axis, but the alignment rotations are performed about sensors' centers, displaced by $\vec c_i$ from the $z$ axis.

The singular modes can then be summarized
\eqref{
\pmatrix{
	\De\rh_i \cr
	\De s_i
	}
= \De\rh_g \pmatrix{
	1\cr
	- \de s_i
}
\ .}{al sm rotz sol}
For three and more groups, $\De\rh$ is a constant, thus there is just one singular mode. For two groups, the values of $\De\rh_g$ are independent for each group, therefore there are two singular modes. The situation is illustrated in \Fg{al sing modes rotz}, a summary can be found in \Tb{al sing mode overview}.

\fig{fig/pdf/al_sing_modes_rotz.pdf}{al sing modes rotz}{An illustration of the singular modes \Eq{al sm rotz sol}: a front view on a sensor package. Each sensor is represented by a dot (its center $\vec c$) and an arrow (its read-out direction $\vec d$), cf.~the front view in \Fg{al proton sensor interaction}. The hollow dots and dashed arrows/lines show the nominal positions and read-out directions, the full dots and solid arrows represent the misalignment mode. For simplicity we have considered a simplified package of six sensors only (see the numbers), note that often they lie on top of each other in the drawing. Left: the case with two read-out groups, like in the nominal geometry, the $U$ (red) and $V$ (blue) sensors are alternating regularly. The $\De\vec c$ vector shows the accompanying read-out-direction shift \Eq{al sm rotz shr}. Right: a hypothetical situation with a third read-out group (sensor 4 drawn in green).
}

To illustrate the structure of the singular modes we have made a number of MC studies. We have considered a series of geometries, starting with the nominal one and adding rotation misalignments to all sensors. These mis-rotations have been randomly generated according to a normal distribution with a variable variance. Going from zero variance to positive values represents a smooth transition from a geometry with two read-out groups to geometries with more groups. For certain alignment modes this means a transition from singular to non-singular state, see \Fg{al eig rho}.

A convenient way to visualize the structure of the $\tilde\mat S$ matrix is to plot its eigenspectrum. The singular modes are represented by zero eigenvalues, the modes accessible to the track-based alignment by non-zero values. In fact the eigenvalues have an important meaning for the alignment application. To unveil it, let us rewrite the fit equation \Eq{al fit equation} in ``eigen coordinates'' -- coordinates relative to an orthonormal set of $\tilde\mat S$ eigenvectors. Denoting $\mat Q$ a matrix containing this set as columns, one can write (see e.g.~Eq.(6.85) in \bref{barnett}):
\eqref{
	\mat D\, \hat\vec\ch^{\rm E} = \tilde\vec T^{\rm E}\ ,\qquad
	\hat\vec\ch^{\rm E} = \mat Q^\T \hat\vec\ch\ ,\qquad
	\tilde\vec T^{\rm E} = \mat Q^\T \tilde\vec T\ ,
}{al fit eq eigen}
where $\mat D$ is a diagonal matrix containing the eigenvalues $\la$ of $\tilde\mat S$. The $\hat\vec\ch^{\rm E}$ and $\tilde\vec T^{\rm E}$ vectors are the vectors $\hat\vec\ch$ and $\tilde\vec T$ expressed in the ``eigen coordinates''. Since $\mat D$ is diagonal, the fit equation has a simple form, written for the $m$-th alignment mode:
\eqref{\hat\ch^{\rm E}_m = {\tilde T^{\rm E}_m\over \la_m} \longrightarrow {\tilde T^{\rm E}_m + \De\tilde T^{\rm E}_m \over \la_m}\ .}{al fit eq eigen one}
If $\la_m = 0$, the equation cannot be solved -- the mode $m$ is a singular mode. However one may expect troubles even if $\la_m$ is non-zero but small. One should keep in mind that the $\tilde T^{\rm E}$ is built from measurements, see \Eq{al fit equation}, and as such it is subject to an experimental error. Formally, this is expressed by adding the $\De\tilde T^{\rm E}_m$ term on the \rhs{} above. If $\la_m$ is small, the ratio $\De\tilde T^{\rm E}_m/\la_m$ may grow large, in other words $\hat\ch^{\rm E}_m$ can only be determined with a large uncertainty. In that sense, the eigenvalue $\la_m$ controls the determination power of the alignment mode $m$. If the eigenvalue is small, the determination is weak -- that is why we will call these modes \em{weak modes} in what follows. For a more complete discussion of the uncertainties, see \Sc{al err}.

Whereas the singular and weak modes are very different from the theoretical point of view, they look the same for computer programs. Any numerical calculation of eigenvalues has a limited accuracy (we have used ROOT matrix libraries \bref{root matrix} at double precision). Therefore the eigenvalues corresponding to singular modes are found small but non-zero. In order to distinguish between regular and singular (or very weak) modes one thus needs to set a finite \em{singular limit}. \Fg{al eig rho} shows that a value of $10^{-9}$ is reasonable.

It reasonable to expect that the eigenvalues of $\tilde\mat S$ would be proportional to the number of events $N_{\rm events}$. To have results event-number independent, it makes sense to define \em{normalized eigenvalues}:
\eqref{\la_{\rm N} = \hbox{eigenvalue of }\tilde\mat S/N_{\rm events}\ ,}{al S norm eig val}
which are used in \Fg{al eig rho}.


\fig{fig/pdf/al_eigenvalues_rho.pdf}{al eig rho}{\TODO{correct eq numbers}. The spectrum of normalized eigenvalues of the $\tilde\mat S$ matrix ($\la_{\rm N}$) as a function of geometry. The geometries considered have been created from the nominal one-station geometry by applying rotation misalignment to each sensor. The misalignments have been randomly generated according to a normal distribution with zero mean and variance $\si^2_\rh$ -- the quantity on the horizontal axis. The case $\si_\rh = 0$ corresponds to the nominal geometry, which contains two read-out groups. Increasing $\si_\rh$ then represents a smooth transition to configurations with three and more read-out groups.
The colors correspond to the eigenvalue order (bottom-top). Therefore, when two curves representing two alignment modes cross, they exchange their colors (e.g. the mode (4.47) in the bottom plot).
% Theta 10 mrad, geometry 2.7x3.3, overlap=f
}

\caption{Pathological track distributions}

Besides the singular modes derived above, there could be singular modes arising from special track distributions. One could immediately think of a case where the sensors split into several groups such that no track can go through sensors of different groups at a time. Regarding RPs, this situation may appear when the pots are not inserted close enough and therefore no track can go through the overlap between the vertical and horizontal pots. In this case, the alignment task would split into several smaller tasks (one per group) and for each of them one could write an alignment equation like \Eq{al fit equation}. Each of these equations contains a $\tilde\mat S$ matrix with its singular modes as discussed above. Therefore the number of singular modes gets multiplied by the number of groups.

The LHC proton tracks are very parallel (see e.g. \Tb{al lhc datasets}). In other words the distribution of the track slopes $\vec a^n$ is peaked about a mean value $\bar\vec a$ with a spread (in either projection)
\eqref{\si_a = \O{10^{-4}\un{rad}}\ .}{al sm a dist}
Let us reexamine the condition for rotation singular modes \Eq{al sm rotz con} when the spread $\si_a\to 0$:
\eqref{
	\De\rh_i\, \vec \de_{\perp_g} \cdot (\bar\vec a z_i + \vec b^n - \vec c_i) =
	\vec\de_g \cdot (
		\De\vec a^n\, z_i +
		\De\vec b^n +
		\De\vec c_i
	)\ .
}{al sm rotz con la}
Again, we will compare the coefficients to the vectors vectors $(z_1, z_2, \ldots)^\T$, $(c_{x,1}, c_{x,2}, \ldots)^\T$, $(c_{y,1}, c_{y,2},\ldots)^\T$ and $(1, 1, \ldots)^\T$ on both sides. For \Eq{al sm rotz con} there was only one way to do it, here is another one. It comes from the fact that $\bar\vec a z_i$ term is not $n$-dependent. Therefore it can be absorbed into the $\De\vec c_i$ term on the \rhs Then, $\vec b^n$ can be linked to $\De\vec a^n$, this requires $\De\rh_i$ to be proportional to $z_i$. Denoting $\al_i$ the proportionality constant, the condition splits into three:

\eqref{
	\al_i\, \vec\de_{\perp_g} \cdot \vec b^n = \vec\de_g \cdot \De\vec a^n\ ,\qquad
	0 = \vec\de_g \cdot \De\vec b^n\ ,\qquad
	\al_i z_i\, \vec\de_{\perp_g} \cdot (\bar\vec a - \vec c_i) = \vec\de_g \cdot \De\vec c_i\ .
}{al sm rotz con sep la}
The first relation is very similar to the first one from \Eq{al sm rotz con sep} and so the interpretation is. First, the proportionality constant must be constant within each read-out group: $\al_i\to \al_g$. Second, for one group only, there are infinitely many solutions $\vec\De a^n$ for every $\vec b^n$. For two groups, there is exactly one solution. For three and more groups the problem is generally over-constrained, having a solution only if $\al_g$ is the same for all the read-out groups.

The third relation in \Eq{al sm rotz con sep la} determines the read-out-direction shift that accompanies the rotation singular modes. They can be summarized:
\eqref{
\pmatrix{
	\De\rh_i \cr
	\De s_i
	}
= \al_g z_i \pmatrix{
	1\cr
	\vec d_{\perp_i} \cdot (\bar\vec a - c_i)
}
\ .}{al sm rotz sol la}
For two groups, the $\al_g$ parameters are independent for both groups. There are thus two more singular modes. For three and more groups, the values of $\al_g$ must be the same for all groups, therefore there is just one new singular mode.

Note that the $\De s_i$ part of the rotation singular vectors \Eq{al sm rotz sol,al sm rotz sol la} can be compensated by the read-out-direction shift singular modes \Eq{al sm shr sol}. It is therefore sufficient to consider the rotation singular modes in a form:
\eqref{\De\rh_i = \al_g z_i + \be_g\ .}{al sm rotz full sol}
$\be_g$ (equivalent of $\De\rh_g$ in \Eq{al sm rotz sol}) represents a global rotation, $\al_g$ leads to a linearly-progressive rotation.

\TODO{ref to \Fg{al sing modes rotz al}, for a summary see \Tb{al sing mode overview}.}

\fig{fig/pdf/al_sing_modes_rotz_al.pdf}{al sing modes rotz al}{An illustration of the singular modes \Eq{al sm rotz full sol}: a front view on a sensor package. Each sensor is represented by a dot (its center $\vec c$) and an arrow (its read-out direction $\vec d$), cf.~the front view in \Fg{al proton sensor interaction}. The hollow dots and dashed arrows/lines show the nominal positions and read-out directions, the full dots and solid arrows represent the misalignment mode. For simplicity we have considered a simplified package of six sensors only (see the numbers), moreover with an equal spacing $\De z$. There are two read-out groups (like in the nominal geometry): the $U$ (red) and $V$ (blue) sensors are regularly alternating, the first one is at $z = 0$. For three and more groups the situation looks very similar, only the $\al$ and $\be$ parameters are the same for all the groups. To keep the figure simple, we assumed $\bar\vec a = 0$, that is why all detector centers lie on a circle.
}

Unlike the geometrical singular modes, the modes \Eq{al sm rotz sol la} are singular for $\mat S$ and $\bar\mat S$ only, not for $\tilde\mat S$. The reason is that the transition \Eq{al tau linearization} from true to estimated track parameters brings in an experimental error (finite resolution of the sensors and their misalignment). Thus even if the true tracks were perfectly parallel, the reconstructed ones would be not. Consequently the modes \Eq{al sm rotz sol la} correspond only to small, but non-zero eigenvalues of $\tilde\mat S$ -- they are weak modes.

\Fg{al eig theta} shows a transition from almost parallel (low $\si_a$) to non-parallel tracks (high $\si_a$). There are two alignment modes very sensitive to the angular track spread $\si_a$ -- see the labelled blue and red curves. Regarding the $\mat S$ matrix (left panel), these modes become singular in the parallel limit $\si_a \to 0$. Not so for the $\tilde\mat S$ matrix (right panel). The eigenvalues stop reducing at about $\si_a\approx 1\un{\mu rad}$, which compares well to the angular resolution of a station. This saturation demonstrates the effect discussed in the previous paragraph. A similar saturation takes place (in both panels) at the high-$\si_a$ end. It starts about $\si_a \approx 10\un{mrad}$, which corresponds well to the maximal angle which can be detected by both near and far units. Thus tracks with higher angles can not contribute to an alignment of a station.

\fig{fig/pdf/al_eigenvalues_theta.pdf}{al eig theta}{Spectra of normalized eigenvalues ($\la_{\rm N}$) of the $\mat S$ (left) and $\tilde\mat S$ (right) matrices, with only the read-out-direction shifts and rotations included. The spectra are plotted as a function of the track-angle spread $\si_a$ (same values used for $x$ and $y$ projections). Zero value of the spread means perfectly parallel tracks. The simulations have been done for a RP station of the nominal geometry (two read-out groups). For more groups there would be just one line instead of the labeled red and blue curves. The vertical dotted line marks the typical slope spread in the LHC data.
% shr\_rotz=0. 2.7x33, overlap=f
}

It would be possible to draw a similar line of arguments for a situation where $\vec b^n\to \bar\vec b = $ const. But keeping in mind the application to LHC proton tracks, this turns out to be very unrealistic scenario.

At the end, let us remark that parallel tracks do not introduce new weak modes for the shifts in the read-out directions. The corresponding singular mode condition \Eq{al sm shr sol} is completely independent of the track slopes $\vec a^n$, therefore their vanishing spread makes no difference. Regarding the shifts in $z$, it makes little sense to consider the case of parallel tracks -- there the $z$-shifts can not be determined at all. The singular and weak modes for all considered configurations are summarized in \Tb{al sing mode overview}.

\htab{al sing mode overview}{An overview of the singular and weak modes. The bold numbers give the number of singular/weak modes that are listed afterwards. The ''gl.'' abbreviation stands for ''global'' which is used to refer to a mode with constant coefficients for every sensor. The ''l.p.'' stands for ''linearly-progressive'' which means a mode the coefficients of which are proportional to $z_i$. Note that the additional modes for the parallel-track case are weak only.
\TODO{one read-out group: such det. apparatus can determine one track projection only}
\TODO{parallel tracks make no sense for $z$-shifts}
}{
\omit&\multispan{4}\bhrulefill\cr
\omit			&\multispan2\bvrule\strut\hfil two read-out groups\hfil &\multispan2\strut\vrule\hfil three and more read-out groups\hfil\cr
\omit\bhrulefill&\multispan{4}\hrulefill\cr
						& \hbox{non-parallel tracks} & \hbox{parallel tracks} & \hbox{non-parallel tracks} & \hbox{parallel tracks} \cr\bln
\hbox{read-out shifts}	&\multispan4\bvrule\hfil {\bf 4}: $x$ and $y$ global and linearly progressive shifts\hfil\cr\ln
%
&\hbox{{\bf 2}: gl. rot.}  &\hbox{{\bf 4}: gl. and l.p. rots.} &\hbox{{\bf 1}: gl. rot.} &\hbox{{\bf 2}: gl. and l.p. rot.} \cr
\omit\vbox to 0pt{\vss\hbox{ rotations about $z$ }\vss}&\multispan4\cr
& \hbox{for $U$ and $V$ indep.} & \hbox{for $U$ and $V$ indep.}&&\cr\ln
%
& \hbox{{\bf 4}: gl. and l.p.} &  & \hbox{{\bf 2}: gl. and l.p.}  & \cr
\hbox{shifts in }z	& \hbox{shifts in }z &-& \hbox{shift in }z&-\cr
& \hbox{for $U$ and $V$ indep.} &&&\cr\bln
}

\subsection[al constr]{Constraints}

In the previous section we have shown that the $\tilde\mat S$ is singular, which expresses the fact that some alignment modes are inaccessible to the track-based alignment. To accomplish the alignment task -- to solve the \Eq{al fit equation} -- one thus needs to supply information about the inaccessible (singular) modes from another source. This information may be formulated in a form of additional \em{constraints} (to the alignment solution $\hat\vec\ch$) which compensates the singularity of the $\tilde\mat S$ matrix. We will consider a set of linear constraints

\eqref{
	\mat C^\T \hat\vec\ch = \vec V\ ,\qquad
	\mat C = \pmatrix{
		\vdots\cr
		\vec c_i^\T\cr
		\vdots\cr
	}\ ,\qquad
	\vec V = \pmatrix{
		\vdots\cr
		v_i\cr
		\vdots\cr
	}
\ ,}{al constraints}
where $\vec c_i$ and $v_i$ are the constraint vectors and values ($i$ enumerates the constraints). The constraints require that the ``projection'' of the solution $\hat\vec\ch$ to the ``direction'' $\vec c_i$ is $v_i$. We have used the quotes since we do not require the vectors $\vec c_i$ to be of unit size. Still we find this interpretation of the constraints quite intuitive.

The fit equation \Eq{al fit equation} has been derived by pursuing a least squares fit simultaneously for misalignment and track parameters, see \Sc{al sim fit}. Now introducing the constraints, we have to deal with a constrained least squares problem. It can be addressed by the Lagrange-multipliers technique (see e.g.~\bref{Millepede}):
\eqref{
	\pmatrix{
		\tilde\mat S & \mat C \cr
		\mat C^\T & 0\cr
	}
	\pmatrix{
		\hat\vec\ch \cr
		\vec\La \cr
	}
	=
	\pmatrix{
		\tilde\vec T\cr
		\vec V\cr
	}
\ ,}{al alignment equation}
where $\vec\La$ is a vector of Lagrange multipliers. The bottom row expands to the constraints requirement \Eq{al constraints}. Expanding the upper row yields the fit equation \Eq{al fit equation} with a small modification:
\eqref{
	\tilde\mat S \hat\vec\ch = \tilde\vec T - \mat C \vec\La\ .
}{al mod fit eq}
The presence of the Lagrange multiplier term can guarantee the existence of a solution for any $\tilde\vec T$. As we have shown, the $\tilde\mat S$ is singular, let us put all its singular vectors into columns of an $\mat E$ matrix. Then, it holds $\tilde\mat S \mat E = 0$. The $\tilde\mat S$ matrix is also symmetric, thus one may write
\eqref{\mat E^\T (\tilde\vec T - \mat C\vec\La) = \mat E^\T \tilde\mat S = \mat E^\T \tilde\mat S^\T = (\tilde\mat S \mat E)^\T = 0\ .}{al T no sing cont}
This is where the Lagrange multipliers can help to fulfill the condition. In order to find a vector $\vec\La$ for any vector $\tilde\vec T$, one gets a requirement on the set of constraints:
\eqref{\mat E^\T \mat C\hbox{ must be regular}\ .}{al ETC reg}

In this way we can be sure that \Eq{al mod fit eq} has a solution. Since $\tilde\mat S$ is singular, we know there are infinitely many solutions. According to theorem 5.5.2~in \bref{anton}, they can be parameterized
\eqref{\hat\vec\ch(\vec\et) = \vec\ch^0 + \mat E \vec\et\ ,}{al sol param}
where $\vec\ch^0$ is a particular solution and $\vec\et$ are the parameters in the nullspace of $\tilde\mat S$. Another requirement we want to imply on the set of constraints $\mat C$ is to determine the solution $\hat\vec\ch$ uniquely. By inserting the above parameterization to \Eq{al constraints}, one finds that the requirement is equivalent to asking $\mat C^\T \mat E$ to be regular, which is further equivalent to \Eq{al ETC reg}.
%\eqref{\vec\et = (\mat C^\T \mat E)^{-1} (\vec V - \vec C^\T \vec\ch^0)}{cnst aux8}

If we neglect the experimental errors that enter the $\tilde\vec T$ vector, it can be calculated from \Eq{al exact fit equation}: $\tilde\vec T = \bar\mat S \vec\ch$. We recall that $\vec\ch$ is the vector of true (not estimated) residuals. As the singular modes of $\tilde\mat S$ and $\bar\mat S$ are the same, one finds that $\bar\mat S E = 0$ too. Consequently, \Eq{al T no sing cont} leads to $\La = 0$. If the experimental errors are not neglected, the relation becomes only approximative: $\La \approx 0$. This provides a consistency check that may be used during real data analysis.

So far we have focused on constraining the singular modes. Looking back to \Eq{al fit eq eigen one} we remind that there might be also weak modes, which would still allow for a solution, however they would severely deteriorate the accuracy. In such a situation, one might want to constrain some of the weak modes too. In principle, the alignment equation \Eq{al alignment equation} still may be used. But since the number of constraints and the number of singular modes is different now, the results \Eq{al ETC reg} and onwards can not be applied.

\vskip1cm\hrule\vskip1cm


\iffalse
To solve the fit equation \Eq{fit equation}, one has to imply additional constraints that would regularize the $\mat S$ matrix. For the alignment task, these constraints may be for example metrology or laser measurements. Such constraints may be written in the following form
\eqref{\vec c \cdot \hat\vec\ch = v\ ,}{cnst form}
where the vector $\vec c$ describes the structure of the constraint and $v$ contains the measurement outcome. \TODO{resolution effects, measurement wrt. det. center}

To solve the fit equation with constraints, it is advantageous to employ the Lagrange multipliers technique (\TODO{reference}). It suggests to expand the fit equation to \TODO{T with tilde}
\eqref{\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
} \pmatrix{
\hat\vec\ch \cr
\vec\La \cr
} = \pmatrix{
\vec T\cr
\vec V\cr
}\ ,}{alignment equation}
where the $\mat C$ matrix contains the $\vec c$ vectors (see \Eq{cnst form}) in columns for all constraints applied and vector $\vec V$ includes corresponding $v$'s. $\vec\La$ is the vector Lagrange multipliers. Let's demonstrate that this equation does what we want. First, let's rewrite as two equations
\eqref{\tilde\mat S \hat\vec\ch = \vec T - \mat C \vec\La \equiv \vec T'(\vec\La)\ ,}{cnst aux1}
\eqref{\mat C^\T \hat\vec\ch = \vec V\ .}{cnst aux2}
The second one obviously presents a series of constraints of type \Eq{cnst form}. Since $\mat S$ is symmetric (\TODO{ref}), it can be diagonalized as follows (see e.g. \bref{wikipedia} key \em{symmetric matrix})
\eqref{\mat S = \mat Q \mat D \mat Q^{-1}, \qquad
\mat D = \diag(\underbrace{0, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}}; \underbrace{\la_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}}), \qquad
\mat Q = (\underbrace{\vec s_1, \ldots}_{\vbox{\hbox{singular}\hbox{modes}}} ; \underbrace{\vec r_1, \ldots}_{\vbox{\hbox{regular}\hbox{modes}}})
\ ,}{cnst aux3}
where we have ordered the eigenvalues and eigenvectors such that all singular modes go first. Let's remark that we don't require eigenvectors for the same eigenvalue to form an orthonormal set (although we could). This will enable us to work with singular modes as derived above (without ortnormalizing them). Since $\mat Q$ is regular, one can put
\eqref{\mat D \mat Q^{-1} \hat\vec\ch = (\mat Q^\T \mat Q)^{-1} \mat Q^T \vec T'(\vec\La)}{cnst aux4}
and expand the parts for singular vectors
\eqref{
\pmatrix{
\ddots & & & \vrule & \cr
& 0 & & \vrule & \cr
& & \ddots & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\mat Q^{-1} \hat\vec\ch = 
\pmatrix{
& & & \vrule & \cr
& (\mat E^\T \mat E)^{-1} & & \vrule & \cr
& & & \vrule & \cr
\noalign{\hrule}
 & & & \vrule & \ddots \cr
}
\pmatrix{
\cr
\mat E^\T\cr
\cr
\noalign{\hrule}
\vdots\cr
}
\vec T'(\vec\La)
\ .}{cnst aux5}
(The $\mat E$ matrix contains the singular vectors $\vec s_i$ in columns). The part above the vertical line on the \lhs{} is identically equal to zero and thus so the \rhs{} must be. Considering that $\mat E^T \mat E$ is regular \TODO{why}, one finds
\eqref{\mat E^\T \vec T = \mat E^\T \mat C \vec\La\ .}{cnst aux6}
In order to find solution $\vec\La$ for any $\vec T$,
\eqref{\mat E^\T \mat C\hbox{ must be regular}\ .}{cnst condition}
This condition defines what constraints may be used. We will discuss some convenient choices later on.

For the moment, let's get back to \Eq{cnst aux1}. (As $\vec\La$ has been resolved from \Eq{cnst aux6}, $\vec T'$ is known.) This equation has infinite number of solutions that can be written
\eqref{\hat\vec\ch(\vec\et) = \vec\ch^0 + \mat E \vec\et\ ,}{cnst aux7}
where $\vec\ch^0$ is a particular solution and $\vec\et$ are parameters in the solution space of the homogeneous equation. Inserting that to \Eq{cnst aux2} yields
\eqref{\vec\et = (\mat C^\T \mat E)^{-1} (\vec V - \vec C^\T \vec\ch^0)}{cnst aux8}
and therefore \Eq{alignment equation} has always a unique solution that satisfies all constraints \Eq{cnst form}.

Now it would be nice to show that the actual misalignments can play the role of $\vec\ch^0$. Unfortunately, this is the case only for shifts in the read-out direction. For the other misalignment classes it is violated because of the linearization step \Eq{tau linearization} -- see section \Sc{fit equation}. Combining \Eq{exact fit equation,cnst aux6} yields
\eqref{\vec\La = (\mat E^\T \mat C)^{-1} \mat E^\T \bar\mat S \vec\ch_a\ .}{cnst aux9}
If we were not forced to make the linearization step \Eq{tau linearization}, $\mat E$ would contain singular vectors of $\bar\mat S$ and thus their product would be identically zero. Then, $\vec\La = 0$, $\tilde\vec T = \vec T$ and \Eq{cnst aux1} would become trivial
\eqref{\tilde\mat S \hat\vec\ch = \tilde\mat S \vec\ch_{\rm a}\ ,}{cnst aux10}
which demonstrates that $\vec\ch_{\rm a}$ could play the role of the particular solution $\vec\ch^0$.

\TODO{Even with the linearization step, we will be assuming the same singular vectors for $\tilde\mat S$ as for $\bar\mat S$, thus $\vec\La = 0$ and the particular would obey
\eqref{\tilde\mat S \vec\ch^0 = \bar\mat S \vec\ch_{\rm a}}{cnst aux11}
$\vec\ch^0$ close to $\vec\ch_{\rm a}$ ...
}
\fi

We have seen that a set of constraints \TODO{for singular modes!} must fulfill \Eq{cnst condition}, but one has still a lot of freedom in their choice. Let's list here a few common options.

\> Probably the most natural choice is to take singular modes as the constraints, that is $\mat C = \mat E$. We will refer to this option as \em{homogeneous constraints} (the role of all detectors is equal, in contrary to the next options). \TODO{sing modes only, or one can include weak modes too}
\par\parindent\itindent\indent\hang As an example, we write explicitly the $\mat E$ matrix considering the read-out-direction shifts only. Taking the singular modes from \Eq{al sm shr sol}, the matrix can read
\eqref{\mat E = \pmatrix{
	\vdots		& \vdots		& \vdots	& \vdots \cr
	d_{ix} z_i	& d_{iy} z_i	& d_{ix}	& d_{iy} \cr
	\vdots		& \vdots		& \vdots	& \vdots \cr
}\ ,\qquad i\hbox{ going through all detectors.}}{al hom cnst ex}

\> Another natural choice is to select a subset of reference sensors, fix their positions and let the other sensors align with respect to the reference ones. We will call this option \em{fixed-detectors constraints}. \TODO{sing or sing+weak modes}
\par\parindent\itindent\indent\hang For an example, we consider again a case with read-out-direction shifts only. There we face four singular modes, thus we need to fix the positions of four detectors, let us take first two and last two:
\eqref{\mat E = \pmatrix{
	1		& 0			& 0 		& 0 		\cr
	0		& 1			& 0 		& 0 		\cr
	\vdots	& \vdots	& \vdots	& \vdots	\cr
	0		& 0			& 1 		& 0 		\cr
	0		& 0			& 0 		& 1 		\cr
}\ ,\qquad i\hbox{ going through all detectors.}}{al hom cnst ex}

\> \TODO{sing+weak modes}
 The last option is called \em{final constraints} since it has been used for the final alignment analysis (and the elastic scattering analysis presented in \Sc{felm}).
\Fg{al eig rho,al eig theta} suggest that, in standard conditions ($\De\rh_i = \O{5\un{mrad}}$, $\si(\vec a)=\O{0.1\un{mrad}}$), it is not possible to determine the rotation between U and V detectors and between near and far unit
%(following the weak mode \Eq{cnst rotz lt2} and the large $z$ difference between the units). 
with satisfactory precision. \TODO{Use \Fg{al err shz theta,al err rotz rho,al err rotz theta} instead}. Thus one needs to constrain these modes too, increasing the number of rotation constraints to 4 (one constraint per U/V projection and per unit). The number of read-out shift constraint remains 4, but they will be a little different than the homogeneous constraints. The reason is that we trust the beam position determination by the touching exercise and therefore we want to preserve the vertical center between the top and bottom pots. Consequently, we will drop \TODO{say it better} the horizontal pot from the vertical ($Y$) constraints. In fact we will drop the horizontal RP from the horizontal ($X$) constraints too. Since there is only one horizontal pot, the touching exercise cannot determine the horizontal beam position with a sufficient precision and the best (least bad) assumption is to keep the vertical pots (horizontally) at their nominal position. To summarize, for every unit, we will impose these 4 constraints:
\eqref{\eqnarray{
\hbox{shifts:}\qquad && \sum_{i\ \in\ \hbox{top, bottom}} \De s_i \, d_{x_i} = \sum_{i\ \in\ \hbox{top, bottom}} \De s_i \, d_{y_i} = 0\ ,\cr
\hbox{rotations:}\qquad && \sum_{i\ \in\ \hbox{U detectors}} \De \rh_i = \sum_{i\ \in\ \hbox{V detectors}} \De \rh_i = 0\ .
}}{al final constraints}
\TODO{mean x, y shift, mean rotation is zero, explicit C?}

\iffalse
The final set of constraints differs from the others in the sense that it includes some weak modes too. This means that the dimensions of the $\mat E$ and $\mat C$ matrices are different and one can not apply the arguments from the beginning of this section. The condition \Eq{cnst aux6} still remains valid, however, it does not fully determine $\vec\La$ and consequently \Eq{cnst aux7} does not hold. If all constraint vectors $\vec c$ were perpendicular to all regular modes $\vec r_i$ (like for homogeneous constraints), then one could obtain a generalization
\eqref{\hat\vec\ch(\vec\et_E, \vec\et_W) = \vec\ch^0 + \mat E \vec\et_E + \mat W \vec\et_W\ ,}{cnst gen sol space}
where the $\mat W$ matrix contains weak modes as columns. In this case, the $\vec\et$ parameters are still fully determined by the constraint values $\vec V$. However, fixed-detectors and final constrains do not fall even to this category and thus the difference $\hat\vec\ch - \vec\ch^0$ depends on the details of the $\mat S$ matrix. That means that the solution depends on the sample used. In other words, over-constraining may give rise to an extra error. \TODO{negligible in our case}.
\fi

For the last comment, let's recall that the $\mat S$ scales with the number of events $N_{\rm events}$ (see \Eq{S norm eig val}). In order to simplify the interpretation of the eigenvalues of the alignment matrix (see \Eq{alignment equation}), it is advantageous to let the $\mat C$ matrix scale with $N_{\rm events}$ too. This effectively means to use
\eqref{\mat C = N_{\rm events}\, \mat C^0\ ,}{C scaled}
where $\mat C^0$ is one of the constraint choices above, which does not scale with the number of events.

\subsection[al err]{Errors}

%\TODO{
%Generally - I want to show that the algorithm is performing well:
%\> no systematics under ideal circumstances
%\> errors under control
%}

Any error that might appear can be of two origins only -- \em{approximations} and \em{neglected effects} (multiple scattering, DAQ problems etc.). One can check the presence of problems of the latter type by dividing the sample into a number of subsamples. If results obtained from the subsamples are not compatible with each other, these effects are important (however, in \Sc{al exp res} we will see it is not the case). 

Let's review the approximations we have made while developing the alignment equations.
\bitm
\itm We have completely neglected the \em{pitch rounding}, described by \Eq{full measurement}.
\itm We have \em{linearized the rotation matrix}, see \Eq{small rotation approximation}.
%$$(\cos\rh_i - 1) \vec\d_i^\T (\vec h^n - \vec c_i)$$
\itm The $\hat\mat\Ga$ matrices include \em{biased track parameters}, see \Eq{tau linearization}.
%$$\vec\d_{\perp_i}^\T \left[ (\vec a^n - \hat\vec a^n) z_i - (\vec b^n - \hat\vec b^n) \right]$$
\eitm

The pitch rounding is a gentle effect -- the error is smaller than the half of the pitch $P$. This is to be compared to with hit distribution that is several centimeters wide \TODO{relative error is very small}. In the first approximation one could assume that the error is
\eqref{\eqnarray{
&\bullet \hbox{ a random variable uniformly distributed on } (-P/2, +P/2) \hbox{ and}\cr
&\bullet \hbox{ the errors in different detectors are independent.}\cr
}}{pitch error model}
Especially the second one is not really true, but we will see (in \Fg{al stat fixDet} for instance) that it leads to satisfactory results though.

An important property of the pitch error is that the errors in different events are independent. That is
%(event if one keeps the same track distribution and geometry)
if one doubles the sample, the errors in the second half will be independent of those in the first half. As a consequence, one may assume better results with increasing sample size. As rule of thumb, the error should be proportional to $1/\sqrt N$ where $N$ is the sample size. That is why the pitch rounding error is of \em{statistical} nature.

The other two error sources (approximations 2) and 3)) do not behave in this way. In contrary, one can assume that the final error would be independent of the sample size
%(provided that track distribution and geometry and misalignments remain the same)
. Therefore, the rotation-matrix linearization and biased $\ga$ coefficient lead to a \em{systematic} error.

The above statements are hypothesis only, we will illustrate their validity with a number of Monte-Carlo tests below (see \Sc{al mc tests})

The rotation-matrix linearization is an 2nd-order effect. If $\De\rho\approx 10\un{mrad}$ and $h\approx 2\un{cm}$ would be typical rotation misalignment and hit position, then the error would be of order $\De\rho^2\,h/2\approx 1\un{um}$. This is to be compared with the bias in the $\ga$ coefficients, the order of which is $\De\rho h \approx 20\un{\mu m}$. Thus the linearization effect is rather small and we will neglect it in what follows.


\caption{Statistical uncertainty estimate}
%\ssubsection[al stat unc]{Statistical uncertainty estimate}

The solution of the alignment task is given by \Eq{alignment equation}. Here, there are two quantities that are subject to statistical uncertainties: $\vec T$ and $\vec V$. The uncertainty of $\vec T$ vector is propagated from the measurements $\vec M^n$ through \Eq{fit equation}. The assumptions about measurement errors have been summarized in the pitch error model \Er{pitch error model}. $\vec V$ is an outcome of an external measurement and as such it is likely to subject to certain uncertainty. All these uncertainties can be propagated to the uncertainty of the result $\hat\vec\ch$.

Eq\hbox{.} (4.19) on page 60 in \bref{barlow} reads
$$\vec y = \mat A\vec x \qquad \Rightarrow \qquad \Var\vec y = \mat A\ \Var\vec x\ \mat A^\T\ .$$
This can be directly applied to \Eq{alignment equation}:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\Var \pmatrix{\tilde\vec T\cr\vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}
Since $\tilde\vec T$ and $\vec V$ are independent and $\Var \tilde\vec T = \tilde\mat S$ \TODO{explain}, one obtains:
\eqref{\Var \pmatrix{\tilde\vec\ch\cr \vec\La} = 
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}
%
\pmatrix{\tilde\mat S& 0\cr 0 & \Var \vec V}
%
\pmatrix{
\tilde\mat S & \mat C \cr
\mat C^\T & 0\cr
}^{-1}\ .
}{alignment equation err prop}
The uncertainties of the $\vec\ch$ vector components can be found on the diagonal of the matrix above:
\eqref{\si(\bar\ch_i) = \sqrt{\Var \pmatrix{\bar\vec\ch\cr\vec\La}_{i\,i}}}{al par unc}

\caption{Iterations}

\TODO{motivation}

\Tb{al iter} shows the principle of iterations. The symbol $\vec\ch$ represents a state of the alignment, that is geometrical corrections to be applied on the basic geometry. The numerical subscripts refer to the order of an iteration, $\vec\ch_0$ stands for the initial alignment \TODO{guess or zeros}. The correction obtained in $i$-th iteration is denoted $\De \vec\ch_i$. The expression in the right-hand side column summarizes our understanding of the errors. That is the correction shall be equal to the difference between the actual alignment $\vec\ch$ and the pre-iteration alignment $\vec\ch_{i-1}$ (modulo constraints -- filter matrix ${\cal F}_{\rm constr}$ \TODO{explain easily}) altered by the statistical ($\De \vec\ch_{\rm stat}$) and systematic ($\De \vec\ch_{\rm syst}$) errors. For a given sample the statistical error (given by the pitch rounding) is constant (when not changing the cut parameters which would modify the sample). The systematic error depends on ''how far we are from the actual alignments,'' that is $\vec\ch - \vec\ch_i$. The iterations continue as long as the corrections are important (their size is larger than a limit). In the LHC data analysis presented in \Sc{al exp res}, two iterations turned out to be sufficient. That is the correction in the third one was already negligible.

After the iteration process has converged, the final error still have two components -- the statistical and the systematic. The latter one is proportional to the distance to the actual alignments. The distance can not vanish because of two reasons -- the constraints (some alignment modes remain undetermined) and the statistical error. \Fg{al syst err uv rot,al syst err fn rot} show the systematic errors due to undermined $U$-$V$ and far-near unit rotations. \TODO{The systematic error induced by the statistical error -- probably small!}

\tab[\strut\hfil#\qquad&#\hfil\qquad&#\hfil\cr]{al iter}{A scheme of alignment iterations with the error evolution.}{\ln
			& alignment & correction \cr\ln
			& $\vec\ch_0$ \cr
iteration 1	& $\downarrow$	\cr
			& $\vec\ch_1 = \vec\ch_0 + \De \vec\ch_1$ & $\De \vec\ch_1 = {\cal F}_{\rm constr} (\vec\ch - \vec\ch_0) + \De \vec\ch_{\rm stat} + \De \vec\ch_{\rm syst}(\vec\ch - \vec\ch_0) $ \cr
iteration 2	& $\downarrow$	\cr
			& $\vec\ch_2 = \vec\ch_1 + \De \vec\ch_2$ & $\De \vec\ch_2 = {\cal F}_{\rm constr} (\vec\ch - \vec\ch_1) + \De \vec\ch_{\rm stat} + \De \vec\ch_{\rm syst}(\vec\ch - \vec\ch_1) $ \cr
			& $\vdots$	\cr
(last) iteration n	& $\downarrow$	\cr
			& $\vec\ch_n = \vec\ch_{n-1} + \De \vec\ch_n$ & $|\De \vec\ch_n| < \hbox{limit}$ \cr\ln
}


\subsection[al mc tests]{Monte-Carlo tests}

In the previous section the errors of the algorithm have been discussed. To support our hypotheses we will use Monte-Carlo simulations now. But before, we will briefly review how these simulations are performed and evaluated.

Since full Geant4 would take an enormous time, we used a simplified fast simulation which is described in \Sc{fast simu}. Random tracks have been generated at $z=217\un{m}$ (station 56-220 used). Their slopes $a_{x, y}$ were generated with gauss distribution with $\si$ either $0.1\un{mrad}$ (realistic scenario\TODO{reference}) or $10\un{mrad}$ (the highest angle that can be detected simultaneously in both units). Their intercepts $b_{x, y}$ have been generated with either uniform distribution on $ -20\un{mm} < x, y < +20\un{mm}$ or Gauss distribution with $\si_x = 6\un{mm}$ and $\si_y = 8\un{mm}$. The latter distribution represents a more realistic scenario, where the tracks cumulate close to the beam. The quoted RMS have been chosen to approximately match the experimental distributions. \TODO{the nominal pitch of $66\un{\mu m}$, \pmt{dscrWidth}$=10\un{\mu m}$ and \pmt{dscReduceUncertainty} = False were used}. 

\TODO{We haven't used G4 as it would take too long time. What difference may one expect compared to the G4 simulations/real data?}

The simulations could have been run with the pitch rounding on or off (the rounding in \Eq{full measurement} applied or not). Also, the $\ga$ parameters could have been calculated from the fitted track parameters (biased) or from the original generated track (non-biased). While the combination with pitch rounding on and biased parameters corresponds to the \em{real} alignment application, the combination with no pitch rounding and non-biased parameters corresponds to the \em{reference} results.

We have performed a number of simulations to explore the influence of various parameters. For every settings, the simulation has been repeated 20 times with different random seeds. For every repetition, we have calculated real results with their uncertainty and reference results. This provided us with a statistical sample on which we evaluated
\eqref{\vbox{\halign{\quad\strut#\qquad&#\quad\cr\ln
quantity & label\cr\ln
\hbox{mean(real result - reference result)}	& \hbox{systematic error} \cr
\hbox{sigma(real result - reference result)}& \hbox{statistical error} \cr
\hbox{mean(uncertainty)} 					& \hbox{estimated uncertainty} \cr\ln
}}}{al stat quan def}
the term sigma is used as square-root of variance here, the full formulae used can be found in \Sc{stat estim}. The \rhs{} column lists the labels that will be used for these quantities.

An example of such a statistical study can be seen in \Fg{al stat fixDet}. Here we chose fixed-detectors type of constraints, with rotations fixed only in the near unit. This is the reason for much higher errors in the far unit (bottom part). Let us make three important observations. First, the systematic error is compatible with zero within the estimated error \TODO{with a small exception}. Second, the estimated uncertainty falls as $1/\sqrt{N_{\rm tracks}}$. Third, the ratio of statistical error to estimated uncertainty is almost flat, but below the expected value of one. This means that the uncertainty estimated with the help of the model \Er{pitch error model} is overestimated. However, the most important observation was the first one, that there is no bias.

This was just an example, for other conditions and settings the results confirm the observations above. Another example can be found in \Fg{al stat final}.

\fig{fig/pdf/al_stat_fixDet.pdf}{al stat fixDet}{A statistical study of the alignment algorithm. We imposed a set of fixed-detectors constraints (for read-out shifts we fixed planes 1200, 1201, 1248 and 1249, for rotations 1200 and 1201). Every curve corresponds to the 3rd plane of a pot, see the legend. The near/far unit plots are at the top/bottom of the figure. The filled areas show $1\si$ error bands. The vertical dotted line marks a typical number of events in LHC runs.
%[20 repetitions, geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad, 3 iterations]
}

It has been revealed by \Fg{al eig rho} that the $\mat S$ eigenvalues related to the $z$ shifts are rather low. One can, thus, expect large alignment errors and, indeed, \Fg{al err shz theta} confirms this expectation. The uncertainty never falls below $1\un{m}$ \TODO{compare to the misalignment expectation}. For the realistic beam divergence (dashed vertical line) the uncertainty is of the order of $10\un{m}$, which effectively means that there is no way to perform $z$-shift alignment.

Let us remark one feature of \Fg{al err shz theta} that is common for all $\si(\vec a)$ dependences -- the saturation above $\si(\vec a) \gs 10\un{mrad}$. The reason is simple, the $10\un{mrad}$ is roughly the maximum angle that can be detected by both units. Thus tracks of higher angles do not contribute.

\fig{fig/pdf/al_err_shz_theta.pdf}{al err shz theta}{The estimated uncertainty of $z$ shifts as a function of the track divergence $\si(\vec a)$. Simulations performed with $10^5$ \TODO{realistic} events and fixed-detectors constraints (fixed planes for $z$-shifts: 1200, 1201, 1248 and 1249). Solid lines correspond to planes near the RP entry (2 or 3), while \TODO{NO} dashed near the RP exit (6 or 7).  The dotted vertical line shows the realistic angular track spread.
%No misalignment, fix-ext constraints (rotz in 1200, 1201; shz in 1200, 1201, 1248 and 1249), extfit=f. 1000 events, uncertainties scaled down by 10 to simulate LHC-realistice number of events 10^5
}

A similar situation takes place for relative $U$-$V$ rotations (see the rising $\mat S$ eigenvalue in \Fg{al eig rho}). \Fg{al err rotz rho} then confirms the expectation of large uncertainty of the rotation between $U$ and $V$ planes. In these simulations we modified the basic geometry -- instead of the nominal rotations $\rh_i$ we used $\rh_i + \de\rh_i$, where $\de\rh_i$ were randomly generated according to Gaussian distribution with zero mean and variance as indicated on the horizontal axes. Let us focus on the rotations in the near unit only (the far-near rotation issues will be discussed later, e.g. in \Fg{al err rotz theta}). Since we fixed the rotation of plane 1200, which is a $V$ plane, the uncertainties of all $V$ planes stays low (see the left plot). For $U$ planes one finds similar uncertainties for $\de\gs 0.1\un{rad}$ only. As one approaches the nominal geometry, the uncertainty grows almost like $1/\si(\de\rh)$. The expected rotational deviations from the nominal geometry are $\si(\de\rh) \approx 5\un{mrad}$ (see the vertical dotted lines). At this point, the $U$ uncertainties are about $10$ times larger that the $V$ ones. For typical LHC runs one can expect $10^5$ tracks, which give reduction factor of $10$ with respect to the uncertainties in the figure. This would mean $U$-$V$ rotation uncertainties of the order of $1\un{mrad}$, which is the misalignment expectation. Therefore the track-based alignment is unable to provide reasonable corrections to the relative $U$-$V$ rotations.

\fig{fig/pdf/al_err_rotz_rho.pdf}{al err rotz rho}{The estimated uncertainty of rotations about $z$ as a function of $\si_\rh$ ($\de\rh$ gives the detector rotation difference from the nominal geometry). Simulations done with $10^5$ \TODO{realistic} events, fixed-detectors constraints and $\si_a = 0.1\un{mrad}$. The fixed for rotations was 1200 (a $V$ plane). Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7). (The dashed lines are mostly covered by the solid ones in this picture.) The vertical dotted line shows the realistic deviation from the nominal geometry.
%No misalignment (misaligned and real geometry contain detectors rotated with the given rho distribution). 1000 events, uncertainties scaled down by 10 to simulate LHC-realistice number of events 10^5. Extfit=false. fix-bas
}

If \Fg{al eig theta} we have seen that the eigenvalues of the linearly-progressive rotations depend strongly on the track divergence $\si(\vec a)$. Recalling the RP station geometry \TODO{reference} one can see the large gap in $z$ between the near and far units. These two facts may make us expect large uncertainties of the relative far-near rotation in the case of very parallel tracks. This is demonstrated in \Fg{al err rotz theta}. The uncertainties get saturated above $\approx 10\un{mrad}$, below they roughly follow $1/\si(\vec a)$. The lowest uncertainties can be found in the near top and bottom pots (the fixed planes are in the top RP). The near horizontal pot takes a bit higher uncertainty, it is $??\un{cm}$ downstream from the near verticals. The uncertainty of all the far pots is about $10$ times higher than of the near horizontal. If we take the typical LHC track divergence (vertical dotted line) and number of tracks ($10^5$), we are left with the far-pot rotation uncertainty of the order of $1\un{mrad}$. Since the misalignment estimate is\TODO{??}, it turns out that track-base alignment can not improve our knowledge of the far-near rotation.

\fig{fig/pdf/al_err_rotz_theta.pdf}{al err rotz theta}{The estimated uncertainty of rotation about $z$ as a function of the track divergence $\si(\vec a)$. Simulations performed with $10^5$ \TODO{realistic} events and fixed-detectors constraints (fixed planes for rotations: 1200 and 1201). Solid lines correspond to planes near the RP entry (2 or 3), while dashed near the RP exit (6 or 7). The dotted vertical line shows the realistic track divergence.
%No misalignment, extfit=f.  1000 events, uncertainties scaled down by 10 to simulate LHC-realistice number of events 10^5.
}

As already revealed by \Fg{al stat fixDet}, the systematic error is practically negligible. But still, let us explore it a bit more in detail. As discussed in \Sc{al err}, the systematic errors may arise either from the linearization of the rotation matrix, which gives a negligible contribution, or from undetermined alignment modes (they bias the $\ga$ coefficients). With the final constraints the are two types of undetermined modes: $U$-$V$ and far-near rotations. 

To study the systematic errors due to undetermined $U$-$V$ rotation, we have a created a set of misalignments scenarios. They all have had no read-out shift misalignment. The mis-rotations: common UV part -- of order $1\un{mrad}$,  zero mean for $V$ detectors, mean for $U$ detectors non-zero. This makes rotation between U and V planes, as indicated on the horizontal axes in \Fg{al syst err uv rot}. One can see the errors are practically zero for $U$ detectors (solid lines), but non-zero for $V$ (detectors). This can be easily understood from the form of the $\ga$ coefficient for rotations (see \Tb{alignment quantities}) -- it contains the direction perpendicular to the read-out one. And in the nominal geometry, the direction perpendicular to $U$ is $\pm V$ and vice versa. Hence by neglecting (not determining) the rotations of $U$ detectors, one biases the $\ga$ coefficients for $V$ detectors (and gives raise to the related error).

\fig{fig/pdf/al_syst_err_uv_rot.pdf}{al syst err uv rot}{Systematical errors due to undetermined $U$-$V$ rotation $\De_{U-V}\rh$. The simulations have done with $\si_a = 0.1\un{mrad}$ \TODO{LHC-realistic}, final constraints and a special track distribution -- uniform on $0\un{mm}<x<10\un{mm}$ and $-20\un{mm}<y<20\un{mm}$. This distribution is closer to the typical LHC one and, moreover, amplifies the effect. Every curve corresponds to a detector in the near top RP \TODO{the biggest error there} ($V$ detectors are dashed, $U$ solid).
%geometry 2.7x3.3, Jan(round=f, extfit=f) - Jan(f, t), 3 iterations
}

A similar study has been performed for the far-near rotations, the results are in \Fg{al syst err fn rot}. Again, the misalignment scenarios had no read-out shifts. The rotations in the near unit $~1\un{mrad}$. The same rotations in the far unit had the same sigma, but the mean as indicated on the horizontal axes of the figure. The figure is showing the results for the top far RP, for the near unit the effects are smaller by an order. The fact that the $V$ detectors have very low error is just a coincidence.
\TODO{Note the increasing difference between U and V detectors.}

\fig{fig/pdf/al_syst_err_fn_rot.pdf}{al syst err fn rot}{Systematical errors due to undetermined far-near rotation $\De_{F-N}\rh$. The simulations have done with $\si_a = 0\un{mrad}$ \TODO{LHC-realistic}, final constraints and a special track distribution (the same as in \Fg{al syst err uv rot}). Every curve corresponds to a detector in the far top RP \TODO{the biggest error there} ($V$ detectors are dashed, $U$ solid).
%geometry 2.7x3.3, 3 iterations, Jan(round=f, extfit=f) - Jan(f, t)
}

\Fg{al err rotz rho,al err rotz theta} gave us the motivation to use the final constraints, \Fg{al syst err uv rot,al syst err fn rot} reassured us that there is no relevant systematic error. To conclude this section, we include an equivalent of \Fg{al stat fixDet}, but with the use of the final constraints: \Fg{al stat final}. The interpretation is equivalent too: no systematic error and slightly overestimated uncertainty.

\fig{fig/pdf/al_stat_final.pdf}{al stat final}{A statistical study of the alignment algorithm with the final constraints. Every curve corresponds to the third plane of a RP, see the legend. The filled areas represent $1\si$ error bands. The vertical dotted lines mark the typical number of tracks in LHC runs.
%(20 repetitions), geometry 2.7x3.3, misalignment rotz4, gauss6,8, 0.1mrad.
}


\subsection[al data sel]{Input data selection}

With the fast Monte-Carlo one a priory knows that there was exactly one track per event and that all detector hits belong to this track. Consequently all track-fit residuals follow from misalignments. This is not true for real data. There might be a number of tracks per event, moreover different in every RP. There might be a number of hits that do not belong to any particle track -- noise, data corruption. That is why it is necessary to select carefully the input for the track-based alignment. It is better to loose some statistics than to bias the results with false input.

The selection algorithm has two components: hit selection and event selection. In the first one some hits are removed, since they are doubtful. In the latter one, entire events are dropped.

The hit selection is integrated with track fitting and can be described as follows.
\bitm
\itm Input: the collection of all hits from all detectors and all RPs.
\itm Local track fit (parameterization \Eq{local track}).
\itm Outlier removal: remove all points for which
\eqref{m_i - \hat m_i > \pmt{maxResidualToSigma}\, \si(m_i)\ ,}{al outlier cond}
where $\hat m_i = \vec d_i \cdot (\hat\vec a^n z_i + \hat\vec b^n)$ is the track interpolation and $\si(m_i)$ is the corresponding measurement error. \pmt{maxResidualToSigma} is a parameter of the algorithm.
\itm Remove all hits from RPs where there are less hits per projection than a given limit\break \pmt{minimumHitsPerProjectionPerRP}.
\itm If some points have been removed, go back to step 2. Stop otherwise.
\eitm

The event selection starts with a $\ch^2$ cut, that is all events with track fits the $\ch^2/\hbox{n.d.f.}$ of which exceeds a limit \pmt{chiSqPerNdfCut} are discarded. Then, there are few optional (they can be switched on or off) boolean checks, see \Tb{al alg flags}.

\tab[\strut\hfil#\ &#\hfil\cr]{al alg flags}{The boolean settings of alignment data selection.}{\ln
parameter							& meaning\cr\ln
\pmt{removeImpossible} 				& remove events with signal in a top and a bottom pot simultaneously\cr
\pmt{requireBothUnits} 				& require signal in both units\cr
\pmt{requireOverlap} 				& require signal in the overlap between horizontal and vertical pots\cr
\pmt{requireAtLeast3PotsInOverlap}	& if there is signal in the overlap, require signal in at least three pots\cr\ln
}

\TODO{
\> iterations, making cuts more strict
\> the cuts -- depend on situation, don't give values here but only later
}

\subsection[al rp fac]{Roman Pot alignment}

The basic structures in the track-based alignment are the detectors (sensors). Only these provide measurements and only these can be aligned. On the other side, the sensors are inserted (per groups) in RPs and thus, they share (per groups) common misalignments. One could, therefore, try to extract these common misalignments and call them \em{RP alignments}. However, this should be still understood in the sense of common shifts and rotations of the sensors in a RP. In no way, the track-based alignment can determine the positions of inactive elements, like the thin window.

\fig{fig/pdf/al_rp_misalignment.pdf}{al rp misalignment}{A side view on a RP (for simplicity only 4 planes are drawn). The displaced detectors are drawn in black, their centers are marked with dots. The centers of non-displaced detectors are shown as gray dots. The blue arrows represent $\vec c_i$ vectors from \Eq{al rp de c}. The green arrow represents the RP shift $\vec s^{\rm RP}$.}

Any RP misalignment can be decomposed to the shift of its center $\vec s^{\rm RP}$ and the rotation about its center. The rotation can be represented by a matrix $\mat R^{\rm RP}$, an equivalent of the rotation matrix for sensors (cf.~\Eq{global to local}). Let us define the center of a RP ($\vec c^{\rm RP}$) as the mean of its sensors' centers. The RP misalignments are naturally inherited by all sensors of this RP, but moreover, the rotation may give rise to additional shifts, see \Fg{al rp misalignment}. The center of $i$-th detector is
\eqref{\vec c'_i = \mat R^{\rm RP} (\vec c_i - \vec c^{\rm RP}) + \vec c^{\rm RP} + \vec s^{\rm RP}\ ,}{al rp c'}
where $\vec c$ would be its nominal center (without the RP misalignment). The only non-negligible component of $\vec c_i - \vec c^{\rm RP}$ vector is the $z$ one. Furthermore, since the expected mis-rotations are of the order \TODO{?? reference}, we can use the approximation \Eq{rotation parameterization approximated} for the rotation matrix $\mat R^{\rm RP}$. Then, keeping only $x$ and $y$ components, one finds
\eqref{\De\vec c_i \equiv \vec c'_i - \vec c_i = \vec s^{\rm RP} + \pmatrix{\rh_y^{\rm RP}\cr \rh_x^{\rm RP}} z_i^{\rm eff}, \qquad z_i^{\rm eff} = c_{z_i} - c_z^{\rm RP}\ .}{al rp de c}
Since the sensors are placed in RPs in regular $z$ intervals, one can expect the shifts to be linearly dependent on the plane number. And indeed, this can be seen in experimental data, for example in \Fg{al comp det per unit}. The shifts in read-out direction (this is what is determined by track-based alignment) can be compactly written
\eqref{
\pmatrix{\vdots\cr \De s_i\cr \vdots} = \mat F \pmatrix{s_x^{\rm RP}\cr s_y^{\rm RP}\cr \rh_x^{\rm RP}\cr \rh_y^{\rm RP}\cr}, \qquad
\mat F = \pmatrix{
\vdots & \vdots & \vdots & \vdots\cr
d_{x_i} & d_{y_i} & d_{x_i}\,z_i^{\rm eff} & d_{y_i}\,z_i^{\rm eff} \cr
\vdots & \vdots & \vdots & \vdots\cr
}\ ,}{al rp fit matrix}
where $i$ lists all sensors in the given RP. The last equality can easily be combined with the Least Squares method in order to determine the RP misalignments from experimental data:
\eqref{\pmatrix{s_x^{\rm RP}\cr s_y^{\rm RP}\cr \rh_x^{\rm RP}\cr \rh_y^{\rm RP}\cr} = (\mat F^\T \mat V^{-1} \mat F)^{-1} \mat F^\T \mat V^{-1} \pmatrix{\vdots\cr \De s_i\cr \vdots}\ ,}{al rp fit}
where $\mat V$ is the covariance matrix of the $\De s$ vector. The results of the track-based alignment is on the r.h.s. and the LS estimate on the l.h.s. 

As it has been said above, all sensors in a pot inherit its rotation misalignment. Since we can determine sensors' rotations about $z$, we can extract the RP rotation by simply taking the mean rotation
\eqref{\rh_z^{\rm RP} = {\sum_i {\rh_{z_i}\over \si^2_i} \over \sum_i {1\over\si_i^2}}\ .}{al rp rotz fit}
Again, $i$ lists all sensors in the given RP and $\si_i$ abbreviates the uncertainty of $\rh_{z_i}$.

Some results extracted from the LHC data can be found in \Fg{al comp rp all rot}.

\TODO{why slopes not extracted, why errors not used : they are used in the end!}

\subsection[al exp res]{Experimental results}

\caption{Internal alignment comparison}
%\ssubsection{Internal alignment comparison}

There are 3 sources: optical metrology, beam and cosmic tests in H8 and LHC data.

\vskip\baselineskip
\em{Optical metrology}

The position of the detectors within the RP assembly has been measured. There are 3 reference points on a detector and one point on the RP. For each detector a zoomed high resolution photo was taken and a relative position of the points 1 and 2 (see \Fg{opticalMetrology}) and the RP reference point was measured. Theoretical values and results are summarized in \Tb{metrology theoretical}. The precision of this measurement is $\approx 10\un{\mu m}$.

\fig{fig/pdf/opticalMetrology.pdf}{opticalMetrology}{An illustration of the optical metrology measurement. \TODO{points on detector or hybrid?} \TODO{add mark photo}}

\tab{metrology theoretical}{The theoretical values for the optical measurement of RPs (the positions of the fiducial marks).}{\bln
\multispan{2}\strut\bvrule\hfil reference point 1\hfil&\multispan{2}\strut\vrule\hfil reference point 2\hfil& \omit\bvrule\hfil control\hfil\cr
\multispan4\hrulefill&\cr
x\un{(mm)}	& y\un{(mm)}	& x\un{(mm)}	& y\un{(mm)}	& \omit\bvrule\hfil\ distance (mm)\hfil\	\cr\bln
75.068 & 31.631 & 25.932 & 31.631 & 49.136\cr\bln
}

\iffalse
\eqref{\hbox{control distance}\ d_c = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}}{metrology distance}

\fig{fig/pdf/opticalMetrologyControlDistance.pdf}{opticalMetrologyControlDistance}{The distribution of the control distance around the theoretical value (the dashed line) -- a measure of the statistical uncertainty.}

If one assumes that the uncertainty of a measurement in any direction is $\si_m$, then the error of the control distance is approximately $\si_m \sqrt2$. This follows from the error propagation via \Eq{metrology distance} and considering that $y_2-y_1\approx 0$ while $x_1-x_2\approx d_c$. Then, the distribution in \Fg{opticalMetrologyControlDistance} suggests that $\si_m \approx 1\un{\mu m}$. However, since the measurements enter \Eq{metrology distance} in differences, this error estimate is only valid for rotations as defined by \Eq{metrology rot}. For shifts, we will keep the more conservative estimate $10\un{\mu m}$
\fi

Shifts and rotations are extracted as follows
\eqref{\hbox{rotation} = {y_2 - y_1\over x_2 - x_1}}{metrology rot}
\eqref{x\hbox{ shift} = {x_1 + x_2\over 2} - \bar x,\qquad y\hbox{ shift} = {y_1 + y_2\over 2} - \bar y}{metrology shift}
where $\bar x$ and $\bar y$ are the arithmetic means of the theoretical values displayed in \Tb{metrology theoretical}

\htab{al opt uv rot}{Mean $U$-$V$ rotations determined from the optical metrology. Values in $\rm mrad$.}{\bln
\hbox{DP}	 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12\cr\ln
\De_{U-V}\rh & -0.13 & 0.51 & -0.07 & 0.00 & 0.19 & -0.24 & -0.21 & -0.08 & -0.10 & 0.06 & 0.03 & -0.08\cr\bln
}

\vskip\baselineskip
\em{H8 tests}

These are beam-test and/or cosmics ray data taken at H8 \TODO{explain H8}. The tests were done with one pot at a time.

The track-based alignment has been done with the following settings:
{\itskip0pt\itindent=\parindent
\> \pmt{minimumHitsPerProjectionPerRP} = 4,
\> \pmt{removeImpossible} = True,
\> \pmt{requireBothUnits} = False,
\> \pmt{requireOverlap} = False and
\> \pmt{requireAtLeast3PotsInOverlap} = False.
}

In total 5 iterations have been performed. In the first two only the read-out shifts have been optimized, in the rest the rotations about $z$ have been added. Some of the cuts have been made increasingly more strict, see \Tb{al H8 iter par}. \TODO{Justify the choice of the values}.
\htab{al H8 iter par}{The iteration-dependent alignment parameters as used in the H8 data analysis. s stands for read-out shifts, r for rotations about $z$.}{\bln
\hbox{iteration}&1 & 2 & 3 & 4 & 5\cr\bln
\hbox{quantities optimized}& \rm s & \rm s & \rm s+r & \rm s+r & \rm s+r \cr
\hbox{\pmt{maxResidualToSigma}}&10 & 7 & 3 & 3 & 3\cr
\hbox{\pmt{chiSqPerNdfCut}}&50 & 25 & 5 & 5 & 5\cr\bln
}

We have applied fixed-detector constraints. The fixed planes for read-out shifts were 0, 1, 8 and 9 (for every RP), same planes for rotations about $z$. We have made an attempt to fix only two planes for rotations (0 and 1), but the linearly-progressive rotation turned out to be badly constraint, spoiling the results -- see \Fg{al comp det per pot dp1 ext}.

\tab{al H8 stat}{Some statistics on the H8 data.}{\bln
\hbox{detector} & \hbox{later installed}  & \hbox{particle} & \hbox{events} & \hbox{events} & \si(a_x) & \si(a_y)\cr
\hbox{package} & \hbox{as RP}             & \hbox{type} & \hbox{total} & \hbox{used} & \rm mrad & \rm mrad\cr\bln
\hbox{1}  & \hbox{45-220-far-hor}  & \hbox{muons} & 2\cdot10^{4} & 1\cdot10^{4} & 4.9 & 4.9\cr\ln
\hbox{2}  & \hbox{56-220-far-hor}  & \hbox{muons} & 4\cdot10^{4} & 2\cdot10^{4} & 3.4 & 3.9\cr\ln
\hbox{3}  & \hbox{56-220-far-bot}  & \hbox{cosmics} & 9\cdot10^{2} & 4\cdot10^{2} & 53.4 & 53.1\cr\ln
\hbox{4}  & \hbox{56-220-far-top}  & \hbox{cosmics} & 6\cdot10^{2} & 3\cdot10^{2} & 55.3 & 53.5\cr\ln
\hbox{5}  & \hbox{56-220-near-top} & \hbox{cosmics} & 4\cdot10^{2} & 2\cdot10^{2} & 54.6 & 53\cr\ln
\hbox{6}  & \hbox{56-220-near-bot} & \hbox{cosmics} & 4\cdot10^{2} & 1\cdot10^{2} & 56.7 & 45.2\cr\ln
\hbox{7}  & \hbox{56-220-near-hor} & \hbox{cosmics} & 6\cdot10^{2} & 3\cdot10^{2} & 52.8 & 54.5\cr\ln
\hbox{8}  & \hbox{45-220-near-hor} & \hbox{muons} & 2\cdot10^{5} & 3\cdot10^{4} & 2.6 & 2.7\cr\ln
\hbox{9}  & \hbox{45-220-far-top}  & \hbox{muons} & 3\cdot10^{4} & 1\cdot10^{4} & 2.1 & 2.1\cr\ln
\hbox{10} & \hbox{45-220-far-bot}  & \hbox{muons} & 2\cdot10^{4} & 7\cdot10^{3} & 2.2 & 2.8\cr\ln
\hbox{11} & \hbox{45-220-near-top} & \hbox{muons} & 1\cdot10^{4} & 4\cdot10^{3} & 2.6 & 2.1\cr\ln
\hbox{12} & \hbox{45-220-near-bot} & \hbox{muons} & 6\cdot10^{4} & 2\cdot10^{4} & 2.3 & 2.1\cr\bln
}

\vskip\baselineskip
\em{LHC runs}

Track-based alignment with the same settings as for H8 data applied on the LHC runs (see \Tb{al lhc datasets})


\fig{fig/pdf/al_comp_det_per_pot_dp2_ext.pdf}{al comp det per pot dp1 ext}{An attempt to determine the $z$ rotations with one fixed plane per projection (planes 0 and 1).}

\fig{fig/pdf/al_comp_det_per_pot_dp1_ext2.pdf}{al comp det per pot dp1 ext2}{Internal alignment comparison for DP1 (an example of bad match). All LHC points are overlapping (one can see only the top orange) and thus only few data-sets are shown.
%ext2 constraints
}

\fig{fig/pdf/al_comp_det_per_pot_dp2_ext2.pdf}{al comp det per pot dp2 ext2}{Internal alignment comparison for DP2 (an example of good match). All LHC points are overlapping (one can see only the top orange) and thus only few data-sets are shown.
%ext2 constraints
}

\TODO{A conclusion:
\> compatibility of results?
\> which rotations can be determined - no way for U-V? Difficult event last-first plane.
}

\caption{LHC data analysis}
%\ssubsection{LHC data analysis}

To analyze the LHC data we selected the runs with horizontal RPs in, see \Tb{al lhc datasets}. \TODO{Usually the horizontal RPs were inserted in the very end, sometimes the beam died even before.} The alignment was applied with the following parameters:
{\itskip0pt\itindent=\parindent
\> \pmt{minimumHitsPerProjectionPerRP} = 4,
\> \pmt{removeImpossible} = True,
\> \pmt{requireBothUnits} = True,
\> \pmt{requireOverlap} = False (some analyses done with True, these will be \TODO{noted})
\> \pmt{requireAtLeast3PotsInOverlap} = True.
}

In total five iterations were performed. In the first two only the read-out shifts were optimized, then the rotations about $z$ were added. The reason was to remove as many pathological evens as possible before the rotations are optimized. The rotations are sensitive and if used from the very beginning, the convergence might be endangered. Some of the selection cuts were tightened during iterations, see \Tb{al LHC iter par}. \TODO{Justify the values}.
\htab{al LHC iter par}{The iteration-dependent alignment parameters as used in the LHC data analysis. s stands for read-out shifts, r for rotations about $z$.}{\bln
\hbox{iteration}&1 & 2 & 3 & 4 & 5\cr\bln
\hbox{quantities optimized}& \rm s & \rm s & \rm s+r & \rm s+r & \rm s+r \cr
\hbox{\pmt{maxResidualToSigma}}&100 & 10 & 10 & 3 & 3\cr
\hbox{\pmt{chiSqPerNdfCut}}&5000 & 50 & 50 & 5 & 5\cr\bln
}

Indeed, the final constraints were imposed.

\tab{al lhc datasets}{List of data takings \TODO{what data-takings}. The RP position gives an approximate distance of the vertical pot thin windows from the beam, in terms of beam sigmas.}{
\multispan3&\multispan6\bhrulefill\cr
\multispan3&\multispan3\bvrule\strut\hfil\hbox{sector 45}\hfil&\multispan3\vrule\hfil\strut\hbox{sector 56}\hfil\cr
\multispan3&\multispan6\hrulefill\cr
\multispan3&\omit\bvrule\hfil\strut\hbox{events}\hfil & \si(a_x) & \si(a_y) &\hbox{events} & \si(a_x) & \si(a_y)\cr
\multispan3\bhrulefill&&&&&&\cr
\hbox{date} & \hbox{RP position} & \hbox{run numbers} & \times 10^5 & \rm mrad & \rm mrad  & \times 10^5 & \rm mrad & \rm mrad \cr\bln
\hbox{24 Aug}    & 20\,\sigma & 2762,2763,2770,2772 & 7 & 0.3 & 0.3 & 8.4 & 0.3 & 0.3\cr\ln
\hbox{26 Aug}    & 20\,\sigma & 2896,2895,2892,2891 & 2.5 & 0 & 0 & 3.8 & 0 & 0\cr\ln
\hbox{21 Sep}    &  8\,\sigma & 3230,3231 & 0.5 & 0.2 & 0.2 & 0.6 & 0.3 & 0.2\cr\ln
\hbox{28 Sep}    & 18\,\sigma & 3285,3286,3287,3288 & 5 & 0.4 & 0.4 & 6.2 & 0.3 & 0.3\cr\ln
\hbox{05 Oct}    & 18\,\sigma & 3336,3337 & 10.8 & 0.4 & 0.4 & 15.1 & 0.3 & 0.3\cr\ln
\hbox{07 Oct}    & 18\,\sigma & 3359,3360,3361 & 4 & 0.3 & 0.3 & 4.6 & 0.3 & 0.3\cr\ln
\hbox{14 Oct}    & 18\,\sigma & 3457,3459,3460 & 0.8 & 0.4 & 0.4 & 1.1 & 0.3 & 0.3\cr\ln
\hbox{24 Oct}    & 18\,\sigma & 3609 & 6.2 & 0.2 & 0.2 & 6.6 & 0.2 & 0.2\cr\ln
\hbox{26 Oct}    & 18\,\sigma & 3634,3635 & 5.2 & 0.4 & 0.3 & 6.5 & 0.3 & 0.3\cr\ln
\hbox{29-30 Oct} &  7\,\sigma & 3723,3725,3728 & 2.5 & 0.2 & 0.2 & 2.9 & 0.3 & 0.2\cr\bln
}

$U$-$V$ rotation is impossible to determine, not even showing. However, the optical metrology suggests that is rather small, see \Tb{al opt uv rot}.

An attempt to determine the far-near rotations is in \Fg{al comp det per unit weak}. Here all runs are used (even those without horizontal RPs). The standard results (i.e. with final constraints) are taken as the starting point, then 5 iterations made with fixed-detectors constraints (fixed rotation planes: 1200 and 1201). The results are practically identical in the near unit, but incompatible in the far one. Moreover, in the far unit, the results have ''the same shape'' but are ''shifted by a constant''.

\TODO{remove the text below, already done in \Eq{al fit eq eigen one}}
This outcome is quite easy to understand. The alignment equation \Eq{alignment equation} (dropping the constraints for a moment) reads
%$$\bar \mat S \vec\ch = \vec T \equiv \mat S \vec\ch^0 $$
%$$\bar \mat S \vec\ch = \bar\mat S \vec\ch^0 + \underbrace{(\mat S - \bar\mat S) \vec\ch^0}_{\De\vec T}$$
\eqref{\bar \mat S \vec\ch = \bar\mat S \vec\ch^0 + \De\vec T\ ,}{al de T}
where the $\De\vec T$ sums all error contributions. The solution can be symbolically written as
$$\vec\ch = \vec\ch^0 + " {\bar\mat S}^{-1} " \De \vec T$$
This form is quite instructive, although is has very vague mathematical meaning. The message is that for weak modes, with small eigenvalues $\la$, the error contribution
$$\De\vec\ch = \vec\ch - \vec\ch^0 \sim {\De\vec T\over\la}$$
can become big. In our case, the important weak modes are far-near rotations (for $U$ and $V$ detectors separately, see \Tb{al sing mode overview}). Since we constrained the rotations in the near unit, the error would fully manifest in the far one. Looking at the $z$ positions of the RPs (\Tb{rp station}), one can approximate and take one $z$ for the near and one $z$ for the far unit. In this approximation, the error would be constant for every pot (but indeed different for every projection) -- this is exactly the observed effect.

\fig{fig/pdf/al_comp_det_per_unit_weak.pdf}{al comp det per unit weak}{Alignment comparison with fixed-detectors constraints (for rotations: 1200 and 1201). Top row: near unit, bottom row: far unit. October 24 (black), 26 (red), 29-30 (blue).}

As expected, it is not possible to determine the far-near rotations with sufficient precision and therefore we will use the final constraints. Such an example, for 56-220-near unit, is in \Fg{al comp det per unit}. On the first sight, one can see the shift points forming lines. This is exactly what one expects with rotated RPs, see \Sc{al rp fac}. The second interesting outcome is the stability of the results, especially for the shifts. The stability of the shifts means that the RP rotations about $x$ and $y$ do not change in time and the stability of the rotations infers the stability of the rotations about $z$ (see also \Fg{al comp rp all rot}). 


\fig{fig/pdf/al_comp_det_per_unit.pdf}{al comp det per unit}{Alignment comparison with the final constraints for 56-220-near unit. Each point corresponds to a data-taking from \Tb{al lhc datasets}. The dashed lines correspond to the fits \Eq{al rp fit,al rp rotz fit}. The internal shift/rotation is the sensor shift/rotation with respect to the RP shift/rotation.
%overlap=f
}

Let's investigate a bit more the stability of the RP shifts and rotations. Since a comparison for all sensors would require to much space, we decided to compare the RP alignments calculated according to \Eq{al rp fit,al rp rotz fit}. A comparison for unit 56-220-far can be found in \Fg{al comp rp all rot}. For each data-taking there are two points representing two analyses: with \pmt{requireOverlap} = False (circles) and with \pmt{requireOverlap} = True (squares). There were several reasons to do so. First, imagine there were some pathological events biasing the alignment results. Then, splitting the sample into two parts is likely to lead to results incompatible with each other (withing the estimated errors). The overlap requirement provides a subsample selection, moreover the subsample would have a rather different distribution of the rotation $\ga$ factors (see \Tb{alignment quantities}). Hence, this would test also the stability of the rotation determination. Looking at the results, one finds both analyses compatible -- this suggests that the results are robust.

Now, let's return to the RP position stability. Most shift corrections lie in a band of $\pm 10\un{\mu m}$ around the mean (dashed vertical line). This a good result which could have been achieved only thanks to the reliability of the (corrected) LVDT measurements. In fact, the mean values could be used to improve the corrections obtained in \Sc{al collim}. There we determined the corrections for the vertical positions of the vertical pots. Looking at the second row, one finds that track-based alignment brings a modification of $90\un{\mu m}$, which is below the uncertainty of the collimation alignment. Regarding the rotations, the situation is less homogeneous. Some rotations are very stable (all rotations of the horizontal pot), some less ($\rh_z$ of the two vertical pots). For the latter, the fluctuations go up to $\pm 0.4\un{mrad}$ from the mean. This is already an important rotation, which shall not be neglected. A quantitative summary of the rotations can be found in \Tb{al rp rot}. One can see the higher fluctuation of the rotations about $z$ also there.

\fig{fig/pdf/al_comp_rp_all_rot.pdf}{al comp rp all rot}{RP alignment comparison with fixed-detectors constraints. The order of points is the same as in \Tb{al lhc datasets} (top-down in both cases). There are might be two points for each data-set: a circle (all tracks) and a square (overlap tracks only). Showing only 56-220-far unit, in the near one, the $\rh_z$ fluctuations are smaller (see \Fg{al comp det per unit}).}

In fact, such a direct comparison of shifts as in \Fg{al comp rp all rot} is slightly misleading. Every rotation misalignment induces a shift correction, see the $\De\rh \de s_i$ term in \Eq{cnst rotz 6}. This correction is perpendicular to the position of the detector ($\vec c_i$ vector), that's why $\vec d_{\perp_i}$ in the formula. This means that the correction for vertical pots would be horizontal and vertical for horizontal pots. Moreover, the correction is proportional to the distance of the detector from the origin. Hence, this correction would be different for different RP approaches. That is why the comparison for different data-takings is misleading. For the data-takings in \Tb{al lhc datasets}, the thin-window positions varied approximately from $2.6$ to $8\un{mm}$ for the vertical pots and from $2.3$ to $5.6\un{mm}$ for the horizontal pots. The span was, thus, of the order of $\De c \approx 4\un{mm}$. From the \Eq{cnst rotz 6} one could expect the rotation-induced shifts to vary by $\De c \De \rh$. Taking $\De\rh \approx 10 \un{mrad}$ gives us variation by $40\un{\mu m}$. However, in the real case, the variation is much smaller, simulations give the order of $5\un{\mu m}$. There are two reasons for this. First, the final constraints are used, which mix shift and rotation degrees of freedom and make the calculation more complex. And second, the rotations of the top and bottom pots have nearly the same values but opposite signs. This leads to partial cancellations. To summarize, the shifts obtained from different data-takings can be compared within the error of $5\un{\mu m}$.

\htab{al rp rot}{Summary of the RP rotations results (all values in $\rm mrad$). Only analyses with all tracks (\pmt{requireOverlap} = False) have been included, since the other ones have very large errors for the sector 45. Mean is the (weighted) mean which is drawn as the dashed line in \Fg{al comp rp all rot}. $\si$ stands for the standard deviation of the results. 
% weighted mean, non-weighted sigma
}{
\omit&\multispan6\bhrulefill\cr
\omit&\multispan2\bvrule\strut\hfil$\rh_x$\hfil&\multispan2\vrule\strut\hfil$\rh_y$\hfil&\multispan2\vrule\strut\hfil$\rh_z$\hfil\cr
\omit\bhrulefill&\multispan6\hrulefill\cr
\hbox{RP} & \hbox{mean} & \si  & \hbox{mean} & \si  & \hbox{mean} & \si \cr\bln
  20 & -10.8& 0.08 & -4.8 & 0.15 & -4.5 & 0.07\cr\ln
  21 & -6.1 & 0.08 & +5.9 & 0.06 & +6.1 & 0.09\cr\ln
  22 & +1.7 & 0.02 & -1.4 & 0.04 & -1.6 & 0.03\cr\ln
  23 & -1.9 & 0.03 & -9.9 & 0.04 & -2.4 & 0.06\cr\ln
  24 & -7.3 & 0.04 & -0.9 & 0.04 & -2.4 & 0.15\cr\ln
  25 & -9.2 & 0.04 & +4.7 & 0.02 & +4.8 & 0.15\cr\bln
 120 & -7.7 & 0.05 & +2.3 & 0.03 & -3.5 & 0.08\cr\ln
 121 & -7.3 & 0.05 & \phantom{+}0.0 & 0.05 & +5.0 & 0.09\cr\ln
 122 & +1.2 & 0.03 & -5.7 & 0.03 & -1.6 & 0.03\cr\ln
 123 & -0.2 & 0.03 & -3.4 & 0.02 & -2.6 & 0.05\cr\ln
 124 & -3.8 & 0.06 & \phantom{+}0.0 & 0.02 & -4.5 & 0.19\cr\ln
 125 & -4.4 & 0.07 & +2.5 & 0.02 & +7.1 & 0.17\cr\bln
}

\TODO{Generally - want to show that everything is stable and consistent}



\section[al prof]{Profile methods}

\TODO{Comment about beam position}
\> beam position is the theoretical hit position of an elastic proton with $\th = 0$ and the mean vertex position.
\> (in our OfflineSW convention, the beam is at zero)
\> misalignements $\De q$ and RP positions $q^{\rm RP}$ (in accordance with \Eq{misalignment definition})
$$q^{\rm RP}(\hbox{actual/misaligned}) = q^{\rm RP}(\hbox{thought/nominal}) + \De q$$
therefore for hit positions $q$
$$q(\hbox{reconstructed with thought geometry}) = q(\hbox{real}) - \De q$$

Profile methods are those which use symmetries in track and/or angular distributions. The expected symmetries depend on the studied physical processes as well as on the optics. However, the vertical symmetry around the beam can be assumed quite generally. If there was no crossing-angle, the process would have full azimuthal symmetry (about the beam axis). Even if the crossing-angle is non-zero, it is horizontal, thus the up-down symmetry is preserved. On the optics side, most of them are designed with vanishing vertical dispersion $D_y$, therefore the vertical symmetry remains also after the proton transport.

This vertical symmetry can be used even on-line, before data-taking, to symmetrized the position of the vertical RPs around the beam. This would increase the low $|t|$ acceptance.

Profile methods have also offline applications, that is those that can provide alignment corrections for registered data. Let us focus low-$\be$ optics, which was the case for 2010 data-takings. \Fg{al prof simu} shows typical hit distributions (MC simulation) for some important forward-physics processes. Beyond the aforementioned vertical symmetry, one can immediately spot the horizontal symmetry of the green points (elastic scattering). The entire next section will be devoted to the alignment with elastic scattering, but let us comment on how to use this symmetry even without separating a sample of elastic events. The ''hot spot'' close to $x\approx 0$ contains also a contribution from non-elastic processes with low $\xi$ (see for example the red dots -- DPE). Due to the horizontal dispersion, the hits are shifted to the right and the symmetry is broken. This can be well seen \Fg{al prof x dists}: the elastic peak is close to zero, but the non-elastic events form a broad structure shifted towards higher $x$ values. But what is important is that around $x=0$, the distribution is dominated by elastics events and their peak can be well fitted, as illustrated in the figure.

\Fg{al prof simu} shows the distributions as expected from simulations, however, in reality they look quite different, see \Fg{al prof hits}. On the first sight, we one can two major differences.
\bitm
\itm The \em{tilt of the elastic peak} (around the red line). Our current understanding is a XY coupling, \TODO{because of ...}
\itm The unexpected distribution of the diffractive hits (around the blue line, mainly for the sector 56). The distribution is tilted and deformed. The slope of the diffractive hits could be explained by the presence of a vertical dispersion \TODO{... more, comment about the shape}.
\eitm

As a consequence of the elastic peak tilt, the peak in the $x$ distribution widens up, see \Fg{al prof x dists} left, and its center does not correspond to the $x$ position of the beam. To mitigate this problem, one may divide the scatter plot into horizontal slices and build and fit the $x$ distributions for each of them (an example is in \Fg{al prof x dists} right; note the thinner peak). Then, the peak positions then be plotted versus the center of the slice, see an example in \Fg{al prof fits} left. The vertical error bands represent the slice widths, the horizontal are coming from the peak fit uncertainty. The points in green were removed as outliers. The red line represent a common fit through top and bottom pot data and it confirms that the tilt is the same for both RPs. Ideally (were there no errors), the red line would go through the beam position.

In principle, the same slicing method could be applied to the diffractive hits (see \Fg{al prof fits} right), however it is complicated by two facts. First, the profile is non-linear (can be seen by bare eyes in \Fg{al prof hits} right and is manifested by the point fluctuation in \Fg{al prof fits} right). Thus the linear-fit result will be burdened by an important systematic error. Since the diffractive hit distribution is wide and therefore the statistical error of the fit is large as well. This all is made even worse by the second complication: since there is just one horizontal pot, the fit must be extrapolated to the beam position. At the end, the error propagation makes this method uninteresting.

\TODO{broken symmetries - assymetric acceptance, optics deviations, apperture limitations, trigger and detector efficiency bias}

\fig{fig/pdf/al_prof_simu.pdf}{al prof simu}{A Geant4 simulation of hit distributions at the RPs of the 56-220m near unit. The geen points represent elastic scattering (Elegent, PPP3), blue SD (Pythia) and red DPE (Phojet). All processes simulated at $\sqrt s = 3.5\un{GeV}$ and with nominal optics with $\be^* = 2.5\un{m}$. The black solid lines are the contours of the sensors. The dotted lines represent symmetry axes, the middle black dot marks the position of the beam.}

\fig{fig/pdf/al_prof_x_dists.pdf}{al prof x dists}{Horizontal hit distributions in the 56-220-near-top pot (data from 29-30 Oct). Left: all hits, Right: one horizontal slice only. The peak is mostly formed by elastic events, the background is dominated by DPE. The red curve is a Gaussian fit with quadratic background.}

\fig{fig/pdf/al_prof_hits.pdf}{al prof hits}{Typical hit distributions at near stations (scoring planes at $\pm 217\un{m}$). Data from 21 Sep. The far stations look qualitatively the same.
% analysis with vsym2 geometry
}

\fig{fig/pdf/al_prof_fits.pdf}{al prof fits}{The results of the sliced fits for the 56-220-near unit and data from 21 Sep. Left: fit of the elastic peaks, Right: fit of the diffractive hit distribution. The fit lines use the same color code as in \Fg{al prof hits}. The green points excluded from the fit.}

\TODO{With an interesting precision, the alignment can be done in the horizontal direction only.}

Practically, the profile alignment is used as the step prior to the alignment with elastic tracks. It simplifies the selection of the elastic sample, but the precision is superseded in the next step.

\section[al elast]{Elastic Alignment}

\TODO{Certain statements hold only for the low $\be$ optics.}

One first needs to select a sample of elastic events...

The transport of elastic events can be well described as \TODO{reference}:
\eqref{\eqnarray{
q(s) &= L_q(s) \th_q^* + v_q(s) q^*\ ,& \qquad q = x, y\cr
\th_q \equiv {\d q\over\d s} &= L_q'(s) \th_q^* + v_q'(s) q^*\ ,& \qquad L_q' \equiv {\d L_q\over \d s}\cr
}}{el transport}
Moreover, the vertex terms can be neglected \TODO{reference}. In addition, the optics is rather symmetric \TODO{reference}, that is:
\eqref{L_q(s) \approx L_q(-s),\quad L_q'(s) \approx - L_q'(-s)\ .}{al el sym opt}
Furthermore, the optics is such that the phase advance $\ph$ (see Hill's equation \Eq{hill eq}) at the $220\un{m}$ stations is close to $\pi/2$ in $x$ or $0$ in $y$ \TODO{reference}. This means that $L_x(220)$ almost vanishes, but $L_x'(220)$ is large and vice versa for the vertical projection.

The $q(s)$ gives the true hit position (wrt. the beam), however a detector (i.e. a RP) misaligned by $\De q$ would make a measurement $q'$:
\eqref{q' = q - \De q\ .}{al el misal}

Later on, we will use the relation between the angle $\th_q$ and far-near difference $q_F - q_N$:
\eqref{q_F - q_N = \th_q \, d\ ,}{al FN diff}
where $d$ stands for the distance between far and near RPs (see \Tb{rp station}).

The above considerations will help us find the properties useful for both, elastic event selection and alignment.

First of all, the angles left and right should be highly correlated. We recall that left stands for sector 45 and right for sector 56. Given the phase advance conditions make the angular resolution in $x$ much better, thus will focus on the horizontal projection. Using the far-near difference, one finds:
\eqref{\De_{F-N} x^{56} \approx \underbrace{ {L_x^{56'}\over L_x^{45'}} }_{-1 + a} \De_{F-N} x^{45} + 
\underbrace{ {L_x^{56'}\over L_x^{45'}} (\De x_F^{45} - \De x_N^{45}) - (\De x_F^{56} - \De x_N^{56}) }_{b} \ .
}{al el dxdx}
The small slope correction $a$ arises from small asymmetries in the optics, the intercept $b$ is an effect of the RP misalignments. The relation is, indeed, just an approximations -- this will be discussed later -- but let's remark that the elastic events will be distributed along the above line, see \Fg{al el selection} (cut 1).

When the vertex terms in \Eq{el transport} are negligible, there is a high correlation between the hit position and the track angle -- the hits will cumulate along line
\eqref{\De_{F-N} y \approx
\underbrace{ {L_y^{N'}\, d\over L_y^N} }_a y_N 
+ \underbrace{ {L_y^{N'}\, d\over L_y^N} \De y_N - (\De y_F - \De y_N) }_b \ .
}{al el dyy}

In the above relation, we used the vertical projection, since the resolution in $x$ is poor -- $L_x\approx 0$ follows from the phase advance settings. This fact can also be used for elastic event selection. In \Sc{al prof} we saw that the actual optics gave raise to the tilts ($a$) of the elastic peaks, the axes of which can be described as
\eqref{x \approx ay + \underbrace{a \De y - \De x}_{b}\ .}{al el x} 


\tab[\strut\hfil\ #\ \hfil&\ #\ \hfil&\hfil\ #\ \hfil&\hfil\ #\ \hfil\cr]{al el cuts}{The cuts used for elastic event selection. The threshold gives the maximal permitted distance from the line. The right-most column gives the ratio of the threshold to the RMS of the distance-to-line distribution (see the rhs.~plots in \Fg{al el selection}).}{\ln
cut & line & threshold & num.~of sigmas \cr\ln
1 & $\De_{F-N} x^{56} = (-1+a) \De_{F-N} x^{45} + b$	& $80\un{\mu m}$	& $2.5$ \cr
2 & $\De_{F-N} y = a y_N + b$							& $45\un{\mu m}$	& $2.5$ \cr
3 & $x = ay + b$ 										& $400\un{\mu m}$	& $2.5$ \cr\ln
}

The relations \Eq{al el dxdx,al el dyy,al el x} provide the basis for our elastic selection cuts. All of them can be expressed as ''distance from a line must be smaller than a given threshold.'' The details are summarized in \Tb{al el cuts}. The distribution of events around the cut lines has two sources: the beam smearing and the proton transport approximations that we have made. The distributions have a Gaussian shape as can be seen in \Fg{al el selection} and their RMS values were used to set the cut thresholds -- they roughly correspond to $2.5$ multiple of the RMS.

The $a$ and $b$ cut parameters were determined empirically in several iterations. Starting with the values coming from the ideal optics and no misalignments and with liberal cuts. After a selection, the resulting graphs were fitted and improved values of the cut parameters were obtained.

\fig{fig/pdf/al_el_selection.pdf}{al el selection}{Selection of elastic events (data from 21 Sep). Each row corresponds to a cut. Left: the events before (black) and after (colorful) the cut. The red dots belong to 45 bottom -- 56 top diagonal, the blue to the other one. The lightgreen area represents the cut requirement. Right: the distribution of events around the cut line (black) with a Gaussian fit (red). The dotted lines show the cut thresholds, cf. \Tb{al el cuts}.}

Since the relations \Eq{al el dxdx,al el dyy,al el x} involve the misalignment parameters, they can be used for alignment purposes. In the rest of this section we will present a few alignment methods. The first one is dedicated to the horizontal alignment, methods 2a-c are several attempts for the vertical alignment. As we will see later on, the precision of the absolute vertical alignment will to be fully satisfactory. That is why we will mention also methods 3 and 4, which can resolve certain relative components of the vertical alignment.

\em{Method 1}: vertical fit in $y$ vs.~$x$ plots. According to \Eq{al el x}, the horizontal shift $\De x = a \De y - b$. The $a$ and $b$ parameters are the result of the fit and $\De y$ can be determined from methods 2a-c. NB: the influence of $\De y$ is small because of the tilts $a$ are small (see \Tb{al el yx}). If $\De y$ would be of the order of $100\un{\mu m}$ and would completely neglect it, the error of $\De x$ would be of the order of $4\un{\mu m}$.

The fits were performed with the parameterization \Eq{al el x}. To reduce the impact of any possible outliers, every hit was assigned weight (one of the suggested outlier treatments from \bref{millepede})
\eqref{w = \left\lbrace \matrix{
\strut 1				& \de < c_H \cr
\strut c_H^2\over\de^2	& \de > c_H \cr
}\right.\ ,\qquad c_H = 1.345\ .}{al el fit weight}
Here, $\de$ stands for the ratio of the hit distance to the fit line and the RMS of the distance distribution. We made five fit iterations.

The uncertainty of the fit was determined as from the Least-Squares method \TODO{reference}. As the error input, we assigned the RMS of the cut-line distance as the error of $x$ variable.

An illustration of the method is shown in \Fg{al el plots yx}. Similar illustrations will be shown for all other methods. The left plot will always be done for the data from 5~Oct (a $18\si$ run with low statistics), while the right plot from 29-30~Oct (a $7\si$ run with high statistics).

The \Fg{al el plots yx} shows the top and bottom RP fits (red and blue) are compatible with each other and the global one (green). This means that the shifts of the top and bottoms are the same. This confirms that the track-base alignment, the previous step, worked correctly.

The results are summarized in \Tb{al el yx}.

\fig{fig/pdf/al_el_plots_yx.pdf}{al el plots yx}{Illustration of the alignment method 1 (unit 45-220-far). The red line fits the red points only, similarly for the blue one. The green line represents a global fit.}

{\SmallerFonts
\htab{al el yx}{The results of the elastic alignment method 1 -- vertical fits of y vs.~x data. Slope $a$ in $\rm mrad$, intercept $b$ in $\rm\mu m$.}{
\omit&\multispan8\bhrulefill\cr
\omit&\multispan2\strut\bvrule\hfil 45 near\hfil & \multispan2\vrule\hfil 45 far\hfil  & \multispan2\vrule\hfil 56 near\hfil & \multispan2\vrule\hfil 56 far\hfil\cr
\omit&\multispan8\hrulefill\cr
\omit\strut & a & b & a & b & a & b & a & b\cr\bln
\hbox{21 Sep}    & -35.3 \pm    0.8& -33.4 \pm    3.5& -29.8 \pm    0.7& -46.1 \pm    3.2&  43.5 \pm    0.7& -23.1 \pm    3.4&  38.7 \pm    0.7& -26.3 \pm    3.4\cr\ln
\hbox{05 Oct}    & -36.7 \pm    0.5& -42.9 \pm    4.4& -32.4 \pm    0.5& -36.0 \pm    3.9&  44.0 \pm    0.5& -23.6 \pm    4.4&  38.4 \pm    0.5& -24.4 \pm    4.4\cr\ln
\hbox{07 Oct}    & -37.7 \pm    0.4&   1.9 \pm    3.6& -31.3 \pm    0.4& -11.7 \pm    3.2&  42.7 \pm    0.4& -38.1 \pm    3.5&  39.4 \pm    0.4& -27.2 \pm    3.5\cr\ln
\hbox{24 Oct}    & -37.7 \pm    0.2& -46.2 \pm    2.1& -32.2 \pm    0.2& -34.2 \pm    1.8&  43.8 \pm    0.2& -37.6 \pm    2.0&  39.5 \pm    0.2& -14.8 \pm    2.1\cr\ln
\hbox{26 Oct}    & -37.2 \pm    0.2& -24.3 \pm    1.8& -32.4 \pm    0.2& -20.3 \pm    1.6&  43.9 \pm    0.2& -35.2 \pm    1.7&  38.9 \pm    0.2& -67.5 \pm    1.7\cr\ln
\hbox{29-30 Oct} & -36.4 \pm    0.2& -25.5 \pm    0.7& -31.7 \pm    0.2&  -4.0 \pm    0.7&  44.3 \pm    0.1&  -6.5 \pm    0.7&  38.4 \pm    0.1&  -5.7 \pm    0.7\cr\bln
}}



\em{Method 2a}. The vertical distribution of elastic hits shall be symmetric around the position of the beam. This remains true even if the axis of elastic scattering is tilted with respect to $y$ axis. In this case, the $y$ distribution shrinks, but symmetrically around the beam's position. Hence a way to determine the position of the beam is to fit a symmetric function through the data registered by a top and bottom pot of the same unit. Looking at the data in \Fg{al el plots y full}, a Gaussian fit looks as a plausible choice. 

The results are summarized in \Tb{al el y full}. The quoted errors are statistical only. They do not reflect the fact that we fit tails of the distribution only (data from 5 Oct), neither the deviations from Gaussian shape (data from 29-30 Oct). The latter deficiency will lead us to a fit improvement, see method 2b.


\fig{fig/pdf/al_el_plots_y_full.pdf}{al el plots y full}{Illustration of the alignment method 2a (unit 56-220-far). The violet curve shows a Gaussian fit.}

\htab{al el y full}{The results of the elastic alignment method 2a -- Gaussian fits of $y$ distributions. Values in $\rm \mu m$, uncertainties are statistical only.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -54.3 \pm   18.7&  24.5 \pm   21.9& -61.4 \pm   31.3& -26.1 \pm   31.3\cr\ln
\hbox{05 Oct}    &  72.2 \pm   20.5&  93.0 \pm   35.0& -81.8 \pm   39.6&-214.1 \pm   45.6\cr\ln
\hbox{07 Oct}    &  42.6 \pm   16.8&  85.6 \pm   24.0& -48.7 \pm   28.6& -76.6 \pm   30.7\cr\ln
\hbox{24 Oct}    & -88.4 \pm   12.9& -20.4 \pm   15.5&  39.5 \pm   29.2&   8.7 \pm   38.4\cr\ln
\hbox{26 Oct}    &  91.8 \pm    9.9& 160.1 \pm   10.8&-248.2 \pm   22.1&-217.5 \pm   23.8\cr\ln
\hbox{29-30 Oct} &  12.4 \pm   11.0&  99.9 \pm   10.4& -36.7 \pm   13.3& -32.9 \pm   14.1\cr\bln
}



\em{Method 2b}. In the previous method we fitted the $y$ distributions with a Gaussian, without any justification. In fact, one may expect an (approximately) Gaussian shape for for sufficiently small $|y|$. Here is the reason. $y$ is (approximately) proportional to $\th_y$ and that is proportional to $\th_y^*$ and$\th_y^*$ is normally distributed as far as $\d\si/\d t$ falls off exponentially. This is (approximately) true for $|t|$ below the elastic dip. Actually, the ''elastic dip structures'' can be seen in \Fg{al el plots y gauss} right as the bumps on the tails. Hence one should restrain the Gaussian fit to the data below the elastic dip. In terms of $y$, the limit is $\approx 4.2\un{mm}$ (see the dotted lines in the figure).

For the case of 29-30 Oct, the fit quality improved significantly. For 5 Oct there is no fit, since there are no data in the ''Gaussian'' region, the RPs were not close enough. Unfortunately, this is the case for most data-takings. \Tb{al el y gauss} summarizes the results for the two data-takings where we could apply this method.

The results of methods 2a and 2b (\Tb{al el y full,al el y gauss}) compare surprisingly well. The differences fall below the error estimate (with the only exception of the shift of 56-220-far for the data from 29-30 Oct).

\fig{fig/pdf/al_el_plots_y_gauss.pdf}{al el plots y gauss}{Illustration of the alignment method 2b (unit 56-220-far). The violet curve shows a Gaussian fit through the data in the fit region (delimited by the vertical dotted lines). The selected data points are marked in green. There are no data and no fit in the left plot.}

\htab{al el y gauss}{The results of the elastic alignment method 2b -- Gaussian fits of $y$ distributions, low $|y|$ regions only. Values in $\rm \mu m$, uncertainties are statistical only.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -56.3 \pm   10.5&  30.0 \pm   16.3& -62.2 \pm   25.3& -25.0 \pm   30.8\cr\ln
\hbox{29-30 Oct} &   8.6 \pm    7.6&  89.5 \pm    8.5& -18.8 \pm   10.8&  -2.5 \pm   15.0\cr\bln
}

\bmfig
\vbox{\hsize9cm\noindent\leftskip0pt\rightskip0pt\parfillskip0pt plus1fil
\em{Method 2c}. Another approach to mitigate the deficiency of the method 2a is to remove the Gaussian-shape assumption. The only assumption would be that the $y$ distributions measured from the top and bottom pots are parts (cut by acceptance) of the same distribution. One can flip the $y$ distribution from the bottom pot (blue in \Fg{al el shift test}) and shift it such that it matches to the distribution from the top pot (red). When the best match is found, the position of the beam is given
$${f_B + f_T + s\over 2}\ ,$$
where $f_B$ is the position of the highest bottom pot bin, $f_T$ the lowest top pot bin and $s$ the shift of the blue histogram (left edge) wrt. the red one. Indeed, $s$ can only by a multiple of the bin size. The best match is the one which gives the lowest value of
}%
\fig{fig/pdf/al_el_shift_test.pdf}{al el shift test}{[]To the explanation of the shift test}%
\emfig

\eqref{S^2/N = {1\over N} \sum_{i\ \in \hbox{overlapping bins}} \left( C_{\rm red}(i) - C_{\rm blue}(i) \right)^2\ ,}{al el shift test}
where $N$ is the number of overlapping bins and $C_{\rm red}(i)$ represents the contents of the bin $i$ of the red histogram.


As measure of uncertainty, one may take a half of the bin size. Of course, this does not reflect systematic errors that may appear because incompatible distributions from the top and bottom RP. An example of this incompatibility can be seen in \Fg{al el plots y shift} left. For the right plot, it is less pronounced, but still present. The differences in shape may come from different acceptances, trigger, detector and reconstruction efficiencies etc. For a fine alignment one would need to correct for all these effects.

The results are summarized in \Tb{al el y shift}. Comparing these to the method 2a (\Tb{al el y full}), one finds differences with RMS of roughly $30\un{\mu m}$, that is well below the estimated uncertainty.

\fig{fig/pdf/al_el_plots_y_shift.pdf}{al el plots y shift}{Illustration of the alignment method 2c (unit 56-220-far). The $y$ distribution from the bottom pot (blue) has been shifted to match the best to the distribution from the top pot (red).}

\htab{al el y shift}{The results of the elastic alignment method 2c -- shift matching the $y$ distributions from the top and bottom pot. All values in $\rm \mu m$. The ucertainty can be estimated as a half of the bin size. That is $25\un{\mu m}$ for 26 and 29-30 Oct and $50\un{\mu m}$ for the others.}{
\omit&\multispan4\bhrulefill\cr
\omit&\strut\hbox{45 near}&\hbox{45 far}&\hbox{56 near}&\hbox{56 far}\cr\bln
\hbox{21 Sep}    & -50.0&   0.0&-100.0&   0.0\cr\ln
\hbox{05 Oct}    & 150.0& 150.0& -50.0&-200.0\cr\ln
\hbox{07 Oct}    & 100.0& 150.0& -50.0& -50.0\cr\ln
\hbox{24 Oct}    &-100.0&   0.0&  50.0&  50.0\cr\ln
\hbox{26 Oct}    & 100.0& 200.0&-200.0&-200.0\cr\ln
\hbox{29-30 Oct} &   0.0& 100.0& -50.0& -50.0\cr\bln
}


\em{Method 3} is based on \Eq{al el dyy}. The slopes $a$ turn out to be of the order of $20\un{mrad}$ (see \Fg{al el plots dyy}) therefore neglecting the middle term would create an error of $\approx 2\un{\mu m}$, assuming $\De y_n$ is of the order of $100\un{\mu m}$. The $2\un{\mu m}$ are a negligible error compared to the corrections one may get with this method. Thus, we will use
$$b = \De y_F - \De y_N\ .$$
In other words, the intercept gives the relative far-near vertical misalignment.

The fits are performed in a similar manner as in method 1, with the difference that the RMS of distance-to-cut-line distribution is attributed to $\De_{F-N} y$ quantity. An example of the fits is shown if \Fg{al el plots dyy}. Again the one-side fits are compatible with each other and the global fit (with the exception of the red fit in the left-hand side plot). This means that the far-near misalignments are the same for top and bottom pots, a result that is expected after a track-based alignment step.

\Tb{al el dyy} summarizes the results (left part) and provides a comparison to method 2a (right part) -- the $\De y$ results from \Tb{al el y full} were used to predict the intercepts. With the exception of the sector 56 measurement from 5 Oct data, all the differences lie below the estimated error.

\fig{fig/pdf/al_el_plots_dyy.pdf}{al el plots dyy}{Illustration of the alignment method 3 (sector 45). The red line fits the red points only (top pots), blue line blue points (bottom pot). The green line represents a global fit.}

\bgroup
\def\ln{\multispan3\hrulefill&&\multispan2\hrulefill\cr}
\def\bln{\multispan3\bhrulefill&&\multispan2\bhrulefill\cr}
\htab{al el dyy}{Left: the results of the elastic alignment method 3 -- intercepts of $\De_{F-N} y$ vs.~$y$ data fits. Right: a comparison to method 2a (\Tb{al el y full}).}{
\omit&\multispan2\bhrulefill&&\multispan2\bhrulefill\cr
\omit&\strut\hbox{sector 45}&\hbox{sector 56}&&\hbox{sector 45}&\hbox{sector 56}\cr\bln
\hbox{21 Sep}    &  69.3 \pm    0.7&  37.9 \pm    0.7 & \hskip1mm & -10 \pm 29 & -3   \pm 44\cr\ln
\hbox{05 Oct}    &  70.4 \pm    0.8&  12.8 \pm    1.3 & \hskip1mm & 50  \pm 41 & -145 \pm 60\cr\ln
\hbox{07 Oct}    &  72.0 \pm    0.9&   6.0 \pm    1.0 & \hskip1mm & 29  \pm 29 & -34  \pm 42\cr\ln
\hbox{24 Oct}    &  86.8 \pm    0.4&  -1.4 \pm    0.6 & \hskip1mm & 19  \pm 20 & -29  \pm 48\cr\ln
\hbox{26 Oct}    &  79.6 \pm    0.5&  -7.9 \pm    0.6 & \hskip1mm & 11  \pm 15 & 39   \pm 32\cr\ln
\hbox{29-30 Oct} &  79.6 \pm    0.2&  -1.1 \pm    0.2 & \hskip1mm & -8  \pm 15 & 5    \pm 19\cr\bln
}
\egroup



\em{Method 4}. The correlation between $y$ hit positions left and right can be written (follows from \Eq{el transport}):
\eqref{y^{56} =
\underbrace{ {L_y^{56}\over L_y^{45}} }_{-1+a}  y^{45}
+ \underbrace{ {L_y^{56}\over L_y^{45}} \De y^{45} - \De y^{56} }_b
}{al el yy}

\TODO{Method 4 does not compare well to the method 2a, but it is consistent with method 3.}

\fig{fig/pdf/al_el_plots_ylyr.pdf}{al el plots ylyr}{Illustration of the alignment method 4 (far units). The red line fits the red points only (diagonal 45 top -- 56 bottom), blue line blue points (diagonal 45 bottom -- 56 top). The green line represents a global fit. The dark points have been cut off not to bias the fit because of the asymmetric acceptance.}

\bgroup
\def\ln{\multispan3\hrulefill&&\multispan2\hrulefill\cr}
\def\bln{\multispan3\bhrulefill&&\multispan2\bhrulefill\cr}
\htab{al el ylyr}{
Left: the results of the elastic alignment method 4 -- fits of $y^{56}$ vs.~$y^{45}$ data. Right: a comparison to method 2a (\Tb{al el y full}).
}{
\omit&\multispan2\bhrulefill&&\multispan2\bhrulefill\cr
\omit&\strut\hbox{near units}&\hbox{far units}&&\hbox{near units}&\hbox{far units}\cr\bln
\hbox{21 Sep}    & -40.4 \pm   21.3&  78.6 \pm   21.4 & \hskip1mm & 75   \pm 42 & 80   \pm 44\cr\ln
\hbox{05 Oct}    & 170.8 \pm   26.3& 264.5 \pm   28.6 & \hskip1mm & 180  \pm 52 & 386  \pm 64\cr\ln
\hbox{07 Oct}    &  95.4 \pm   20.2& 181.9 \pm   21.8 & \hskip1mm & 102  \pm 39 & 173  \pm 45\cr\ln
\hbox{24 Oct}    & -75.8 \pm   10.7&  15.3 \pm   11.4 & \hskip1mm & -27  \pm 34 & 27   \pm 43\cr\ln
\hbox{26 Oct}    &  19.5 \pm    9.1&  98.6 \pm    9.9 & \hskip1mm & 176  \pm 26 & 156  \pm 28\cr\ln
\hbox{29-30 Oct} &-240.9 \pm    4.9&-158.3 \pm    4.9 & \hskip1mm & -217 \pm 18 & -225 \pm 18\cr\bln
}
\egroup


\TODO{A summary -- how shall the beam position be determined for each data-taking. 21 Sep and 29-30 Oct using 2b, what for the others?}

\iffalse
RP position corrections (only dy vs. y data used)								
	45 near		45 far		56 near		56 far	
	x	y	x	y	x	y	x	y
2010_09_21	-33	0	-48	69	-23	0	-25	38
2010_10_05	-43	0	-38	70	-24	0	-24	13
2010_10_07	2	0	-14	72	-38	0	-27	6
2010_10_24	-46	0	-37	87	-38	0	-15	-1
2010_10_26	-24	0	-23	80	-35	0	-68	-8
2010_10_29-30	-26	0	-7	80	-7	0	-6	-1
								
								
RP position corrections (y distributions data used)								
	45 near		45 far		56 near		56 far	
	x	y	x	y	x	y	x	y
2010_09_21	-31	-54	-47	25	-26	-61	-27	-26
2010_10_05	-46	72	-39	93	-27	-82	-33	-214
2010_10_07	0	43	-14	86	-40	-49	-30	-77
2010_10_24	-43	-88	-34	-20	-36	40	-14	9
2010_10_26	-28	92	-25	160	-46	-248	-76	-218
2010_10_29-30	-26	12	-7	100	-8	-37	-7	-33
\fi


\section[al sum]{Summary}

\> tasks accomplished/non-accomplished
\>> TBA left 4 shift and 4 rotation modes unresolved
\>> Elastic/profile methods fixed the 4 shift modes
\>> From Optical alignment there is no indication of U-V rotation.
\>> Once optics is known better, the far-near rotation could be determined from the shift of the elastic peaks.

\> final uncertainty
\>> internal shifts and rotations
\>> inter-RP shifts and rotations
\>> x al. wrt beam
\>> y al. far-near
\>> y al. absolute wrt beam

\> error impact on the physics reconstruction (of elastic $t$)
\>> errors and unresolved modes
